<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Solana è½¬è´¦</title>
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #333;
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .info-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }
        
        .info-box h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .info-item:last-child {
            margin-bottom: 0;
        }
        
        .info-label {
            color: #666;
            font-weight: 500;
        }
        
        .info-value {
            color: #333;
            font-weight: 600;
        }
        
        .button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }
        
        .button-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .button-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .button-secondary {
            background: #f8f9fa;
            color: #333;
            border: 2px solid #e1e5e9;
        }
        
        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .status {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
            text-align: center;
        }
        
        .status-info {
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #bbdefb;
        }
        
        .status-success {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }
        
        .status-error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .debug-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e1e5e9;
        }
        
        .debug-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            font-family: monospace;
            font-size: 12px;
            color: #666;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="pageTitle">Solana è½¬è´¦</h1>
        </div>
        
        <div id="status" class="status status-info">
            æ­£åœ¨åˆå§‹åŒ–...
        </div>
        
        <div class="info-box">
            <h3>äº¤æ˜“ä¿¡æ¯</h3>
            <div class="info-item">
                <span class="info-label">ä»£å¸:</span>
                <span class="info-value" id="tokenName">åŠ è½½ä¸­...</span>
            </div>
            <div class="info-item">
                <span class="info-label">ç½‘ç»œ:</span>
                <span class="info-value" id="network">åŠ è½½ä¸­...</span>
            </div>
            <div class="info-item">
                <span class="info-label">æœ€å¤§é‡‘é¢:</span>
                <span class="info-value" id="maxAmountInfo">åŠ è½½ä¸­...</span>
            </div>
        </div>
        
        <div class="form-group">
            <label for="fromAddress">å‘é€åœ°å€</label>
            <input type="text" id="fromAddress" readonly placeholder="è¿æ¥é’±åŒ…åæ˜¾ç¤º">
        </div>
        
        <div class="form-group">
            <label for="toAddress">æ¥æ”¶åœ°å€</label>
            <input type="text" id="toAddress" placeholder="è¯·è¾“å…¥æ¥æ”¶æ–¹åœ°å€">
        </div>
        
        <div class="form-group">
            <label for="amount">è½¬è´¦é‡‘é¢</label>
            <input type="number" id="amount" step="0.000001" placeholder="è¯·è¾“å…¥è½¬è´¦é‡‘é¢">
        </div>
        
        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <div>å¤„ç†ä¸­...</div>
        </div>
        
        <button id="connectBtn" class="button button-primary">è¿æ¥ Phantom é’±åŒ…</button>
        <button id="submitBtn" class="button button-primary" disabled>ç¡®è®¤è½¬è´¦</button>
        
        <div class="debug-section">
            <button id="debugBtn" class="button button-secondary">æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯</button>
            <div id="debugInfo" class="debug-info" style="display: none;"></div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let provider = null;
        let connection = null;
        let config = {
            tokenSymbol: 'SOL',
            tokenName: 'Solana',
            contractAddress: '',
            network: 'solana',
            fromAddress: '',
            maxAmount: 0,
            decimals: 9
        };

        // æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status status-${type}`;
            console.log(`[Status] ${message}`);
        }

        // æ˜¾ç¤º/éšè—åŠ è½½çŠ¶æ€
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
            document.getElementById('submitBtn').disabled = show;
        }

        // æ£€æµ‹ iOS WebView ç¯å¢ƒå¹¶åˆ›å»º Phantom æ¡¥æ¥
        function createPhantomBridge() {
            if (!window.solana && window.webkit && window.webkit.messageHandlers) {
                console.log('ğŸ”— æ£€æµ‹åˆ° iOS WebView ç¯å¢ƒï¼Œåˆ›å»º Phantom æ¡¥æ¥');
                
                // åˆ›å»ºæ¨¡æ‹Ÿçš„ Phantom é’±åŒ…å¯¹è±¡
                window.solana = {
                    isPhantom: true,
                    name: 'Phantom',
                    version: '1.0.0',
                    isConnected: false,
                    publicKey: null,
                    
                    // è¿æ¥æ–¹æ³• - é€šè¿‡ iOS æ¡¥æ¥
                    connect: function(options = {}) {
                        return new Promise((resolve, reject) => {
                            console.log('ğŸ”— é€šè¿‡ iOS æ¡¥æ¥è¯·æ±‚è¿æ¥ Phantom');
                            
                            // è®¾ç½®è¶…æ—¶
                            const timeout = setTimeout(() => {
                                reject(new Error('è¿æ¥è¶…æ—¶'));
                            }, 30000);
                            
                            // å­˜å‚¨ Promise å›è°ƒ
                            window.phantomConnectResolve = resolve;
                            window.phantomConnectReject = reject;
                            window.phantomConnectTimeout = timeout;
                            
                            // å‘é€è¿æ¥è¯·æ±‚åˆ° iOS
                            if (window.webkit.messageHandlers.phantomCallback) {
                                window.webkit.messageHandlers.phantomCallback.postMessage({
                                    type: 'connect_request',
                                    options: options
                                });
                            } else {
                                reject(new Error('iOS æ¡¥æ¥ä¸å¯ç”¨'));
                            }
                        });
                    },
                    
                    // æ–­å¼€è¿æ¥
                    disconnect: function() {
                        this.isConnected = false;
                        this.publicKey = null;
                        console.log('ğŸ”Œ Phantom é’±åŒ…å·²æ–­å¼€');
                        
                        // é€šçŸ¥ iOS
                        if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.phantomCallback) {
                            window.webkit.messageHandlers.phantomCallback.postMessage({
                                type: 'disconnect'
                            });
                        }
                    },
                    
                    // ç­¾åäº¤æ˜“
                    signTransaction: function(transaction) {
                        return new Promise((resolve, reject) => {
                            console.log('âœï¸ é€šè¿‡ iOS æ¡¥æ¥è¯·æ±‚ç­¾åäº¤æ˜“');
                            
                            // è®¾ç½®è¶…æ—¶
                            const timeout = setTimeout(() => {
                                reject(new Error('ç­¾åè¶…æ—¶'));
                            }, 60000);
                            
                            // å­˜å‚¨ Promise å›è°ƒ
                            window.phantomSignResolve = resolve;
                            window.phantomSignReject = reject;
                            window.phantomSignTimeout = timeout;
                            
                            // åºåˆ—åŒ–äº¤æ˜“
                            const serializedTx = transaction.serialize({
                                requireAllSignatures: false,
                                verifySignatures: false
                            });
                            
                            // å‘é€ç­¾åè¯·æ±‚åˆ° iOS
                            if (window.webkit.messageHandlers.phantomCallback) {
                                window.webkit.messageHandlers.phantomCallback.postMessage({
                                    type: 'sign_transaction',
                                    transaction: Array.from(serializedTx),
                                    fromAddress: config.fromAddress,
                                    toAddress: document.getElementById('toAddress').value,
                                    amount: parseFloat(document.getElementById('amount').value),
                                    tokenSymbol: config.tokenSymbol,
                                    contractAddress: config.contractAddress
                                });
                            } else {
                                reject(new Error('iOS æ¡¥æ¥ä¸å¯ç”¨'));
                            }
                        });
                    }
                };
                
                console.log('âœ… Phantom æ¡¥æ¥å¯¹è±¡å·²åˆ›å»º');
                return true;
            }
            return false;
        }

        // iOS å›è°ƒå¤„ç†å‡½æ•°
        window.handlePhantomResponse = function(response) {
            console.log('ğŸ“± æ”¶åˆ° iOS Phantom å“åº”:', response);
            
            if (response.type === 'connect_success') {
                // è¿æ¥æˆåŠŸ
                if (window.phantomConnectResolve) {
                    clearTimeout(window.phantomConnectTimeout);
                    
                    const publicKey = {
                        toString: () => response.publicKey,
                        toBase58: () => response.publicKey
                    };
                    
                    window.solana.isConnected = true;
                    window.solana.publicKey = publicKey;
                    
                    window.phantomConnectResolve({ publicKey });
                    
                    // æ¸…ç†å›è°ƒ
                    delete window.phantomConnectResolve;
                    delete window.phantomConnectReject;
                    delete window.phantomConnectTimeout;
                }
            } else if (response.type === 'connect_error') {
                // è¿æ¥å¤±è´¥
                if (window.phantomConnectReject) {
                    clearTimeout(window.phantomConnectTimeout);
                    window.phantomConnectReject(new Error(response.message || 'è¿æ¥å¤±è´¥'));
                    
                    // æ¸…ç†å›è°ƒ
                    delete window.phantomConnectResolve;
                    delete window.phantomConnectReject;
                    delete window.phantomConnectTimeout;
                }
            } else if (response.type === 'sign_success') {
                // ç­¾åæˆåŠŸ
                if (window.phantomSignResolve) {
                    clearTimeout(window.phantomSignTimeout);
                    
                    // åˆ›å»ºç­¾ååçš„äº¤æ˜“å¯¹è±¡
                    const signedTxData = new Uint8Array(response.signedTransaction);
                    const signedTransaction = solanaWeb3.Transaction.from(signedTxData);
                    
                    window.phantomSignResolve(signedTransaction);
                    
                    // æ¸…ç†å›è°ƒ
                    delete window.phantomSignResolve;
                    delete window.phantomSignReject;
                    delete window.phantomSignTimeout;
                }
            } else if (response.type === 'sign_error') {
                // ç­¾åå¤±è´¥
                if (window.phantomSignReject) {
                    clearTimeout(window.phantomSignTimeout);
                    window.phantomSignReject(new Error(response.message || 'ç­¾åå¤±è´¥'));
                    
                    // æ¸…ç†å›è°ƒ
                    delete window.phantomSignResolve;
                    delete window.phantomSignReject;
                    delete window.phantomSignTimeout;
                }
            } else if (response.type === 'transaction_success') {
                // äº¤æ˜“æˆåŠŸ
                showStatus(`äº¤æ˜“æˆåŠŸï¼ç­¾å: ${response.signature}`, 'success');
                
                // é€šçŸ¥ iOS
                if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.phantomCallback) {
                    window.webkit.messageHandlers.phantomCallback.postMessage({
                        type: 'transaction_completed',
                        signature: response.signature,
                        success: true
                    });
                }
            } else if (response.type === 'transaction_error') {
                // äº¤æ˜“å¤±è´¥
                showStatus(`äº¤æ˜“å¤±è´¥: ${response.message}`, 'error');
                
                // é€šçŸ¥ iOS
                if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.phantomCallback) {
                    window.webkit.messageHandlers.phantomCallback.postMessage({
                        type: 'transaction_completed',
                        error: response.message,
                        success: false
                    });
                }
            }
        };

        // æ£€æµ‹ Phantom é’±åŒ…
        function detectPhantom() {
            return new Promise((resolve) => {
                console.log('ğŸ” å¼€å§‹æ£€æµ‹ Phantom é’±åŒ…...');
                
                // é¦–å…ˆå°è¯•åˆ›å»ºæ¡¥æ¥
                const bridgeCreated = createPhantomBridge();
                
                if (bridgeCreated) {
                    console.log('âœ… iOS WebView ç¯å¢ƒä¸‹åˆ›å»ºäº† Phantom æ¡¥æ¥');
                    resolve(true);
                    return;
                }
                
                // åŸæœ‰çš„æ£€æµ‹é€»è¾‘
                if (window.solana && window.solana.isPhantom) {
                    console.log('âœ… æ£€æµ‹åˆ° Phantom é’±åŒ…');
                    resolve(true);
                    return;
                }

                // æ£€æµ‹å…¶ä»–å¯èƒ½çš„ solana å¯¹è±¡
                if (window.solana && typeof window.solana.connect === 'function') {
                    console.log('âœ… æ£€æµ‹åˆ° Solana é’±åŒ…å¯¹è±¡');
                    resolve(true);
                    return;
                }

                // æ£€æµ‹ window.phantom.solana
                if (window.phantom && window.phantom.solana) {
                    console.log('âœ… é€šè¿‡ window.phantom.solana æ£€æµ‹åˆ°é’±åŒ…');
                    window.solana = window.phantom.solana;
                    resolve(true);
                    return;
                }

                // è½®è¯¢æ£€æµ‹
                let attempts = 0;
                const maxAttempts = 50;
                
                console.log('ğŸ”„ å¼€å§‹è½®è¯¢æ£€æµ‹ï¼Œæœ€å¤šç­‰å¾…5ç§’...');
                
                const checkInterval = setInterval(() => {
                    attempts++;
                    
                    if (window.solana && window.solana.isPhantom) {
                        console.log('âœ… è½®è¯¢æ£€æµ‹åˆ° Phantom é’±åŒ…');
                        clearInterval(checkInterval);
                        resolve(true);
                        return;
                    }
                    
                    if (window.phantom && window.phantom.solana) {
                        console.log('âœ… è½®è¯¢æ£€æµ‹åˆ° window.phantom.solana');
                        window.solana = window.phantom.solana;
                        clearInterval(checkInterval);
                        resolve(true);
                        return;
                    }
                    
                    if (attempts >= maxAttempts) {
                        console.log('âŒ è½®è¯¢æ£€æµ‹è¶…æ—¶ (5ç§’)');
                        clearInterval(checkInterval);
                        resolve(false);
                    }
                }, 100);
            });
        }

        // è¿æ¥ Phantom é’±åŒ…
        async function connectPhantom() {
            try {
                showLoading(true);
                showStatus('æ­£åœ¨æ£€æµ‹ Phantom é’±åŒ…...', 'info');

                // ç­‰å¾…é’±åŒ…æ£€æµ‹å®Œæˆ
                const isPhantomAvailable = await detectPhantom();
                
                if (!isPhantomAvailable) {
                    throw new Error('Phantom é’±åŒ…æœªæ£€æµ‹åˆ°ã€‚è¯·ç¡®ä¿å·²å®‰è£… Phantom é’±åŒ…åº”ç”¨å¹¶å·²åˆ›å»ºé’±åŒ…ã€‚');
                }

                showStatus('æ­£åœ¨è¿æ¥ Phantom é’±åŒ…...', 'info');

                // è·å– provider
                provider = window.solana;
                
                // å°è¯•è¿æ¥é’±åŒ…
                const response = await provider.connect({ onlyIfTrusted: false });
                
                if (!response || !response.publicKey) {
                    throw new Error('è¿æ¥å¤±è´¥ï¼Œæœªè·å–åˆ°é’±åŒ…åœ°å€');
                }
                
                const publicKey = response.publicKey.toString();
                console.log('âœ… æˆåŠŸè¿æ¥åˆ° Phantom é’±åŒ…:', publicKey);
                
                // è®¾ç½® Solana è¿æ¥ - ä½¿ç”¨æ›´å¯é çš„RPCç«¯ç‚¹
                const rpcEndpoints = [
                    'https://api.mainnet-beta.solana.com',
                    'https://solana-rpc.publicnode.com',
                    'https://go.getblock.io/4136d34f90a6488b84214ae26f0ed5f4',
                    'https://solana.drpc.org'
                ];
                
                // å°è¯•è¿æ¥åˆ°ç¬¬ä¸€ä¸ªå¯ç”¨çš„RPCç«¯ç‚¹
                let connectionEstablished = false;
                for (let i = 0; i < rpcEndpoints.length; i++) {
                    try {
                        console.log(`ğŸ”— å°è¯•è¿æ¥RPCç«¯ç‚¹ [${i+1}/${rpcEndpoints.length}]: ${rpcEndpoints[i]}`);
                        connection = new solanaWeb3.Connection(rpcEndpoints[i], 'confirmed');
                        
                        // æµ‹è¯•è¿æ¥
                        await connection.getSlot();
                        console.log(`âœ… æˆåŠŸè¿æ¥åˆ°RPCç«¯ç‚¹: ${rpcEndpoints[i]}`);
                        connectionEstablished = true;
                        break;
                    } catch (rpcError) {
                        console.warn(`âš ï¸ RPCç«¯ç‚¹è¿æ¥å¤±è´¥: ${rpcEndpoints[i]} - ${rpcError.message}`);
                        if (i === rpcEndpoints.length - 1) {
                            throw new Error('æ‰€æœ‰RPCç«¯ç‚¹å‡è¿æ¥å¤±è´¥');
                        }
                    }
                }
                
                if (!connectionEstablished) {
                    throw new Error('æ— æ³•å»ºç«‹Solanaç½‘ç»œè¿æ¥');
                }

                // æ›´æ–°é…ç½®å’ŒUI
                config.fromAddress = publicKey;
                document.getElementById('fromAddress').value = publicKey;
                document.getElementById('connectBtn').textContent = 'âœ… é’±åŒ…å·²è¿æ¥';
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('submitBtn').disabled = false;
                
                showStatus('é’±åŒ…è¿æ¥æˆåŠŸï¼', 'success');
                
                // è·å–çœŸå®ä½™é¢
                await updateBalance();
                
            } catch (error) {
                console.error('è¿æ¥å¤±è´¥:', error);
                
                let errorMessage = error.message;
                if (error.code === 4001) {
                    errorMessage = 'ç”¨æˆ·æ‹’ç»è¿æ¥é’±åŒ…';
                } else if (error.code === -32603) {
                    errorMessage = 'é’±åŒ…è¿æ¥å¤±è´¥ï¼Œè¯·é‡è¯•';
                } else if (error.message.includes('User rejected')) {
                    errorMessage = 'ç”¨æˆ·å–æ¶ˆäº†è¿æ¥è¯·æ±‚';
                }
                
                showStatus(`è¿æ¥å¤±è´¥: ${errorMessage}`, 'error');
                
                // é‡ç½®è¿æ¥æŒ‰é’®
                document.getElementById('connectBtn').textContent = 'é‡æ–°è¿æ¥ Phantom é’±åŒ…';
                document.getElementById('connectBtn').disabled = false;
            } finally {
                showLoading(false);
            }
        }

        // æ›´æ–°ä½™é¢æ˜¾ç¤º
        async function updateBalance() {
            try {
                if (!connection || !provider.publicKey) return;

                const publicKey = provider.publicKey;
                let balance = 0;

                if (!config.contractAddress || config.tokenSymbol === 'SOL') {
                    // SOL ä½™é¢
                    const lamports = await connection.getBalance(publicKey);
                    balance = lamports / solanaWeb3.LAMPORTS_PER_SOL;
                } else {
                    // SPL ä»£å¸ä½™é¢
                    const tokenAccounts = await connection.getTokenAccountsByOwner(publicKey, {
                        mint: new solanaWeb3.PublicKey(config.contractAddress)
                    });

                    if (tokenAccounts.value.length > 0) {
                        const accountInfo = await connection.getTokenAccountBalance(
                            tokenAccounts.value[0].pubkey
                        );
                        balance = parseFloat(accountInfo.value.uiAmountString || '0');
                    }
                }

                config.maxAmount = balance;
                document.getElementById('maxAmountInfo').textContent = 
                    `æœ€å¤§å¯æå¸æ•°é‡ï¼š${balance} ${config.tokenSymbol}`;
                    
            } catch (error) {
                console.error('è·å–ä½™é¢å¤±è´¥:', error);
                showStatus('è·å–ä½™é¢å¤±è´¥', 'error');
            }
        }

        // éªŒè¯åœ°å€æ ¼å¼
        function isValidSolanaAddress(address) {
            try {
                new solanaWeb3.PublicKey(address);
                return true;
            } catch {
                return false;
            }
        }

        // æ‰§è¡Œäº¤æ˜“
        async function executeTransaction() {
            try {
                showLoading(true);
                showStatus('æ­£åœ¨åˆ›å»ºäº¤æ˜“...', 'info');

                // éªŒè¯è¾“å…¥
                const toAddress = document.getElementById('toAddress').value.trim();
                const amount = parseFloat(document.getElementById('amount').value);

                if (!toAddress) {
                    throw new Error('è¯·è¾“å…¥æ¥æ”¶æ–¹åœ°å€');
                }

                if (!isValidSolanaAddress(toAddress)) {
                    throw new Error('æ¥æ”¶æ–¹åœ°å€æ ¼å¼æ— æ•ˆ');
                }

                if (isNaN(amount) || amount <= 0) {
                    throw new Error('è¯·è¾“å…¥æœ‰æ•ˆçš„è½¬è´¦é‡‘é¢');
                }

                if (amount > config.maxAmount) {
                    throw new Error(`è½¬è´¦é‡‘é¢ä¸èƒ½è¶…è¿‡ ${config.maxAmount} ${config.tokenSymbol}`);
                }

                // é€šè¿‡ iOS æ¡¥æ¥å¤„ç†äº¤æ˜“
                showStatus('è¯·åœ¨ Phantom é’±åŒ…ä¸­ç¡®è®¤äº¤æ˜“...', 'info');
                
                // åˆ›å»ºä¸€ä¸ªç®€å•çš„äº¤æ˜“å¯¹è±¡ç”¨äºç­¾å
                const fromPubkey = provider.publicKey;
                const toPubkey = new solanaWeb3.PublicKey(toAddress);
                
                const transaction = new solanaWeb3.Transaction();
                
                if (!config.contractAddress || config.tokenSymbol === 'SOL') {
                    // SOL è½¬è´¦
                    const lamports = Math.floor(amount * solanaWeb3.LAMPORTS_PER_SOL);
                    transaction.add(
                        solanaWeb3.SystemProgram.transfer({
                            fromPubkey: fromPubkey,
                            toPubkey: toPubkey,
                            lamports: lamports
                        })
                    );
                } else {
                    // SPL ä»£å¸è½¬è´¦ (ç®€åŒ–ç‰ˆæœ¬)
                    throw new Error('SPL ä»£å¸è½¬è´¦æš‚ä¸æ”¯æŒ');
                }

                // è®¾ç½®äº¤æ˜“å±æ€§ - ä½¿ç”¨æ•…éšœåˆ‡æ¢æœºåˆ¶è·å–blockhash
                let blockhash;
                const rpcEndpoints = [
                    'https://api.mainnet-beta.solana.com',
                    'https://solana-rpc.publicnode.com',
                    'https://go.getblock.io/4136d34f90a6488b84214ae26f0ed5f4',
                    'https://solana.drpc.org'
                ];
                
                for (let i = 0; i < rpcEndpoints.length; i++) {
                    try {
                        console.log(`ğŸ”— å°è¯•è·å–blockhash [${i+1}/${rpcEndpoints.length}]: ${rpcEndpoints[i]}`);
                        const tempConnection = new solanaWeb3.Connection(rpcEndpoints[i], 'confirmed');
                        const result = await tempConnection.getLatestBlockhash('confirmed');
                        blockhash = result.blockhash;
                        console.log(`âœ… æˆåŠŸè·å–blockhash: ${rpcEndpoints[i]}`);
                        
                        // æ›´æ–°ä¸»è¿æ¥ä¸ºæˆåŠŸçš„ç«¯ç‚¹
                        connection = tempConnection;
                        break;
                    } catch (rpcError) {
                        console.warn(`âš ï¸ è·å–blockhashå¤±è´¥: ${rpcEndpoints[i]} - ${rpcError.message}`);
                        if (i === rpcEndpoints.length - 1) {
                            throw new Error('æ‰€æœ‰RPCç«¯ç‚¹å‡æ— æ³•è·å–blockhash: ' + rpcError.message);
                        }
                    }
                }
                
                transaction.recentBlockhash = blockhash;
                transaction.feePayer = fromPubkey;

                // ç­¾åäº¤æ˜“
                const signedTransaction = await provider.signTransaction(transaction);
                
                showStatus('æ­£åœ¨å‘é€äº¤æ˜“åˆ°ç½‘ç»œ...', 'info');

                // å‘é€äº¤æ˜“ - ä½¿ç”¨æ•…éšœåˆ‡æ¢æœºåˆ¶
                let signature;
                for (let i = 0; i < rpcEndpoints.length; i++) {
                    try {
                        console.log(`ğŸš€ å°è¯•å‘é€äº¤æ˜“ [${i+1}/${rpcEndpoints.length}]: ${rpcEndpoints[i]}`);
                        const tempConnection = new solanaWeb3.Connection(rpcEndpoints[i], 'confirmed');
                        signature = await tempConnection.sendRawTransaction(
                            signedTransaction.serialize(),
                            {
                                skipPreflight: false,
                                preflightCommitment: 'confirmed'
                            }
                        );
                        console.log(`âœ… äº¤æ˜“å‘é€æˆåŠŸ: ${rpcEndpoints[i]} - ç­¾å: ${signature}`);
                        
                        // æ›´æ–°ä¸»è¿æ¥ä¸ºæˆåŠŸçš„ç«¯ç‚¹
                        connection = tempConnection;
                        break;
                    } catch (sendError) {
                        console.warn(`âš ï¸ å‘é€äº¤æ˜“å¤±è´¥: ${rpcEndpoints[i]} - ${sendError.message}`);
                        if (i === rpcEndpoints.length - 1) {
                            throw new Error('æ‰€æœ‰RPCç«¯ç‚¹å‡æ— æ³•å‘é€äº¤æ˜“: ' + sendError.message);
                        }
                    }
                }

                showStatus('æ­£åœ¨ç¡®è®¤äº¤æ˜“...', 'info');

                // ç­‰å¾…ç¡®è®¤
                const confirmation = await connection.confirmTransaction(signature, 'confirmed');

                if (confirmation.value.err) {
                    throw new Error('äº¤æ˜“æ‰§è¡Œå¤±è´¥');
                }

                showStatus(`äº¤æ˜“æˆåŠŸï¼ç­¾å: ${signature}`, 'success');
                
                // é€šçŸ¥ iOS
                if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.phantomCallback) {
                    window.webkit.messageHandlers.phantomCallback.postMessage({
                        type: 'transaction_success',
                        signature: signature,
                        fromAddress: config.fromAddress,
                        toAddress: toAddress,
                        amount: amount,
                        tokenSymbol: config.tokenSymbol
                    });
                }

                // æ›´æ–°ä½™é¢
                setTimeout(updateBalance, 2000);
                
            } catch (error) {
                console.error('äº¤æ˜“å¤±è´¥:', error);
                
                let errorMessage = error.message;
                if (error.code === 4001) {
                    errorMessage = 'ç”¨æˆ·æ‹’ç»ç­¾åäº¤æ˜“';
                } else if (error.message.includes('User rejected')) {
                    errorMessage = 'ç”¨æˆ·å–æ¶ˆäº†äº¤æ˜“';
                }
                
                showStatus(`äº¤æ˜“å¤±è´¥: ${errorMessage}`, 'error');
                
                // é€šçŸ¥ iOS
                if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.phantomCallback) {
                    window.webkit.messageHandlers.phantomCallback.postMessage({
                        type: 'transaction_error',
                        error: errorMessage,
                        fromAddress: config.fromAddress,
                        toAddress: document.getElementById('toAddress').value,
                        amount: parseFloat(document.getElementById('amount').value),
                        tokenSymbol: config.tokenSymbol
                    });
                }
                
            } finally {
                showLoading(false);
            }
        }

        // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
        function debugWalletDetection() {
            const debugInfo = document.getElementById('debugInfo');
            const isVisible = debugInfo.style.display !== 'none';
            
            if (isVisible) {
                debugInfo.style.display = 'none';
                document.getElementById('debugBtn').textContent = 'æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯';
                return;
            }
            
            let info = `è°ƒè¯•ä¿¡æ¯ (${new Date().toLocaleTimeString()}):\n\n`;
            
            info += `ç”¨æˆ·ä»£ç†: ${navigator.userAgent}\n\n`;
            
            info += `window.solana å­˜åœ¨: ${window.solana ? 'âœ… æ˜¯' : 'âŒ å¦'}\n`;
            if (window.solana) {
                info += `  - isPhantom: ${window.solana.isPhantom}\n`;
                info += `  - isConnected: ${window.solana.isConnected}\n`;
                info += `  - publicKey: ${window.solana.publicKey ? window.solana.publicKey.toString() : 'null'}\n`;
            }
            
            info += `\nå…¶ä»–é’±åŒ…æ£€æµ‹:\n`;
            info += `window.ethereum: ${window.ethereum ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}\n`;
            info += `window.phantom: ${window.phantom ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}\n`;
            
            info += `\né¡µé¢ç¯å¢ƒ:\n`;
            info += `åè®®: ${location.protocol}\n`;
            info += `åŸŸå: ${location.hostname}\n`;
            info += `ç«¯å£: ${location.port || 'é»˜è®¤'}\n`;
            info += `å®Œæ•´URL: ${location.href}\n`;
            
            info += `\nSolana Web3.js:\n`;
            info += `solanaWeb3 å¯¹è±¡: ${typeof solanaWeb3 !== 'undefined' ? 'âœ… å·²åŠ è½½' : 'âŒ æœªåŠ è½½'}\n`;
            if (typeof solanaWeb3 !== 'undefined') {
                info += `Connection ç±»: ${solanaWeb3.Connection ? 'âœ… å¯ç”¨' : 'âŒ ä¸å¯ç”¨'}\n`;
                info += `PublicKey ç±»: ${solanaWeb3.PublicKey ? 'âœ… å¯ç”¨' : 'âŒ ä¸å¯ç”¨'}\n`;
            }
            
            info += `\niOS WebView æ¡¥æ¥:\n`;
            info += `webkit å¯¹è±¡: ${window.webkit ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}\n`;
            if (window.webkit && window.webkit.messageHandlers) {
                info += `messageHandlers: âœ… å­˜åœ¨\n`;
                info += `phantomCallback: ${window.webkit.messageHandlers.phantomCallback ? 'âœ… å·²æ³¨å†Œ' : 'âŒ æœªæ³¨å†Œ'}\n`;
            }
            
            debugInfo.textContent = info;
            debugInfo.style.display = 'block';
            document.getElementById('debugBtn').textContent = 'éšè—è°ƒè¯•ä¿¡æ¯';
        }

        // ä»iOSæ¥æ”¶é…ç½®å¹¶æ›´æ–°é¡µé¢
        window.setTransactionConfig = function(jsonString) {
            try {
                const data = JSON.parse(jsonString);
                console.log('ğŸ“± æ”¶åˆ°iOSé…ç½®å‚æ•°:', data);
                
                // åˆå¹¶é…ç½®
                config = { ...config, ...data };
                
                // æ›´æ–°é¡µé¢æ ‡é¢˜
                document.getElementById('pageTitle').textContent = 
                    `${config.tokenName || config.tokenSymbol || 'Solana'} è½¬è´¦`;
                
                // æ›´æ–°UIè¡¨å•
                document.getElementById('tokenName').textContent = config.tokenName || config.tokenSymbol || 'Solana';
                document.getElementById('network').textContent = config.network || 'Solana';
                document.getElementById('fromAddress').value = config.fromAddress || '';
                
                // æ›´æ–°æœ€å¤§å¯æå¸æ•°é‡æ˜¾ç¤º
                document.getElementById('maxAmountInfo').textContent = 
                    `æœ€å¤§å¯æå¸æ•°é‡ï¼š${config.maxAmount || 0} ${config.tokenSymbol || 'SOL'}`;
                
                // æ›´æ–°é‡‘é¢è¾“å…¥æ¡†çš„æœ€å¤§å€¼
                const amountInput = document.getElementById('amount');
                if (config.maxAmount > 0) {
                    amountInput.max = config.maxAmount;
                    amountInput.placeholder = `è¯·è¾“å…¥é‡‘é¢ (æœ€å¤§: ${config.maxAmount})`;
                } else {
                    amountInput.placeholder = `è¯·è¾“å…¥é‡‘é¢`;
                }
                
                showStatus('é…ç½®åŠ è½½å®Œæˆï¼Œè¯·è¿æ¥é’±åŒ…', 'success');
                
                console.log('âœ… [Config] äº¤æ˜“é…ç½®æ›´æ–°å®Œæˆ:', config);
                
            } catch (error) {
                console.error('âŒ [Config] é…ç½®è§£æå¤±è´¥:', error);
                showStatus('é…ç½®åŠ è½½å¤±è´¥: ' + error.message, 'error');
            }
        };

        // äº‹ä»¶ç›‘å¬å™¨
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸ“± é¡µé¢åŠ è½½å®Œæˆ');
            
            // ç»‘å®šäº‹ä»¶
            document.getElementById('connectBtn').addEventListener('click', connectPhantom);
            document.getElementById('submitBtn').addEventListener('click', executeTransaction);
            document.getElementById('debugBtn').addEventListener('click', debugWalletDetection);
            
            // æ£€æµ‹é’±åŒ…
            showStatus('æ­£åœ¨æ£€æµ‹é’±åŒ…ç¯å¢ƒ...', 'info');
            
            const detected = await detectPhantom();
            if (detected) {
                showStatus('é’±åŒ…ç¯å¢ƒæ£€æµ‹æˆåŠŸï¼Œè¯·ç‚¹å‡»è¿æ¥', 'success');
            } else {
                showStatus('æœªæ£€æµ‹åˆ°é’±åŒ…ï¼Œè¯·ç¡®ä¿å·²å®‰è£… Phantom', 'error');
            }
        });

        // å…¼å®¹æ€§åˆ«å
        window.setConfig = window.setTransactionConfig;
    </script>
</body>
</html>
