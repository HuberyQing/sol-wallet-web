<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>Solanaä»£å¸æå–</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            min-height: 100vh;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        h2 {
            text-align: center;
            color: #333;
            margin-bottom: 24px;
            font-size: 24px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            font-size: 14px;
        }
        
        input, select, button, textarea {
            width: 100%;
            padding: 12px 16px;
            font-size: 16px;
            border: 2px solid #e1e1e1;
            border-radius: 8px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        
        input:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        input:disabled {
            background-color: #f8f9fa;
            color: #666;
        }
        
        .warning {
            color: #e74c3c;
            font-size: 12px;
            margin-top: 4px;
            line-height: 1.4;
        }
        
        .info {
            color: #3498db;
            font-size: 12px;
            margin-top: 4px;
        }
        
        .submit-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, opacity 0.2s;
        }
        
        .submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
        }
        
        .submit-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }
        
        .connect-btn {
            background: #9945FF;
            color: white;
            border: none;
            font-weight: 600;
            margin-bottom: 20px;
        }
        
        .status {
            text-align: center;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }
        
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <script src="solana-web3.min.js"></script>
</head>
<body>
    <div class="container">
        <h2 id="pageTitle">ğŸ’° ä»£å¸æå–</h2>
        
        <div id="status" class="status" style="display: none;"></div>
        
        <button id="connectBtn" class="connect-btn">è¿æ¥ Phantom é’±åŒ…</button>
        
        <button id="retryBtn" class="connect-btn" style="background: #28a745; margin-bottom: 10px; display: none;">ğŸ”„ é‡æ–°æ£€æµ‹é’±åŒ…</button>
        
        <button id="debugBtn" class="connect-btn" style="background: #ff8c00; margin-bottom: 10px;">ğŸ” æ£€æµ‹é’±åŒ…çŠ¶æ€</button>
        
        <div id="debugInfo" style="display: none; background: #f0f0f0; padding: 12px; border-radius: 8px; margin-bottom: 20px; font-size: 12px; font-family: monospace;">
            <strong>è°ƒè¯•ä¿¡æ¯:</strong><br>
            <div id="debugContent"></div>
        </div>
        
        <div class="form-group">
            <label>å……å€¼å¸ç§</label>
            <input id="tokenSymbol" type="text" disabled placeholder="åŠ è½½ä¸­...">
        </div>
        
        <div class="form-group">
            <label>æå–ç½‘ç»œ</label>
            <input id="network" type="text" disabled placeholder="Solana">
        </div>
        
        <div class="form-group">
            <label>å‘é€æ–¹åœ°å€</label>
            <input id="fromAddress" type="text" disabled placeholder="è¿æ¥é’±åŒ…åæ˜¾ç¤º">
        </div>
        
        <div class="form-group">
            <label>æå–åˆ°é’±åŒ…çš„åœ°å€</label>
            <input id="toAddress" type="text" placeholder="è¯·è¾“å…¥æ¥æ”¶æ–¹åœ°å€">
            <div class="warning">âš ï¸ è¯·ä»”ç»†æ£€æŸ¥åœ°å€ï¼Œé¿å…é€ æˆèµ„äº§æŸå¤±</div>
        </div>
        
        <div class="form-group">
            <label>æå¸æ•°é‡</label>
            <input id="amount" type="number" step="0.000001" placeholder="è¯·è¾“å…¥æ•°é‡">
            <div id="maxAmountInfo" class="info">æœ€å¤§å¯æå¸æ•°é‡ï¼šåŠ è½½ä¸­...</div>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div>å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...</div>
        </div>
        
        <button id="submitBtn" class="submit-btn" disabled>ç¡®è®¤æå¸</button>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let provider = null;
        let connection = null;
        let config = {
            tokenSymbol: '',
            tokenName: '',
            contractAddress: '',
            network: 'solana',
            fromAddress: '',
            maxAmount: 0,
            decimals: 9
        };

        // çŠ¶æ€æ˜¾ç¤ºå‡½æ•°
        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            statusEl.style.display = 'block';
            
            if (type === 'success' || type === 'error') {
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 5000);
            }
        }

        // æ˜¾ç¤º/éšè—åŠ è½½çŠ¶æ€
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
            document.getElementById('submitBtn').disabled = show;
        }

        // iOS æ³¨å…¥é…ç½®å‡½æ•°
        window.setTransactionConfig = function(jsonString) {
            try {
                const data = JSON.parse(jsonString);
                console.log('ğŸ“± æ”¶åˆ°iOSé…ç½®å‚æ•°:', data);
                
                // åˆå¹¶é…ç½®
                config = { ...config, ...data };
                
                // æ›´æ–°é¡µé¢æ ‡é¢˜
                document.getElementById('pageTitle').textContent = 
                    `${config.tokenName || config.tokenSymbol || 'Solana'} è½¬è´¦`;
                
                // æ›´æ–°UIè¡¨å•
                document.getElementById('tokenSymbol').value = config.tokenSymbol || 'SOL';
                document.getElementById('network').value = config.network || 'Solana';
                document.getElementById('fromAddress').value = config.fromAddress || '';
                
                // æ›´æ–°æœ€å¤§å¯æå¸æ•°é‡æ˜¾ç¤º
                document.getElementById('maxAmountInfo').textContent = 
                    `æœ€å¤§å¯æå¸æ•°é‡ï¼š${config.maxAmount || 0} ${config.tokenSymbol || 'SOL'}`;
                
                // æ›´æ–°é‡‘é¢è¾“å…¥æ¡†çš„æœ€å¤§å€¼
                const amountInput = document.getElementById('amount');
                if (config.maxAmount > 0) {
                    amountInput.max = config.maxAmount;
                    amountInput.placeholder = `è¯·è¾“å…¥é‡‘é¢ (æœ€å¤§: ${config.maxAmount})`;
                } else {
                    amountInput.placeholder = `è¯·è¾“å…¥é‡‘é¢`;
                }
                
                // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                const statusDiv = document.getElementById('status');
                const configInfo = `
                    <div style="background: #d4edda; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #28a745;">
                        <h4 style="margin-top: 0; color: #155724;">âœ… äº¤æ˜“é…ç½®å·²åŠ è½½</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px; margin-top: 10px;">
                            <div><strong>ä»£å¸åç§°:</strong> ${config.tokenName || config.tokenSymbol || 'Solana'}</div>
                            <div><strong>ä»£å¸ç¬¦å·:</strong> ${config.tokenSymbol || 'SOL'}</div>
                            <div><strong>ç½‘ç»œ:</strong> ${config.network || 'Solana'}</div>
                            <div><strong>ç²¾åº¦:</strong> ${config.decimals || 9}</div>
                            <div><strong>å‘é€åœ°å€:</strong> ${config.fromAddress ? config.fromAddress.substring(0, 8) + '...' + config.fromAddress.substring(config.fromAddress.length - 8) : 'æœªè®¾ç½®'}</div>
                            <div><strong>æœ€å¤§é‡‘é¢:</strong> ${config.maxAmount || 0} ${config.tokenSymbol || 'SOL'}</div>
                        </div>
                        ${config.contractAddress ? `<div style="margin-top: 10px; font-size: 12px;"><strong>åˆçº¦åœ°å€:</strong> <span style="font-family: monospace;">${config.contractAddress}</span></div>` : '<div style="margin-top: 10px; font-size: 12px;"><em>åŸç”Ÿä»£å¸ï¼ˆæ— éœ€åˆçº¦åœ°å€ï¼‰</em></div>'}
                    </div>
                `;
                
                statusDiv.innerHTML = configInfo;
                
                console.log('âœ… [Config] äº¤æ˜“é…ç½®æ›´æ–°å®Œæˆ:', config);
                
            } catch (error) {
                console.error('âŒ [Config] é…ç½®è§£æå¤±è´¥:', error);
                showStatus('é…ç½®åŠ è½½å¤±è´¥: ' + error.message, 'error');
            }
        };

        // æ£€æµ‹ Phantom é’±åŒ… (çœŸå®æ£€æµ‹ç‰ˆ)
        function detectPhantom() {
            return new Promise((resolve) => {
                console.log('ğŸ” å¼€å§‹æ£€æµ‹ Phantom é’±åŒ…...');
                
                // ç›´æ¥æ£€æµ‹ Phantom é’±åŒ…
                if (window.solana && window.solana.isPhantom) {
                    console.log('âœ… æ£€æµ‹åˆ° Phantom é’±åŒ…');
                    resolve(true);
                    return;
                }

                // æ£€æµ‹å…¶ä»–å¯èƒ½çš„ solana å¯¹è±¡
                if (window.solana && typeof window.solana.connect === 'function') {
                    console.log('âœ… æ£€æµ‹åˆ° Solana é’±åŒ…å¯¹è±¡');
                    resolve(true);
                    return;
                }

                // æ£€æµ‹ window.phantom.solana
                if (window.phantom && window.phantom.solana) {
                    console.log('âœ… é€šè¿‡ window.phantom.solana æ£€æµ‹åˆ°é’±åŒ…');
                    window.solana = window.phantom.solana;
                    resolve(true);
                    return;
                }

                // è½®è¯¢æ£€æµ‹ (æœ€å¤šç­‰å¾…5ç§’ï¼Œå› ä¸ºçœŸå®é’±åŒ…æ³¨å…¥é€šå¸¸å¾ˆå¿«)
                let attempts = 0;
                const maxAttempts = 50; // 5ç§’å†…æ£€æµ‹50æ¬¡
                
                console.log('ğŸ”„ å¼€å§‹è½®è¯¢æ£€æµ‹ï¼Œæœ€å¤šç­‰å¾…5ç§’...');
                
                const checkInterval = setInterval(() => {
                    attempts++;
                    
                    if (window.solana && window.solana.isPhantom) {
                        console.log('âœ… è½®è¯¢æ£€æµ‹åˆ° Phantom é’±åŒ…');
                        clearInterval(checkInterval);
                        resolve(true);
                        return;
                    }
                    
                    if (window.phantom && window.phantom.solana) {
                        console.log('âœ… è½®è¯¢æ£€æµ‹åˆ° window.phantom.solana');
                        window.solana = window.phantom.solana;
                        clearInterval(checkInterval);
                        resolve(true);
                        return;
                    }
                    
                    if (attempts >= maxAttempts) {
                        console.log('âŒ è½®è¯¢æ£€æµ‹è¶…æ—¶ (5ç§’)');
                        clearInterval(checkInterval);
                        resolve(false);
                    }
                }, 100);
            });
        }

        // æ‰‹åŠ¨é‡æ–°æ£€æµ‹é’±åŒ…
        async function manualDetectWallet() {
            showStatus('æ‰‹åŠ¨é‡æ–°æ£€æµ‹é’±åŒ…...', 'info');
            
            const detected = await detectPhantom();
            
            if (detected) {
                showStatus('âœ… é’±åŒ…æ£€æµ‹æˆåŠŸï¼ç°åœ¨å¯ä»¥å°è¯•è¿æ¥', 'success');
                document.getElementById('connectBtn').textContent = 'è¿æ¥ Phantom é’±åŒ…';
                document.getElementById('connectBtn').disabled = false;
            } else {
                showStatus('âŒ ä»æœªæ£€æµ‹åˆ°é’±åŒ…ï¼Œè¯·æŸ¥çœ‹è°ƒè¯•ä¿¡æ¯', 'error');
                // è‡ªåŠ¨æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
                debugWalletDetection();
            }
        }

        // å°è¯•é€šè¿‡æ·±é“¾æ¥æ£€æµ‹å¹¶æ‰“å¼€ Phantom é’±åŒ… (å¢å¼ºç‰ˆ)
        function openPhantomApp() {
            console.log('ğŸ”— å°è¯•æ‰“å¼€ Phantom åº”ç”¨...');
            
            showStatus('æ­£åœ¨å°è¯•æ‰“å¼€ Phantom åº”ç”¨...', 'info');
            
            // å°è¯•å¤šç§æ·±é“¾æ¥
            const phantomLinks = [
                'phantom://',
                'phantom://browse',
                'phantom://connect'
            ];
            
            let linkIndex = 0;
            
            function tryNextLink() {
                if (linkIndex >= phantomLinks.length) {
                    // æ‰€æœ‰é“¾æ¥éƒ½å°è¯•è¿‡äº†ï¼Œæ˜¾ç¤ºæ‰‹åŠ¨æŒ‡å¯¼
                    showManualInstructions();
                    return;
                }
                
                const link = phantomLinks[linkIndex];
                console.log(`ğŸ”— å°è¯•é“¾æ¥: ${link}`);
                
                // åˆ›å»ºéšè—çš„é“¾æ¥
                const a = document.createElement('a');
                a.href = link;
                a.style.display = 'none';
                document.body.appendChild(a);
                
                // è®¾ç½®è¶…æ—¶æ£€æµ‹
                const timeout = setTimeout(() => {
                    console.log(`âŒ é“¾æ¥ ${link} è¶…æ—¶`);
                    document.body.removeChild(a);
                    linkIndex++;
                    tryNextLink();
                }, 2000);
                
                // å°è¯•ç‚¹å‡»é“¾æ¥
                try {
                    a.click();
                    
                    // å¦‚æœæˆåŠŸï¼Œæ¸…é™¤è¶…æ—¶å¹¶ç­‰å¾…ç”¨æˆ·å›æ¥
                    clearTimeout(timeout);
                    document.body.removeChild(a);
                    
                    showStatus('å·²å°è¯•æ‰“å¼€ Phantomï¼Œè¯·åœ¨åº”ç”¨ä¸­æ“ä½œåè¿”å›', 'info');
                    
                    // 5ç§’åé‡æ–°æ£€æµ‹
                    setTimeout(async () => {
                        console.log('ğŸ”„ ç”¨æˆ·è¿”å›ï¼Œé‡æ–°æ£€æµ‹é’±åŒ…...');
                        const detected = await detectPhantom();
                        
                        if (detected) {
                            showStatus('âœ… æ£€æµ‹åˆ°é’±åŒ…ï¼è¯·å°è¯•è¿æ¥', 'success');
                            document.getElementById('connectBtn').disabled = false;
                            document.getElementById('connectBtn').textContent = 'è¿æ¥ Phantom é’±åŒ…';
                        } else {
                            showStatus('âŒ ä»æœªæ£€æµ‹åˆ°ï¼Œè¯·æŸ¥çœ‹ä¸‹æ–¹æŒ‡å¯¼', 'error');
                            showManualInstructions();
                        }
                    }, 5000);
                    
                } catch (error) {
                    console.log(`âŒ é“¾æ¥ ${link} ç‚¹å‡»å¤±è´¥:`, error);
                    clearTimeout(timeout);
                    document.body.removeChild(a);
                    linkIndex++;
                    tryNextLink();
                }
            }
            
            tryNextLink();
        }
        
        // æ˜¾ç¤ºæ‰‹åŠ¨æ“ä½œæŒ‡å¯¼
        function showManualInstructions() {
            const instructions = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #007bff;">
                    <h4 style="margin-top: 0; color: #007bff;">ğŸ“± æ‰‹åŠ¨æ“ä½œæŒ‡å¯¼</h4>
                    <ol style="margin: 10px 0; padding-left: 20px;">
                        <li>ç¡®è®¤å·²åœ¨ App Store å®‰è£…äº† <strong>Phantom é’±åŒ…</strong></li>
                        <li>æ‰“å¼€ Phantom åº”ç”¨ï¼Œç¡®ä¿å·²åˆ›å»ºæˆ–å¯¼å…¥é’±åŒ…</li>
                        <li>åœ¨ Phantom è®¾ç½®ä¸­å¯ç”¨ <strong>"DApp æµè§ˆå™¨"</strong> åŠŸèƒ½</li>
                        <li>è¿”å›æ­¤é¡µé¢ï¼Œç‚¹å‡» <strong>"é‡æ–°æ£€æµ‹é’±åŒ…"</strong> æŒ‰é’®</li>
                        <li>å¦‚æœä»æœ‰é—®é¢˜ï¼Œè¯·å°è¯•é‡å¯ Phantom åº”ç”¨</li>
                    </ol>
                    <div style="margin-top: 15px;">
                        <button onclick="window.open('https://apps.apple.com/app/phantom-solana-wallet/id1598432977')" 
                                style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 6px; margin-right: 10px;">
                            ğŸ“± ä¸‹è½½ Phantom
                        </button>
                        <button onclick="manualDetectWallet()" 
                                style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 6px;">
                            ğŸ”„ é‡æ–°æ£€æµ‹
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('status').innerHTML = instructions;
        }

        // æ”¹è¿›é”™è¯¯å¤„ç†çš„è¿æ¥å‡½æ•°
        async function connectPhantomWithFallback() {
            try {
                showStatus('æ­£åœ¨è¿æ¥ Phantom é’±åŒ…...', 'info');
                
                // å…ˆå°è¯•æ£€æµ‹é’±åŒ…
                const detected = await detectPhantom();
                
                if (!detected) {
                    showStatus('æœªæ£€æµ‹åˆ° Phantom é’±åŒ…ï¼Œè¯·é€‰æ‹©è§£å†³æ–¹æ¡ˆ', 'error');
                    
                    // æ˜¾ç¤ºé€‰æ‹©æŒ‰é’®
                    const choiceHTML = `
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #ffc107;">
                            <h4 style="margin-top: 0; color: #856404;">ğŸ” æœªæ£€æµ‹åˆ° Phantom é’±åŒ…</h4>
                            <p>è¯·é€‰æ‹©è§£å†³æ–¹æ¡ˆï¼š</p>
                            <div style="margin-top: 15px;">
                                <button onclick="openPhantomApp()" 
                                        style="background: #6f42c1; color: white; border: none; padding: 10px 20px; border-radius: 6px; margin-right: 10px;">
                                    ğŸ“± å°è¯•æ‰“å¼€ Phantom
                                </button>
                                <button onclick="manualDetectWallet()" 
                                        style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 6px; margin-right: 10px;">
                                    ğŸ”„ é‡æ–°æ£€æµ‹
                                </button>
                                <button onclick="debugWalletDetection()" 
                                        style="background: #ff8c00; color: white; border: none; padding: 10px 20px; border-radius: 6px;">
                                    ğŸ” æŸ¥çœ‹è¯¦æƒ…
                                </button>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('status').innerHTML = choiceHTML;
                    return;
                }
                
                // æ£€æµ‹åˆ°é’±åŒ…ï¼Œå°è¯•è¿æ¥
                await connectPhantom();
                
            } catch (error) {
                console.error('è¿æ¥å¤±è´¥:', error);
                showStatus(`è¿æ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // è¿æ¥ Phantom é’±åŒ… (çœŸå®è¿æ¥ç‰ˆ)
        async function connectPhantom() {
            try {
                showLoading(true);
                showStatus('æ­£åœ¨æ£€æµ‹ Phantom é’±åŒ…...', 'info');

                // ç­‰å¾…é’±åŒ…æ£€æµ‹å®Œæˆ
                const isPhantomAvailable = await detectPhantom();
                
                if (!isPhantomAvailable) {
                    throw new Error('Phantom é’±åŒ…æœªæ£€æµ‹åˆ°ã€‚è¯·ç¡®ä¿å·²å®‰è£… Phantom é’±åŒ…åº”ç”¨å¹¶å·²åˆ›å»ºé’±åŒ…ã€‚');
                }

                showStatus('æ­£åœ¨è¿æ¥ Phantom é’±åŒ…...', 'info');

                // è·å– provider
                provider = window.solana;
                
                // å°è¯•è¿æ¥é’±åŒ…
                const response = await provider.connect({ onlyIfTrusted: false });
                
                if (!response || !response.publicKey) {
                    throw new Error('è¿æ¥å¤±è´¥ï¼Œæœªè·å–åˆ°é’±åŒ…åœ°å€');
                }
                
                const publicKey = response.publicKey.toString();
                console.log('âœ… æˆåŠŸè¿æ¥åˆ° Phantom é’±åŒ…:', publicKey);
                
                // è®¾ç½® Solana è¿æ¥
                connection = new solanaWeb3.Connection(
                    solanaWeb3.clusterApiUrl('mainnet-beta'),
                    'confirmed'
                );

                // æ›´æ–°é…ç½®å’ŒUI
                config.fromAddress = publicKey;
                document.getElementById('fromAddress').value = publicKey;
                document.getElementById('connectBtn').textContent = 'âœ… é’±åŒ…å·²è¿æ¥';
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('submitBtn').disabled = false;
                
                showStatus('é’±åŒ…è¿æ¥æˆåŠŸï¼', 'success');
                
                // è·å–çœŸå®ä½™é¢
                await updateBalance();
                
            } catch (error) {
                console.error('è¿æ¥å¤±è´¥:', error);
                
                let errorMessage = error.message;
                if (error.code === 4001) {
                    errorMessage = 'ç”¨æˆ·æ‹’ç»è¿æ¥é’±åŒ…';
                } else if (error.code === -32603) {
                    errorMessage = 'é’±åŒ…è¿æ¥å¤±è´¥ï¼Œè¯·é‡è¯•';
                } else if (error.message.includes('User rejected')) {
                    errorMessage = 'ç”¨æˆ·å–æ¶ˆäº†è¿æ¥è¯·æ±‚';
                }
                
                showStatus(`è¿æ¥å¤±è´¥: ${errorMessage}`, 'error');
                
                // é‡ç½®è¿æ¥æŒ‰é’®
                document.getElementById('connectBtn').textContent = 'é‡æ–°è¿æ¥ Phantom é’±åŒ…';
                document.getElementById('connectBtn').disabled = false;
            } finally {
                showLoading(false);
            }
        }

        // æ›´æ–°ä½™é¢æ˜¾ç¤º
        async function updateBalance() {
            try {
                if (!connection || !provider.publicKey) return;

                const publicKey = provider.publicKey;
                let balance = 0;

                if (!config.contractAddress || config.tokenSymbol === 'SOL') {
                    // SOL ä½™é¢
                    const lamports = await connection.getBalance(publicKey);
                    balance = lamports / solanaWeb3.LAMPORTS_PER_SOL;
                } else {
                    // SPL ä»£å¸ä½™é¢
                    const tokenAccounts = await connection.getTokenAccountsByOwner(publicKey, {
                        mint: new solanaWeb3.PublicKey(config.contractAddress)
                    });

                    if (tokenAccounts.value.length > 0) {
                        const accountInfo = await connection.getTokenAccountBalance(
                            tokenAccounts.value[0].pubkey
                        );
                        balance = parseFloat(accountInfo.value.uiAmountString || '0');
                    }
                }

                config.maxAmount = balance;
                document.getElementById('maxAmountInfo').textContent = 
                    `æœ€å¤§å¯æå¸æ•°é‡ï¼š${balance} ${config.tokenSymbol}`;
                    
            } catch (error) {
                console.error('è·å–ä½™é¢å¤±è´¥:', error);
                showStatus('è·å–ä½™é¢å¤±è´¥', 'error');
            }
        }

        // éªŒè¯åœ°å€æ ¼å¼
        function isValidSolanaAddress(address) {
            try {
                new solanaWeb3.PublicKey(address);
                return true;
            } catch {
                return false;
            }
        }

        // åˆ›å»º SOL è½¬è´¦äº¤æ˜“
        async function createSOLTransfer(fromPubkey, toPubkey, amount) {
            const lamports = Math.floor(amount * solanaWeb3.LAMPORTS_PER_SOL);
            
            const transaction = new solanaWeb3.Transaction();
            transaction.add(
                solanaWeb3.SystemProgram.transfer({
                    fromPubkey: fromPubkey,
                    toPubkey: toPubkey,
                    lamports: lamports
                })
            );

            return transaction;
        }

        // åˆ›å»º SPL ä»£å¸è½¬è´¦äº¤æ˜“
        async function createSPLTransfer(fromPubkey, toPubkey, amount) {
            const mintPublicKey = new solanaWeb3.PublicKey(config.contractAddress);
            
            // è·å–å‘é€æ–¹ä»£å¸è´¦æˆ·
            const fromTokenAccounts = await connection.getTokenAccountsByOwner(fromPubkey, {
                mint: mintPublicKey
            });

            if (fromTokenAccounts.value.length === 0) {
                throw new Error('å‘é€æ–¹æ²¡æœ‰æ­¤ä»£å¸è´¦æˆ·');
            }

            const fromTokenAccount = fromTokenAccounts.value[0].pubkey;

            // è·å–æˆ–åˆ›å»ºæ¥æ”¶æ–¹ä»£å¸è´¦æˆ·
            const toTokenAccounts = await connection.getTokenAccountsByOwner(toPubkey, {
                mint: mintPublicKey
            });

            let toTokenAccount;
            const transaction = new solanaWeb3.Transaction();

            if (toTokenAccounts.value.length === 0) {
                // åˆ›å»ºæ¥æ”¶æ–¹ä»£å¸è´¦æˆ·
                toTokenAccount = await solanaWeb3.Token.getAssociatedTokenAddress(
                    solanaWeb3.ASSOCIATED_TOKEN_PROGRAM_ID,
                    solanaWeb3.TOKEN_PROGRAM_ID,
                    mintPublicKey,
                    toPubkey
                );

                transaction.add(
                    solanaWeb3.Token.createAssociatedTokenAccountInstruction(
                        solanaWeb3.ASSOCIATED_TOKEN_PROGRAM_ID,
                        solanaWeb3.TOKEN_PROGRAM_ID,
                        mintPublicKey,
                        toTokenAccount,
                        toPubkey,
                        fromPubkey
                    )
                );
            } else {
                toTokenAccount = toTokenAccounts.value[0].pubkey;
            }

            // æ·»åŠ è½¬è´¦æŒ‡ä»¤
            const transferAmount = Math.floor(amount * Math.pow(10, config.decimals));
            
            transaction.add(
                solanaWeb3.Token.createTransferInstruction(
                    solanaWeb3.TOKEN_PROGRAM_ID,
                    fromTokenAccount,
                    toTokenAccount,
                    fromPubkey,
                    [],
                    transferAmount
                )
            );

            return transaction;
        }

        // æ‰§è¡Œäº¤æ˜“
        async function executeTransaction() {
            try {
                showLoading(true);
                showStatus('æ­£åœ¨åˆ›å»ºäº¤æ˜“...', 'info');

                // éªŒè¯è¾“å…¥
                const toAddress = document.getElementById('toAddress').value.trim();
                const amount = parseFloat(document.getElementById('amount').value);

                if (!toAddress) {
                    throw new Error('è¯·è¾“å…¥æ¥æ”¶æ–¹åœ°å€');
                }

                if (!isValidSolanaAddress(toAddress)) {
                    throw new Error('æ¥æ”¶æ–¹åœ°å€æ ¼å¼æ— æ•ˆ');
                }

                if (isNaN(amount) || amount <= 0) {
                    throw new Error('è¯·è¾“å…¥æœ‰æ•ˆçš„è½¬è´¦é‡‘é¢');
                }

                if (amount > config.maxAmount) {
                    throw new Error(`è½¬è´¦é‡‘é¢ä¸èƒ½è¶…è¿‡ ${config.maxAmount} ${config.tokenSymbol}`);
                }

                const fromPubkey = provider.publicKey;
                const toPubkey = new solanaWeb3.PublicKey(toAddress);

                // åˆ›å»ºäº¤æ˜“
                let transaction;
                if (!config.contractAddress || config.tokenSymbol === 'SOL') {
                    transaction = await createSOLTransfer(fromPubkey, toPubkey, amount);
                } else {
                    transaction = await createSPLTransfer(fromPubkey, toPubkey, amount);
                }

                showStatus('æ­£åœ¨è·å–æœ€æ–°åŒºå—ä¿¡æ¯...', 'info');
                
                // è®¾ç½®äº¤æ˜“å±æ€§
                const { blockhash } = await connection.getLatestBlockhash('confirmed');
                transaction.recentBlockhash = blockhash;
                transaction.feePayer = fromPubkey;

                showStatus('è¯·åœ¨ Phantom é’±åŒ…ä¸­ç¡®è®¤äº¤æ˜“...', 'info');

                // ç­¾åäº¤æ˜“
                const signedTransaction = await provider.signTransaction(transaction);

                showStatus('æ­£åœ¨å‘é€äº¤æ˜“åˆ°ç½‘ç»œ...', 'info');

                // å‘é€äº¤æ˜“
                const signature = await connection.sendRawTransaction(
                    signedTransaction.serialize(),
                    {
                        skipPreflight: false,
                        preflightCommitment: 'confirmed'
                    }
                );

                showStatus('æ­£åœ¨ç¡®è®¤äº¤æ˜“...', 'info');

                // ç­‰å¾…ç¡®è®¤
                const confirmation = await connection.confirmTransaction(signature, 'confirmed');

                if (confirmation.value.err) {
                    throw new Error('äº¤æ˜“æ‰§è¡Œå¤±è´¥');
                }

                showStatus(`äº¤æ˜“æˆåŠŸï¼ç­¾å: ${signature}`, 'success');
                
                // é€šçŸ¥ iOS
                if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.phantomCallback) {
                    window.webkit.messageHandlers.phantomCallback.postMessage({
                        type: 'success',
                        signature: signature,
                        amount: amount,
                        token: config.tokenSymbol,
                        from: fromPubkey.toString(),
                        to: toAddress
                    });
                }

                // æ›´æ–°ä½™é¢
                setTimeout(updateBalance, 2000);

            } catch (error) {
                console.error('äº¤æ˜“å¤±è´¥:', error);
                showStatus(`äº¤æ˜“å¤±è´¥: ${error.message}`, 'error');
                
                // é€šçŸ¥ iOS
                if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.phantomCallback) {
                    window.webkit.messageHandlers.phantomCallback.postMessage({
                        type: 'error',
                        message: error.message
                    });
                }
            } finally {
                showLoading(false);
            }
        }

        // è°ƒè¯•åŠŸèƒ½ï¼šæ£€æµ‹é’±åŒ…çŠ¶æ€
        function debugWalletDetection() {
            const debugDiv = document.getElementById('debugInfo');
            const debugContent = document.getElementById('debugContent');
            
            let debugText = '';
            
            // æ£€æµ‹å„ç§é’±åŒ…ç›¸å…³å¯¹è±¡
            debugText += `ç”¨æˆ·ä»£ç†: ${navigator.userAgent}<br><br>`;
            
            debugText += `window.solana å­˜åœ¨: ${window.solana ? 'âœ… æ˜¯' : 'âŒ å¦'}<br>`;
            
            if (window.solana) {
                debugText += `solana.isPhantom: ${window.solana.isPhantom ? 'âœ… æ˜¯' : 'âŒ å¦'}<br>`;
                debugText += `solana.connect æ–¹æ³•: ${typeof window.solana.connect === 'function' ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}<br>`;
                debugText += `solana.publicKey: ${window.solana.publicKey ? window.solana.publicKey.toString() : 'âŒ æœªè¿æ¥'}<br>`;
                debugText += `solana ç‰ˆæœ¬: ${window.solana.version || 'æœªçŸ¥'}<br>`;
                
                // åˆ—å‡ºæ‰€æœ‰å¯ç”¨æ–¹æ³•
                const methods = Object.getOwnPropertyNames(window.solana).filter(prop => 
                    typeof window.solana[prop] === 'function'
                );
                debugText += `å¯ç”¨æ–¹æ³•: ${methods.join(', ')}<br>`;
            }
            
            // æ£€æµ‹å…¶ä»–é’±åŒ…
            debugText += `<br>å…¶ä»–é’±åŒ…æ£€æµ‹:<br>`;
            debugText += `window.ethereum: ${window.ethereum ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}<br>`;
            debugText += `window.phantom: ${window.phantom ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}<br>`;
            
            // æ£€æµ‹é¡µé¢ç¯å¢ƒ
            debugText += `<br>é¡µé¢ç¯å¢ƒ:<br>`;
            debugText += `åè®®: ${window.location.protocol}<br>`;
            debugText += `åŸŸå: ${window.location.hostname}<br>`;
            debugText += `ç«¯å£: ${window.location.port || 'é»˜è®¤'}<br>`;
            debugText += `å®Œæ•´URL: ${window.location.href}<br>`;
            
            // Solana Web3.js æ£€æµ‹
            debugText += `<br>Solana Web3.js:<br>`;
            debugText += `solanaWeb3 å¯¹è±¡: ${typeof solanaWeb3 !== 'undefined' ? 'âœ… å·²åŠ è½½' : 'âŒ æœªåŠ è½½'}<br>`;
            if (typeof solanaWeb3 !== 'undefined') {
                debugText += `Connection ç±»: ${typeof solanaWeb3.Connection === 'function' ? 'âœ… å¯ç”¨' : 'âŒ ä¸å¯ç”¨'}<br>`;
                debugText += `PublicKey ç±»: ${typeof solanaWeb3.PublicKey === 'function' ? 'âœ… å¯ç”¨' : 'âŒ ä¸å¯ç”¨'}<br>`;
            }
            
            debugContent.innerHTML = debugText;
            debugDiv.style.display = 'block';
            
            // æ»šåŠ¨åˆ°è°ƒè¯•ä¿¡æ¯
            debugDiv.scrollIntoView({ behavior: 'smooth' });
        }



        // äº‹ä»¶ç›‘å¬å™¨
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸ“± é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
            
            // æ·»åŠ æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
            document.getElementById('connectBtn').addEventListener('click', connectPhantomWithFallback);
            document.getElementById('debugBtn').addEventListener('click', debugWalletDetection);
            document.getElementById('retryBtn').addEventListener('click', manualDetectWallet);
            
            // æ£€æµ‹é’±åŒ…
            showStatus('æ­£åœ¨æ£€æµ‹ Phantom é’±åŒ…...', 'info');
            
            const detected = await detectPhantom();
            
            if (detected) {
                showStatus('âœ… æ£€æµ‹åˆ° Phantom é’±åŒ…ï¼Œå¯ä»¥è¿æ¥ï¼', 'success');
                document.getElementById('connectBtn').disabled = false;
            } else {
                showStatus('âŒ æœªæ£€æµ‹åˆ° Phantom é’±åŒ…ï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æŸ¥çœ‹è¯¦æƒ…', 'error');
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('connectBtn').textContent = 'æœªæ£€æµ‹åˆ°é’±åŒ…';
                
                // æ˜¾ç¤ºé‡æ£€æµ‹æŒ‰é’®
                document.getElementById('retryBtn').style.display = 'block';
            }
        });

            // æäº¤æŒ‰é’®ç›‘å¬å™¨
            document.getElementById('submitBtn').addEventListener('click', executeTransaction);
            
            // é‡‘é¢è¾“å…¥éªŒè¯
            document.getElementById('amount').addEventListener('input', function(e) {
                const amount = parseFloat(e.target.value);
                const submitBtn = document.getElementById('submitBtn');
                const toAddress = document.getElementById('toAddress').value.trim();
                
                console.log('ğŸ’° éªŒè¯é‡‘é¢:', {
                    amount: amount,
                    maxAmount: config.maxAmount,
                    toAddress: toAddress,
                    isValidAmount: !isNaN(amount) && amount > 0,
                    isWithinLimit: config.maxAmount <= 0 || amount <= config.maxAmount,
                    hasToAddress: toAddress.length > 0
                });
                
                // æ›´å®½æ¾çš„éªŒè¯ï¼šå¦‚æœmaxAmountä¸º0æˆ–æœªè®¾ç½®ï¼Œåªæ£€æŸ¥é‡‘é¢æ˜¯å¦ä¸ºæ­£æ•°
                const isValidAmount = !isNaN(amount) && amount > 0;
                const isWithinLimit = config.maxAmount <= 0 || amount <= config.maxAmount;
                const hasToAddress = toAddress.length > 0;
                
                if (isValidAmount && isWithinLimit && hasToAddress) {
                    submitBtn.disabled = false;
                } else {
                    submitBtn.disabled = true;
                }
            });
            
            // æ¥æ”¶åœ°å€è¾“å…¥éªŒè¯
            document.getElementById('toAddress').addEventListener('input', function(e) {
                const toAddress = e.target.value.trim();
                const amount = parseFloat(document.getElementById('amount').value);
                const submitBtn = document.getElementById('submitBtn');
                
                const isValidAmount = !isNaN(amount) && amount > 0;
                const isWithinLimit = config.maxAmount <= 0 || amount <= config.maxAmount;
                const hasToAddress = toAddress.length > 0;
                
                if (isValidAmount && isWithinLimit && hasToAddress) {
                    submitBtn.disabled = false;
                } else {
                    submitBtn.disabled = true;
                }
            });
            
            // æ£€æŸ¥ solana-web3.js æ˜¯å¦åŠ è½½
            if (typeof solanaWeb3 !== 'undefined') {
                console.log('âœ… solana-web3.js åŠ è½½æˆåŠŸ');
            } else {
                console.error('âŒ solana-web3.js åŠ è½½å¤±è´¥');
                showStatus('Web3 åº“åŠ è½½å¤±è´¥', 'error');
            }

        // å…¼å®¹æ—§ç‰ˆæœ¬çš„é…ç½®å‡½æ•°
        window.setConfig = window.setTransactionConfig;
    </script>
</body>
</html>
