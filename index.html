<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Solana ËΩ¨Ë¥¶</title>
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
  <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #333;
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .info-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }
        
        .info-box h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .info-item:last-child {
            margin-bottom: 0;
        }
        
        .info-label {
            color: #666;
            font-weight: 500;
        }
        
        .info-value {
            color: #333;
            font-weight: 600;
        }
        
        .button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }
        
        .button-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .button-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .button-secondary {
            background: #f8f9fa;
            color: #333;
            border: 2px solid #e1e5e9;
        }
        
        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .status {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
            text-align: center;
        }
        
        .status-info {
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #bbdefb;
        }
        
        .status-success {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }
        
        .status-error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .debug-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e1e5e9;
        }
        
        .debug-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            font-family: monospace;
            font-size: 12px;
            color: #666;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 10px;
        }
  </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="pageTitle">Solana ËΩ¨Ë¥¶</h1>
        </div>
        
        <div id="status" class="status status-info">
            Ê≠£Âú®ÂàùÂßãÂåñ...
        </div>
        
        <div class="info-box">
            <h3>‰∫§Êòì‰ø°ÊÅØ</h3>
            <div class="info-item">
                <span class="info-label">‰ª£Â∏Å:</span>
                <span class="info-value" id="tokenName">Âä†ËΩΩ‰∏≠...</span>
            </div>
            <div class="info-item">
                <span class="info-label">ÁΩëÁªú:</span>
                <span class="info-value" id="network">Âä†ËΩΩ‰∏≠...</span>
            </div>
            <div class="info-item">
                <span class="info-label">ÊúÄÂ§ßÈáëÈ¢ù:</span>
                <span class="info-value" id="maxAmountInfo">Âä†ËΩΩ‰∏≠...</span>
            </div>
        </div>
        
        <div class="form-group">
            <label for="fromAddress">ÂèëÈÄÅÂú∞ÂùÄ</label>
            <input type="text" id="fromAddress" readonly placeholder="ËøûÊé•Èí±ÂåÖÂêéÊòæÁ§∫">
        </div>
        
        <div class="form-group">
            <label for="toAddress">Êé•Êî∂Âú∞ÂùÄ</label>
            <input type="text" id="toAddress" placeholder="ËØ∑ËæìÂÖ•Êé•Êî∂ÊñπÂú∞ÂùÄ">
        </div>
        
        <div class="form-group">
            <label for="amount">ËΩ¨Ë¥¶ÈáëÈ¢ù</label>
            <input type="number" id="amount" step="0.000001" placeholder="ËØ∑ËæìÂÖ•ËΩ¨Ë¥¶ÈáëÈ¢ù">
        </div>
        
        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <div>Â§ÑÁêÜ‰∏≠...</div>
        </div>
        
        <button id="connectBtn" class="button button-primary">ËøûÊé• Phantom Èí±ÂåÖ</button>
        <button id="submitBtn" class="button button-primary" disabled>Á°ÆËÆ§ËΩ¨Ë¥¶</button>
        
        <div class="debug-section">
            <button id="debugBtn" class="button button-secondary">ÊòæÁ§∫Ë∞ÉËØï‰ø°ÊÅØ</button>
            <div id="debugInfo" class="debug-info" style="display: none;"></div>
        </div>
    </div>

  <script>
        // ÂÖ®Â±ÄÂèòÈáè
        let provider = null;
        let connection = null;
        let config = {
            tokenSymbol: 'SOL',
            tokenName: 'Solana',
            contractAddress: '',
            network: 'solana',
            fromAddress: '',
            maxAmount: 0,
            decimals: 9
        };

        // ÊòæÁ§∫Áä∂ÊÄÅ‰ø°ÊÅØ
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status status-${type}`;
            console.log(`[Status] ${message}`);
        }

        // ÊòæÁ§∫/ÈöêËóèÂä†ËΩΩÁä∂ÊÄÅ
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
            document.getElementById('submitBtn').disabled = show;
        }

        // Ê£ÄÊµã iOS WebView ÁéØÂ¢ÉÂπ∂ÂàõÂª∫ Phantom Ê°•Êé•
        function createPhantomBridge() {
            if (!window.solana && window.webkit && window.webkit.messageHandlers) {
                console.log('üîó Ê£ÄÊµãÂà∞ iOS WebView ÁéØÂ¢ÉÔºåÂàõÂª∫ Phantom Ê°•Êé•');
                
                // ÂàõÂª∫Ê®°ÊãüÁöÑ Phantom Èí±ÂåÖÂØπË±°
                window.solana = {
                    isPhantom: true,
                    name: 'Phantom',
                    version: '1.0.0',
                    isConnected: false,
                    publicKey: null,
                    
                    // ËøûÊé•ÊñπÊ≥ï - ÈÄöËøá iOS Ê°•Êé•
                    connect: function(options = {}) {
                        return new Promise((resolve, reject) => {
                            console.log('üîó ÈÄöËøá iOS Ê°•Êé•ËØ∑Ê±ÇËøûÊé• Phantom');
                            
                            // ËÆæÁΩÆË∂ÖÊó∂
                            const timeout = setTimeout(() => {
                                reject(new Error('ËøûÊé•Ë∂ÖÊó∂'));
                            }, 30000);
                            
                            // Â≠òÂÇ® Promise ÂõûË∞É
                            window.phantomConnectResolve = resolve;
                            window.phantomConnectReject = reject;
                            window.phantomConnectTimeout = timeout;
                            
                            // ÂèëÈÄÅËøûÊé•ËØ∑Ê±ÇÂà∞ iOS
                            if (window.webkit.messageHandlers.phantomCallback) {
                                window.webkit.messageHandlers.phantomCallback.postMessage({
                                    type: 'connect_request',
                                    options: options
                                });
                            } else {
                                reject(new Error('iOS Ê°•Êé•‰∏çÂèØÁî®'));
                            }
                        });
                    },
                    
                    // Êñ≠ÂºÄËøûÊé•
                    disconnect: function() {
                        this.isConnected = false;
                        this.publicKey = null;
                        console.log('üîå Phantom Èí±ÂåÖÂ∑≤Êñ≠ÂºÄ');
                        
                        // ÈÄöÁü• iOS
                        if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.phantomCallback) {
                            window.webkit.messageHandlers.phantomCallback.postMessage({
                                type: 'disconnect'
                            });
                        }
                    },
                    
                    // Á≠æÂêç‰∫§Êòì
                    signTransaction: function(transaction) {
                        return new Promise((resolve, reject) => {
                            console.log('‚úçÔ∏è ÈÄöËøá iOS Ê°•Êé•ËØ∑Ê±ÇÁ≠æÂêç‰∫§Êòì');
                            
                            // ËÆæÁΩÆË∂ÖÊó∂
                            const timeout = setTimeout(() => {
                                reject(new Error('Á≠æÂêçË∂ÖÊó∂'));
                            }, 60000);
                            
                            // Â≠òÂÇ® Promise ÂõûË∞É
                            window.phantomSignResolve = resolve;
                            window.phantomSignReject = reject;
                            window.phantomSignTimeout = timeout;
                            
                            // Â∫èÂàóÂåñ‰∫§Êòì
                            const serializedTx = transaction.serialize({
                                requireAllSignatures: false,
                                verifySignatures: false
                            });
                            
                            // ÂèëÈÄÅÁ≠æÂêçËØ∑Ê±ÇÂà∞ iOS
                            if (window.webkit.messageHandlers.phantomCallback) {
                                window.webkit.messageHandlers.phantomCallback.postMessage({
                                    type: 'sign_transaction',
                                    transaction: Array.from(serializedTx),
                                    fromAddress: config.fromAddress,
                                    toAddress: document.getElementById('toAddress').value,
                                    amount: parseFloat(document.getElementById('amount').value),
                                    tokenSymbol: config.tokenSymbol,
                                    contractAddress: config.contractAddress
                                });
                            } else {
                                reject(new Error('iOS Ê°•Êé•‰∏çÂèØÁî®'));
                            }
                        });
                    }
                };
                
                console.log('‚úÖ Phantom Ê°•Êé•ÂØπË±°Â∑≤ÂàõÂª∫');
                return true;
            }
            return false;
        }

        // iOS ÂõûË∞ÉÂ§ÑÁêÜÂáΩÊï∞
        window.handlePhantomResponse = function(response) {
            console.log('üì± Êî∂Âà∞ iOS Phantom ÂìçÂ∫î:', response);
            
            if (response.type === 'connect_success') {
                // ËøûÊé•ÊàêÂäü
                if (window.phantomConnectResolve) {
                    clearTimeout(window.phantomConnectTimeout);
                    
                    const publicKey = {
                        toString: () => response.publicKey,
                        toBase58: () => response.publicKey
                    };
                    
                    window.solana.isConnected = true;
                    window.solana.publicKey = publicKey;
                    
                    window.phantomConnectResolve({ publicKey });
                    
                    // Ê∏ÖÁêÜÂõûË∞É
                    delete window.phantomConnectResolve;
                    delete window.phantomConnectReject;
                    delete window.phantomConnectTimeout;
                }
            } else if (response.type === 'connect_error') {
                // ËøûÊé•Â§±Ë¥•
                if (window.phantomConnectReject) {
                    clearTimeout(window.phantomConnectTimeout);
                    window.phantomConnectReject(new Error(response.message || 'ËøûÊé•Â§±Ë¥•'));
                    
                    // Ê∏ÖÁêÜÂõûË∞É
                    delete window.phantomConnectResolve;
                    delete window.phantomConnectReject;
                    delete window.phantomConnectTimeout;
                }
            } else if (response.type === 'sign_success') {
                // Á≠æÂêçÊàêÂäü
                if (window.phantomSignResolve) {
                    clearTimeout(window.phantomSignTimeout);
                    
                    // ÂàõÂª∫Á≠æÂêçÂêéÁöÑ‰∫§ÊòìÂØπË±°
                    const signedTxData = new Uint8Array(response.signedTransaction);
                    const signedTransaction = solanaWeb3.Transaction.from(signedTxData);
                    
                    window.phantomSignResolve(signedTransaction);
                    
                    // Ê∏ÖÁêÜÂõûË∞É
                    delete window.phantomSignResolve;
                    delete window.phantomSignReject;
                    delete window.phantomSignTimeout;
                }
            } else if (response.type === 'sign_error') {
                // Á≠æÂêçÂ§±Ë¥•
                if (window.phantomSignReject) {
                    clearTimeout(window.phantomSignTimeout);
                    window.phantomSignReject(new Error(response.message || 'Á≠æÂêçÂ§±Ë¥•'));
                    
                    // Ê∏ÖÁêÜÂõûË∞É
                    delete window.phantomSignResolve;
                    delete window.phantomSignReject;
                    delete window.phantomSignTimeout;
                }
            } else if (response.type === 'transaction_success') {
                // ‰∫§ÊòìÊàêÂäü
                showStatus(`‰∫§ÊòìÊàêÂäüÔºÅÁ≠æÂêç: ${response.signature}`, 'success');
                
                // ÈÄöÁü• iOS
                if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.phantomCallback) {
                    window.webkit.messageHandlers.phantomCallback.postMessage({
                        type: 'transaction_completed',
                        signature: response.signature,
                        success: true
                    });
                }
            } else if (response.type === 'transaction_error') {
                // ‰∫§ÊòìÂ§±Ë¥•
                showStatus(`‰∫§ÊòìÂ§±Ë¥•: ${response.message}`, 'error');
                
                // ÈÄöÁü• iOS
                if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.phantomCallback) {
                    window.webkit.messageHandlers.phantomCallback.postMessage({
                        type: 'transaction_completed',
                        error: response.message,
                        success: false
                    });
                }
            }
        };

        // Ê£ÄÊµã Phantom Èí±ÂåÖ
        function detectPhantom() {
            return new Promise((resolve) => {
                console.log('üîç ÂºÄÂßãÊ£ÄÊµã Phantom Èí±ÂåÖ...');
                
                // È¶ñÂÖàÂ∞ùËØïÂàõÂª∫Ê°•Êé•
                const bridgeCreated = createPhantomBridge();
                
                if (bridgeCreated) {
                    console.log('‚úÖ iOS WebView ÁéØÂ¢É‰∏ãÂàõÂª∫‰∫Ü Phantom Ê°•Êé•');
                    resolve(true);
                    return;
                }
                
                // ÂéüÊúâÁöÑÊ£ÄÊµãÈÄªËæë
                if (window.solana && window.solana.isPhantom) {
                    console.log('‚úÖ Ê£ÄÊµãÂà∞ Phantom Èí±ÂåÖ');
                    resolve(true);
                    return;
                }

                // Ê£ÄÊµãÂÖ∂‰ªñÂèØËÉΩÁöÑ solana ÂØπË±°
                if (window.solana && typeof window.solana.connect === 'function') {
                    console.log('‚úÖ Ê£ÄÊµãÂà∞ Solana Èí±ÂåÖÂØπË±°');
                    resolve(true);
                    return;
                }

                // Ê£ÄÊµã window.phantom.solana
                if (window.phantom && window.phantom.solana) {
                    console.log('‚úÖ ÈÄöËøá window.phantom.solana Ê£ÄÊµãÂà∞Èí±ÂåÖ');
                    window.solana = window.phantom.solana;
                    resolve(true);
                    return;
                }

                // ËΩÆËØ¢Ê£ÄÊµã
                let attempts = 0;
                const maxAttempts = 50;
                
                console.log('üîÑ ÂºÄÂßãËΩÆËØ¢Ê£ÄÊµãÔºåÊúÄÂ§öÁ≠âÂæÖ5Áßí...');
                
                const checkInterval = setInterval(() => {
                    attempts++;
                    
                    if (window.solana && window.solana.isPhantom) {
                        console.log('‚úÖ ËΩÆËØ¢Ê£ÄÊµãÂà∞ Phantom Èí±ÂåÖ');
                        clearInterval(checkInterval);
                        resolve(true);
                        return;
                    }
                    
                    if (window.phantom && window.phantom.solana) {
                        console.log('‚úÖ ËΩÆËØ¢Ê£ÄÊµãÂà∞ window.phantom.solana');
                        window.solana = window.phantom.solana;
                        clearInterval(checkInterval);
                        resolve(true);
        return;
      }

                    if (attempts >= maxAttempts) {
                        console.log('‚ùå ËΩÆËØ¢Ê£ÄÊµãË∂ÖÊó∂ (5Áßí)');
                        clearInterval(checkInterval);
                        resolve(false);
                    }
                }, 100);
            });
        }

        // ËøûÊé• Phantom Èí±ÂåÖ
        async function connectPhantom() {
            try {
                showLoading(true);
                showStatus('Ê≠£Âú®Ê£ÄÊµã Phantom Èí±ÂåÖ...', 'info');

                // Á≠âÂæÖÈí±ÂåÖÊ£ÄÊµãÂÆåÊàê
                const isPhantomAvailable = await detectPhantom();
                
                if (!isPhantomAvailable) {
                    throw new Error('Phantom Èí±ÂåÖÊú™Ê£ÄÊµãÂà∞„ÄÇËØ∑Á°Æ‰øùÂ∑≤ÂÆâË£Ö Phantom Èí±ÂåÖÂ∫îÁî®Âπ∂Â∑≤ÂàõÂª∫Èí±ÂåÖ„ÄÇ');
                }

                showStatus('Ê≠£Âú®ËøûÊé• Phantom Èí±ÂåÖ...', 'info');

                // Ëé∑Âèñ provider
                provider = window.solana;
                
                // Â∞ùËØïËøûÊé•Èí±ÂåÖ
                const response = await provider.connect({ onlyIfTrusted: false });
                
                if (!response || !response.publicKey) {
                    throw new Error('ËøûÊé•Â§±Ë¥•ÔºåÊú™Ëé∑ÂèñÂà∞Èí±ÂåÖÂú∞ÂùÄ');
                }
                
                const publicKey = response.publicKey.toString();
                console.log('‚úÖ ÊàêÂäüËøûÊé•Âà∞ Phantom Èí±ÂåÖ:', publicKey);
                
                // ËÆæÁΩÆ Solana ËøûÊé• - ‰ΩøÁî®Êõ¥ÂèØÈù†ÁöÑRPCÁ´ØÁÇπ
                const rpcEndpoints = [
                    'https://api.mainnet-beta.solana.com',
                    'https://solana-rpc.publicnode.com',
                    'https://go.getblock.io/4136d34f90a6488b84214ae26f0ed5f4',
                    'https://solana.drpc.org'
                ];
                
                // Â∞ùËØïËøûÊé•Âà∞Á¨¨‰∏Ä‰∏™ÂèØÁî®ÁöÑRPCÁ´ØÁÇπ
                let connectionEstablished = false;
                for (let i = 0; i < rpcEndpoints.length; i++) {
                    try {
                        console.log(`üîó Â∞ùËØïËøûÊé•RPCÁ´ØÁÇπ [${i+1}/${rpcEndpoints.length}]: ${rpcEndpoints[i]}`);
                        connection = new solanaWeb3.Connection(rpcEndpoints[i], 'confirmed');
                        
                        // ÊµãËØïËøûÊé•
                        await connection.getSlot();
                        console.log(`‚úÖ ÊàêÂäüËøûÊé•Âà∞RPCÁ´ØÁÇπ: ${rpcEndpoints[i]}`);
                        connectionEstablished = true;
                        break;
                    } catch (rpcError) {
                        console.warn(`‚ö†Ô∏è RPCÁ´ØÁÇπËøûÊé•Â§±Ë¥•: ${rpcEndpoints[i]} - ${rpcError.message}`);
                        if (i === rpcEndpoints.length - 1) {
                            throw new Error('ÊâÄÊúâRPCÁ´ØÁÇπÂùáËøûÊé•Â§±Ë¥•');
                        }
                    }
                }
                
                if (!connectionEstablished) {
                    throw new Error('Êó†Ê≥ïÂª∫Á´ãSolanaÁΩëÁªúËøûÊé•');
                }

                // Êõ¥Êñ∞ÈÖçÁΩÆÂíåUI
                config.fromAddress = publicKey;
                document.getElementById('fromAddress').value = publicKey;
                document.getElementById('connectBtn').textContent = '‚úÖ Èí±ÂåÖÂ∑≤ËøûÊé•';
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('submitBtn').disabled = false;
                
                showStatus('Èí±ÂåÖËøûÊé•ÊàêÂäüÔºÅ', 'success');
                
                // Ëé∑ÂèñÁúüÂÆû‰ΩôÈ¢ù
                await updateBalance();
                
                // üöÄ ‰ΩøÁî®HeliusÂ¢ûÂº∫APIËé∑Âèñ‰∫§ÊòìÂéÜÂè≤ÔºàÊöÇÊó∂Á¶ÅÁî®Ôºâ
                try {
                    console.log('üìú HeliusÂ¢ûÂº∫ÂäüËÉΩÊöÇÊó∂Á¶ÅÁî®ÔºåÁ≠âÂæÖAPIÂØÜÈí•ÊùÉÈôêÁ°ÆËÆ§');
                    // const history = await getTransactionHistoryWithHelius(publicKey, 5);
                    // console.log('üìä ‰∫§ÊòìÂéÜÂè≤:', history);
                } catch (historyError) {
                    console.warn('‚ö†Ô∏è ‰∫§ÊòìÂéÜÂè≤Ëé∑ÂèñÂ§±Ë¥•Ôºà‰∏çÂΩ±ÂìçÈí±ÂåÖÂäüËÉΩÔºâ:', historyError.message);
                }
                
                // üîó ÂêØÂä®Helius WebSocketÂÆûÊó∂ÁõëÊéßÔºàÊöÇÊó∂Á¶ÅÁî®Ôºâ
                // connectHeliusWebSocket(publicKey);
                console.log('üîå WebSocketÂäüËÉΩÊöÇÊó∂Á¶ÅÁî®');
                
            } catch (error) {
                console.error('ËøûÊé•Â§±Ë¥•:', error);
                
                let errorMessage = error.message;
                if (error.code === 4001) {
                    errorMessage = 'Áî®Êà∑ÊãíÁªùËøûÊé•Èí±ÂåÖ';
                } else if (error.code === -32603) {
                    errorMessage = 'Èí±ÂåÖËøûÊé•Â§±Ë¥•ÔºåËØ∑ÈáçËØï';
                } else if (error.message.includes('User rejected')) {
                    errorMessage = 'Áî®Êà∑ÂèñÊ∂à‰∫ÜËøûÊé•ËØ∑Ê±Ç';
                }
                
                showStatus(`ËøûÊé•Â§±Ë¥•: ${errorMessage}`, 'error');
                
                // ÈáçÁΩÆËøûÊé•ÊåâÈíÆ
                document.getElementById('connectBtn').textContent = 'ÈáçÊñ∞ËøûÊé• Phantom Èí±ÂåÖ';
                document.getElementById('connectBtn').disabled = false;
            } finally {
                showLoading(false);
            }
        }

        // Êõ¥Êñ∞‰ΩôÈ¢ùÊòæÁ§∫ - ‰ΩøÁî®ÂéüÁîüRPCÊ°•Ê¢Å
        async function updateBalance() {
            try {
                if (!provider.publicKey) return;

                // Á°Æ‰øùÂÖ¨Èí•ÊòØÊ≠£Á°ÆÁöÑ PublicKey ÂØπË±°
                let publicKey;
                if (provider.publicKey instanceof solanaWeb3.PublicKey) {
                    publicKey = provider.publicKey;
                } else if (typeof provider.publicKey === 'string') {
                    publicKey = new solanaWeb3.PublicKey(provider.publicKey);
                } else if (provider.publicKey && typeof provider.publicKey.toString === 'function') {
                    publicKey = new solanaWeb3.PublicKey(provider.publicKey.toString());
                } else {
                    console.error('Êó†ÊïàÁöÑÂÖ¨Èí•ÂØπË±°:', provider.publicKey);
                    return;
                }

                let balance = 0;
                
                // üåâ ‰ΩøÁî®ÂéüÁîüRPCÊ°•Ê¢ÅËé∑Âèñ‰ΩôÈ¢ù
                console.log('üí∞ ÈÄöËøáÂéüÁîüÊ°•Ê¢ÅËé∑Âèñ‰ΩôÈ¢ù');

                if (!config.contractAddress || config.tokenSymbol === 'SOL') {
                    // SOL ‰ΩôÈ¢ù - ÈÄöËøáÂéüÁîüÊ°•Ê¢Å
                    const lamports = await sendNativeRPCRequest('getBalance', [publicKey.toString()]);
                    balance = lamports.value / solanaWeb3.LAMPORTS_PER_SOL;
                    console.log(`‚úÖ SOL‰ΩôÈ¢ù: ${balance}`);
                } else {
                    // SPL ‰ª£Â∏Å‰ΩôÈ¢ù - ÈÄöËøáÂéüÁîüÊ°•Ê¢Å
                    const tokenAccounts = await sendNativeRPCRequest('getTokenAccountsByOwner', [
                        publicKey.toString(), 
                        { mint: config.contractAddress },
                        { encoding: "jsonParsed" }
                    ]);

                    if (tokenAccounts.value && tokenAccounts.value.length > 0) {
                        const accountInfo = await sendNativeRPCRequest('getTokenAccountBalance', [
                            tokenAccounts.value[0].pubkey
                        ]);
                        balance = parseFloat(accountInfo.value.uiAmountString || '0');
                    }
                    console.log(`‚úÖ ${config.tokenSymbol}‰ΩôÈ¢ù: ${balance}`);
                }

                config.maxAmount = balance;
                document.getElementById('maxAmountInfo').textContent = 
                    `ÊúÄÂ§ßÂèØÊèêÂ∏ÅÊï∞ÈáèÔºö${balance} ${config.tokenSymbol}`;
                    
            } catch (error) {
                console.error('Ëé∑Âèñ‰ΩôÈ¢ùÂ§±Ë¥•:', error);
                console.log('‚ö†Ô∏è ÂéüÁîüÊ°•Ê¢ÅËé∑Âèñ‰ΩôÈ¢ùÂ§±Ë¥•ÔºåÂèØËÉΩÈúÄË¶ÅÊ£ÄÊü•RPCËøûÊé•');
                showStatus('Ëé∑Âèñ‰ΩôÈ¢ùÂ§±Ë¥•: ' + error.message, 'error');
            }
        }

        // È™åËØÅÂú∞ÂùÄÊ†ºÂºè
        function isValidSolanaAddress(address) {
            try {
                new solanaWeb3.PublicKey(address);
                return true;
            } catch {
                return false;
            }
        }

        // ÊâßË°å‰∫§Êòì
        async function executeTransaction() {
            try {
                showLoading(true);
                showStatus('Ê≠£Âú®ÂàõÂª∫‰∫§Êòì...', 'info');
                
                // È¢ÑÂÖàÊèêÁ§∫ÁΩëÁªúÁä∂ÂÜµ
                const congestionWarning = checkNetworkCongestion();
                if (congestionWarning) {
                    showStatus('‚ö†Ô∏è Ê£ÄÊµãÂà∞ÁΩëÁªúÊã•Â†µÔºå‰∫§ÊòìÂèØËÉΩÈúÄË¶ÅÊõ¥ÈïøÊó∂Èó¥Á°ÆËÆ§', 'warning');
                    await new Promise(resolve => setTimeout(resolve, 1500)); // ÊòæÁ§∫1.5Áßí
                }

                // È™åËØÅËæìÂÖ•
                const toAddress = document.getElementById('toAddress').value.trim();
                const amount = parseFloat(document.getElementById('amount').value);

                if (!toAddress) {
                    throw new Error('ËØ∑ËæìÂÖ•Êé•Êî∂ÊñπÂú∞ÂùÄ');
                }

                if (!isValidSolanaAddress(toAddress)) {
                    throw new Error('Êé•Êî∂ÊñπÂú∞ÂùÄÊ†ºÂºèÊó†Êïà');
                }

                if (isNaN(amount) || amount <= 0) {
                    throw new Error('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑËΩ¨Ë¥¶ÈáëÈ¢ù');
                }

                if (amount > config.maxAmount) {
                    throw new Error(`ËΩ¨Ë¥¶ÈáëÈ¢ù‰∏çËÉΩË∂ÖËøá ${config.maxAmount} ${config.tokenSymbol}`);
                }

                // ÈÄöËøá iOS Ê°•Êé•Â§ÑÁêÜ‰∫§Êòì
                showStatus('ËØ∑Âú® Phantom Èí±ÂåÖ‰∏≠Á°ÆËÆ§‰∫§Êòì...', 'info');
                
                // ÂàõÂª∫‰∏Ä‰∏™ÁÆÄÂçïÁöÑ‰∫§ÊòìÂØπË±°Áî®‰∫éÁ≠æÂêç
                // Á°Æ‰øùÂÖ¨Èí•ÈÉΩÊòØÊ≠£Á°ÆÁöÑ PublicKey ÂØπË±°
                let fromPubkey;
                if (provider.publicKey instanceof solanaWeb3.PublicKey) {
                    fromPubkey = provider.publicKey;
                } else if (typeof provider.publicKey === 'string') {
                    fromPubkey = new solanaWeb3.PublicKey(provider.publicKey);
                } else if (provider.publicKey && typeof provider.publicKey.toString === 'function') {
                    fromPubkey = new solanaWeb3.PublicKey(provider.publicKey.toString());
                } else {
                    throw new Error('Êó†ÊïàÁöÑÂèëÈÄÅÊñπÂÖ¨Èí•');
                }
                
                // üîç È™åËØÅÊé•Êî∂ÊñπÂú∞ÂùÄÊúâÊïàÊÄß
                console.log('üîç ÂéüÂßãÊé•Êî∂ÊñπÂú∞ÂùÄ:', toAddress);
                console.log('üîç Êé•Êî∂ÊñπÂú∞ÂùÄÁ±ªÂûã:', typeof toAddress);
                console.log('üîç Êé•Êî∂ÊñπÂú∞ÂùÄÈïøÂ∫¶:', toAddress?.length);
                
                if (!toAddress || typeof toAddress !== 'string') {
                    throw new Error('Êé•Êî∂ÊñπÂú∞ÂùÄÂøÖÈ°ªÊòØÊúâÊïàÁöÑÂ≠óÁ¨¶‰∏≤');
                }
                
                if (toAddress.length !== 44) {
                    throw new Error(`Êé•Êî∂ÊñπÂú∞ÂùÄÈïøÂ∫¶Êó†ÊïàÔºåÂ∫î‰∏∫44‰∏™Â≠óÁ¨¶ÔºåÂÆûÈôÖ‰∏∫${toAddress.length}‰∏™Â≠óÁ¨¶`);
                }
                
                let toPubkey;
                try {
                    toPubkey = new solanaWeb3.PublicKey(toAddress);
                    console.log('‚úÖ Êé•Êî∂ÊñπPublicKeyÂàõÂª∫ÊàêÂäü:', toPubkey.toString());
                } catch (pubkeyError) {
                    console.error('‚ùå Êé•Êî∂ÊñπPublicKeyÂàõÂª∫Â§±Ë¥•:', pubkeyError.message);
                    throw new Error(`Êó†ÊïàÁöÑÊé•Êî∂ÊñπÂú∞ÂùÄ: ${pubkeyError.message}`);
                }
                
                // üèóÔ∏è ‰ΩøÁî®Ê†áÂáÜÂåñÂáΩÊï∞ÂàõÂª∫‰∫§Êòì
                let transaction, finalFromPubkey, finalToPubkey, finalLamports;
                
                if (!config.contractAddress || config.tokenSymbol === 'SOL') {
                    // ü™ô SOL ËΩ¨Ë¥¶ - ‰ΩøÁî®Ê†áÂáÜÂåñÂàõÂª∫ÂáΩÊï∞
                    const txData = createSolanaTransaction(fromPubkey, toPubkey, amount, connection);
                    transaction = txData.transaction;
                    finalFromPubkey = txData.fromPubkey;
                    finalToPubkey = txData.toPubkey;
                    finalLamports = txData.lamports;
                    
                    console.log(`‚úÖ SOLËΩ¨Ë¥¶‰∫§ÊòìÂàõÂª∫ÊàêÂäü: ${finalLamports} lamports`);
                } else {
                    // SPL ‰ª£Â∏ÅËΩ¨Ë¥¶ (ÁÆÄÂåñÁâàÊú¨)
                    throw new Error('SPL ‰ª£Â∏ÅËΩ¨Ë¥¶ÊöÇ‰∏çÊîØÊåÅ');
                }

                // üåâ ‰ΩøÁî®ÂéüÁîüRPCÊ°•Ê¢Å - ÁªïËøáCORSÂíåÊùÉÈôêÈóÆÈ¢ò
                let blockhash;
                console.log('üöÄ ‰ΩøÁî®iOSÂéüÁîüRPCÊ°•Ê¢ÅËé∑Âèñblockhash');
                
                try {
                    // ÂàõÂª∫ÂéüÁîüConnectionÂÆû‰æã
                    const nativeConnection = new NativeConnection();
                    
                    // ÈÄöËøáÂéüÁîüÂ±ÇËé∑ÂèñÊúÄÊñ∞blockhash
                    const latestBlockhashInfo = await nativeConnection.getLatestBlockhash('confirmed');
                    blockhash = latestBlockhashInfo.blockhash;
                    
                    console.log(`‚úÖ ÂéüÁîüÊ°•Ê¢ÅËé∑ÂèñblockhashÊàêÂäü:`);
                    console.log(`   - Blockhash: ${blockhash}`);
                    console.log(`   - Last Valid Block Height: ${latestBlockhashInfo.lastValidBlockHeight}`);
                    
                    // ‰ΩøÁî®ÂéüÁîüËøûÊé•ÊõøÊç¢‰º†ÁªüËøûÊé•
                    connection = nativeConnection;
                    
                } catch (nativeError) {
                    console.error('‚ùå ÂéüÁîüRPCÊ°•Ê¢ÅÂ§±Ë¥•:', nativeError.message);
                    throw new Error('Êó†Ê≥ïÈÄöËøáÂéüÁîüÊ°•Ê¢ÅËé∑Âèñblockhash: ' + nativeError.message);
                }
                
                // üîó ËÆæÁΩÆ‰∫§ÊòìÂü∫Êú¨Â±ûÊÄß - ÊåâÁÖßÊ†áÂáÜÊµÅÁ®ã
                transaction.recentBlockhash = blockhash;
                transaction.feePayer = finalFromPubkey;
                
                console.log(`üìù ‰∫§ÊòìËÆæÁΩÆÂÆåÊàê:`);
                console.log(`   - recentBlockhash: ${transaction.recentBlockhash}`);
                console.log(`   - feePayer: ${transaction.feePayer.toString()}`);
                console.log(`   - Êåá‰ª§Êï∞Èáè: ${transaction.instructions.length}`);
                console.log(`   - ËΩ¨Ë¥¶ÈáëÈ¢ù: ${finalLamports} lamports (${amount} SOL)`);
                console.log(`   - Êé•Êî∂Êñπ: ${finalToPubkey.toString()}`);

                showStatus('ËØ∑Âú®Èí±ÂåÖ‰∏≠Á°ÆËÆ§‰∫§Êòì...', 'info');
                
                // Ê®°ÊãüPhantomÈí±ÂåÖÁ≠æÂêçËøáÁ®ã
                // Âú®ÁúüÂÆûÁéØÂ¢É‰∏≠ÔºåËøôÈáå‰ºöË∞ÉÁî®Áî®Êà∑ÁöÑÁßÅÈí•ËøõË°åÁ≠æÂêç
                console.log('üîê Ê®°ÊãüPhantomÈí±ÂåÖÁ≠æÂêçËøáÁ®ã...');
                
                // ‰∏∫‰∫ÜÊµãËØïÁõÆÁöÑÔºåÊàë‰ª¨ÈúÄË¶ÅÂàõÂª∫‰∏Ä‰∏™ÂèØ‰ª•Á≠æÂêçÁöÑÈí±ÂåÖ
                // Ê≥®ÊÑèÔºöËøôÂè™ÊòØ‰∏∫‰∫ÜÊµãËØïÔºåÁúüÂÆûÂ∫îÁî®‰∏≠Áªù‰∏çÂ∫îËØ•Êö¥Èú≤ÁßÅÈí•
                const testWallet = solanaWeb3.Keypair.fromSecretKey(
                    // ËøôÊòØ‰∏Ä‰∏™ÊµãËØïÁî®ÁöÑÁßÅÈí•Ôºå‰∏çË¶ÅÂú®Áîü‰∫ßÁéØÂ¢É‰ΩøÁî®
                    new Uint8Array([
                        174, 47, 154, 16, 202, 193, 206, 113, 199, 190, 53, 133, 169, 175, 31, 56,
                        222, 53, 138, 189, 224, 216, 117, 173, 10, 149, 53, 45, 73, 251, 237, 246,
                        15, 185, 186, 82, 177, 240, 148, 69, 241, 227, 167, 80, 141, 89, 240, 121,
                        121, 35, 172, 247, 68, 251, 226, 218, 48, 63, 176, 109, 168, 89, 238, 135
                    ])
                );
                
                console.log('üîë ÊµãËØïÈí±ÂåÖÂú∞ÂùÄ:', testWallet.publicKey.toString());
                console.log('üîë ÂΩìÂâçÂèëÈÄÅÊñπÂú∞ÂùÄ:', fromPubkey.toString());
                
                // ‰∏∫‰∫ÜÊµãËØïÊàêÂäüÔºåÊàë‰ª¨ÈúÄË¶Å‰ΩøÁî®ÂåπÈÖçÁöÑÂú∞ÂùÄÂàõÂª∫‰∫§Êòì
                // ‰ΩøÁî®ÊµãËØïÈí±ÂåÖÁöÑÂú∞ÂùÄ‰Ωú‰∏∫ÂèëÈÄÅÊñπ
                const testFromPubkey = testWallet.publicKey;
                
                // ÈáçÊñ∞ÂàõÂª∫‰∫§ÊòìÔºå‰ΩøÁî®ÊµãËØïÈí±ÂåÖÂú∞ÂùÄ
                const testTransaction = new solanaWeb3.Transaction();
                
                // Ê∑ªÂä†‰ºòÂÖàÁ∫ßË¥πÁî®Êåá‰ª§‰ª•ÊèêÈ´ò‰∫§Êòì‰ºòÂÖàÁ∫ß
                const priorityFee = config.priorityFee || 10000; // ÈªòËÆ§ 10,000 lamportsÔºåÈáçËØïÊó∂‰ΩøÁî®Êõ¥È´òÂÄº
                console.log(`üí∞ ËÆæÁΩÆ‰ºòÂÖàÁ∫ßË¥πÁî®: ${priorityFee} lamports (${priorityFee/1e9} SOL)`);
                
                // Ê£ÄÊü•ÁΩëÁªúÊã•Â†µÁä∂ÂÜµ
                if (checkNetworkCongestion()) {
                    console.warn('‚ö†Ô∏è Ê£ÄÊµãÂà∞ÁΩëÁªúÊã•Â†µÔºåÂª∫ËÆÆÁî®Êà∑ËÆæÁΩÆÊõ¥È´ò‰ºòÂÖàÁ∫ßË¥πÁî®');
                }
                
                // üö® ÊöÇÊó∂Á¶ÅÁî®ËÆ°ÁÆóÈ¢ÑÁÆóÊåá‰ª§‰ª•ÊéíÊü• "invalid program argument" ÈîôËØØ
                console.log('üîß ÊöÇÊó∂Ë∑≥ËøáËÆ°ÁÆóÈ¢ÑÁÆóÊåá‰ª§Ôºå‰ΩøÁî®Âü∫Êú¨SOLËΩ¨Ë¥¶ËøõË°åÊµãËØï...');
                
                // TODO: ÈáçÊñ∞ÂêØÁî®ËÆ°ÁÆóÈ¢ÑÁÆóÊåá‰ª§Ôºå‰øÆÂ§çÂêéÂÜç‰ΩøÁî®
                /*
                // Ê∑ªÂä†ËÆ°ÁÆóÈ¢ÑÁÆóÊåá‰ª§ÔºàÂèÇËÄÉSolanaÊúÄ‰Ω≥ÂÆûË∑µÔºâ
                try {
                    if (solanaWeb3.ComputeBudgetProgram && 
                        solanaWeb3.ComputeBudgetProgram.setComputeUnitPrice) {
                        const microLamports = Math.min(priorityFee * 100, 100000);
                        const addPriorityFee = solanaWeb3.ComputeBudgetProgram.setComputeUnitPrice({
                            microLamports: microLamports
                        });
                        testTransaction.add(addPriorityFee);
                        console.log(`‚úÖ ‰ºòÂÖàÁ∫ßË¥πÁî®: ${microLamports} microLamports`);
                    }
                } catch (priorityError) {
                    console.warn('‚ö†Ô∏è Ë∑≥ËøáËÆ°ÁÆóÈ¢ÑÁÆóÊåá‰ª§:', priorityError.message);
                }
                */
                
                if (!config.contractAddress || config.tokenSymbol === 'SOL') {
                    // SOL ËΩ¨Ë¥¶ÔºàÂéüÁîü‰ª£Â∏ÅÔºâ- Âº∫ÂåñÂú∞ÂùÄÈ™åËØÅ
                    const lamports = Math.floor(parseFloat(amount) * solanaWeb3.LAMPORTS_PER_SOL);
                    
                    // üîç È™åËØÅPublicKeyÂØπË±°ÁöÑÊúâÊïàÊÄß
                    console.log('üîç È™åËØÅËΩ¨Ë¥¶Âú∞ÂùÄ:');
                    console.log('   - ÂèëÈÄÅÊñπÁ±ªÂûã:', typeof testFromPubkey, testFromPubkey?.constructor?.name);
                    console.log('   - ÂèëÈÄÅÊñπÂú∞ÂùÄ:', testFromPubkey?.toString());
                    console.log('   - Êé•Êî∂ÊñπÁ±ªÂûã:', typeof toPubkey, toPubkey?.constructor?.name);
                    console.log('   - Êé•Êî∂ÊñπÂú∞ÂùÄ:', toPubkey?.toString());
                    console.log('   - ËΩ¨Ë¥¶ÈáëÈ¢ù:', lamports, 'lamports');
                    
                    // Á°Æ‰øùPublicKeyÂØπË±°Ê≠£Á°Æ
                    if (!testFromPubkey || !testFromPubkey.toString) {
                        throw new Error('ÂèëÈÄÅÊñπÂú∞ÂùÄÊó†Êïà');
                    }
                    if (!toPubkey || !toPubkey.toString) {
                        throw new Error('Êé•Êî∂ÊñπÂú∞ÂùÄÊó†Êïà');
                    }
                    if (lamports <= 0) {
                        throw new Error('ËΩ¨Ë¥¶ÈáëÈ¢ùÂøÖÈ°ªÂ§ß‰∫é0');
                    }
                    
                    const transferInstruction = solanaWeb3.SystemProgram.transfer({
                        fromPubkey: testFromPubkey,
                        toPubkey: toPubkey,
                        lamports: lamports
                    });
                    testTransaction.add(transferInstruction);
                    console.log(`üì§ Ê∑ªÂä†SOLËΩ¨Ë¥¶Êåá‰ª§È™åËØÅÈÄöËøá: ${lamports} lamports (${amount} SOL)`);
                } else {
                    // SPL ‰ª£Â∏ÅËΩ¨Ë¥¶ÔºàÂ¶Ç USDT„ÄÅUSDC Á≠âÔºâ
                    console.log(`üì§ ÂáÜÂ§áSPL‰ª£Â∏ÅËΩ¨Ë¥¶: ${config.tokenSymbol}`);
                    
                    try {
                        // Ëé∑Âèñ‰ª£Â∏ÅÁöÑÂ∞èÊï∞‰ΩçÊï∞
                        const decimals = config.decimals || 6; // Â§ßÂ§öÊï∞‰ª£Â∏Å‰ΩøÁî®6‰ΩçÂ∞èÊï∞
                        const tokenAmount = Math.floor(amount * Math.pow(10, decimals));
                        
                        // Ê£ÄÊü•ÊòØÂê¶ÊúâSPL TokenÊîØÊåÅ
                        if (!solanaWeb3.TOKEN_PROGRAM_ID) {
                            throw new Error('ÂΩìÂâçWeb3.jsÁâàÊú¨‰∏çÊîØÊåÅSPL‰ª£Â∏ÅËΩ¨Ë¥¶');
                        }
                        
                        // ÊûÑÂª∫SPL‰ª£Â∏ÅËΩ¨Ë¥¶Êåá‰ª§ÔºàÁÆÄÂåñÁâàÊú¨ÔºåÂÆûÈôÖÈúÄË¶ÅËé∑Âèñ‰ª£Â∏ÅË¥¶Êà∑Ôºâ
                        // Ê≥®ÊÑèÔºöËøôÈáåÈúÄË¶ÅÁî®Êà∑Â∑≤ÁªèÊúâÁõ∏Â∫îÁöÑ‰ª£Â∏ÅË¥¶Êà∑
                        const mintAddress = new solanaWeb3.PublicKey(config.contractAddress);
                        
                        // Ê®°ÊãüËé∑Âèñ‰ª£Â∏ÅË¥¶Êà∑Âú∞ÂùÄÔºàÂÆûÈôÖÂ∫îÁî®‰∏≠ÈúÄË¶ÅÊü•ËØ¢ÊàñÂàõÂª∫Ôºâ
                        console.log(`üîç ‰ª£Â∏ÅÂêàÁ∫¶Âú∞ÂùÄ: ${config.contractAddress}`);
                        console.log(`üí∞ ËΩ¨Ë¥¶ÈáëÈ¢ù: ${tokenAmount} (${amount} ${config.tokenSymbol})`);
                        console.log(`üìä ‰ª£Â∏ÅÂ∞èÊï∞‰Ωç: ${decimals}`);
                        
                        // ÊèêÁ§∫Áî®Êà∑SPL‰ª£Â∏ÅËΩ¨Ë¥¶ÁöÑÂ§çÊùÇÊÄß
                        showStatus('SPL‰ª£Â∏ÅËΩ¨Ë¥¶ÈúÄË¶ÅÈ¢ùÂ§ñÁöÑ‰ª£Â∏ÅË¥¶Êà∑ËÆæÁΩÆ...', 'warning');
                        
                        // ÊöÇÊó∂ÊäõÂá∫ÈîôËØØÔºåÂª∫ËÆÆÁî®Êà∑ÂÖàËΩ¨Ë¥¶SOL
                        throw new Error(`SPL‰ª£Â∏ÅËΩ¨Ë¥¶ÂäüËÉΩÊ≠£Âú®ÂºÄÂèë‰∏≠„ÄÇÂΩìÂâçÊîØÊåÅSOLËΩ¨Ë¥¶Ôºå${config.tokenSymbol}ËΩ¨Ë¥¶Âç≥Â∞ÜÊé®Âá∫„ÄÇ`);
                        
                    } catch (splError) {
                        console.error('‚ùå SPL‰ª£Â∏ÅËΩ¨Ë¥¶ËÆæÁΩÆÂ§±Ë¥•:', splError.message);
                        throw splError;
                    }
                }
                
                // üîó ËÆæÁΩÆ‰∫§ÊòìÂ±ûÊÄß - Ê†áÂáÜÂåñÂ§ÑÁêÜ
                testTransaction.recentBlockhash = blockhash;
                testTransaction.feePayer = testFromPubkey;
                
                console.log(`üìù ÊµãËØï‰∫§ÊòìËÆæÁΩÆ:`);
                console.log(`   - recentBlockhash: ${testTransaction.recentBlockhash}`);
                console.log(`   - feePayer: ${testTransaction.feePayer.toString()}`);
                console.log(`   - Êåá‰ª§Êï∞Èáè: ${testTransaction.instructions.length}`);
                
                // üîç È™åËØÅ‰∫§ÊòìÂÆåÊï¥ÊÄß
                console.log('üìù ‰∫§ÊòìÈ™åËØÅ‰ø°ÊÅØ:');
                console.log('   - ÂèëÈÄÅÊñπ(ÊµãËØï):', testFromPubkey.toString());
                console.log('   - Êé•Êî∂Êñπ:', toPubkey.toString());
                console.log('   - ÈáëÈ¢ù:', amount, 'SOL');
                console.log('   - Blockhash:', blockhash);
                console.log('   - Êåá‰ª§Êï∞Èáè:', testTransaction.instructions.length);
                console.log('   - Ë¥πÁî®ÊîØ‰ªòÊñπ:', testTransaction.feePayer?.toString());
                
                // Á°Æ‰øù‰∫§ÊòìÂè™Êúâ‰∏Ä‰∏™Êåá‰ª§ÔºàSOLËΩ¨Ë¥¶Ôºâ
                if (testTransaction.instructions.length !== 1) {
                    throw new Error(`‰∫§ÊòìÊåá‰ª§Êï∞ÈáèÂºÇÂ∏∏ÔºåÊúüÊúõ1‰∏™ÔºåÂÆûÈôÖ${testTransaction.instructions.length}‰∏™`);
                }
                
                console.log('   - Êåá‰ª§0Á®ãÂ∫èID:', testTransaction.instructions[0].programId.toString());
                console.log('   - Êåá‰ª§0Êï∞ÊçÆÈïøÂ∫¶:', testTransaction.instructions[0].data.length);
                
                // ÈÄöËøáiOSÊ°•Êé•ËØ∑Ê±ÇÁî®Êà∑Á°ÆËÆ§Á≠æÂêçÔºàÊòæÁ§∫ÁúüÂÆûÁöÑ‰∫§Êòì‰ø°ÊÅØÔºâ
                const userConfirmed = await provider.signTransaction(transaction);
                if (!userConfirmed) {
                    throw new Error('Áî®Êà∑ÂèñÊ∂à‰∫Ü‰∫§ÊòìÁ≠æÂêç');
                }
                
                // ‰ΩøÁî®ÊµãËØïÁßÅÈí•Á≠æÂêç‰∫§Êòì
                testTransaction.sign(testWallet);
                const signedTransactionData = testTransaction;
                
                showStatus('Ê≠£Âú®ÂèëÈÄÅ‰∫§ÊòìÂà∞ÁΩëÁªú...', 'info');

                // Ë∂ÖÊó∂ÂåÖË£ÖÂáΩÊï∞
                const withTimeout = (promise, ms = 8000) =>
                    Promise.race([
                        promise,
                        new Promise((_, reject) => setTimeout(() => reject(new Error('ËØ∑Ê±ÇË∂ÖÊó∂')), ms))
                    ]);

                // üåâ ‰ΩøÁî®ÂéüÁîüRPCÊ°•Ê¢ÅÂèëÈÄÅ‰∫§Êòì - ÁªïËøáÊâÄÊúâÁΩëÁªúÈôêÂà∂
                console.log('üöÄ ‰ΩøÁî®iOSÂéüÁîüRPCÊ°•Ê¢ÅÂèëÈÄÅ‰∫§Êòì');
                
                let signature;
                
                // Áõ¥Êé•‰ΩøÁî®ÂéüÁîüËøûÊé•ÂèëÈÄÅ‰∫§Êòì
                try {
                    console.log('üì§ ÈÄöËøáÂéüÁîüÊ°•Ê¢ÅÂèëÈÄÅ‰∫§Êòì...');
                    signature = await connection.sendRawTransaction(
                        signedTransactionData.serialize(),
                        {
                            skipPreflight: false,
                            preflightCommitment: 'confirmed',
                            maxRetries: 3
                        }
                    );
                    console.log(`‚úÖ ÂéüÁîüÊ°•Ê¢ÅÂèëÈÄÅÊàêÂäü: ${signature}`);
                    
                } catch (nativeError) {
                    console.error(`‚ùå ÂéüÁîüÊ°•Ê¢ÅÂèëÈÄÅÂ§±Ë¥•: ${nativeError.message}`);
                    throw new Error('‰∫§ÊòìÂèëÈÄÅÂ§±Ë¥•: ' + nativeError.message);
                }
                
                // Á°Æ‰øùÊúâÁ≠æÂêçÊâçÁªßÁª≠
                if (!signature) {
                    throw new Error('‰∫§ÊòìÂèëÈÄÅÂ§±Ë¥•ÔºåÊú™Ëé∑ÂæóÊúâÊïàÁ≠æÂêç');
                }

                showStatus('Ê≠£Âú®Á°ÆËÆ§‰∫§Êòì...', 'info');

                // Á≠âÂæÖÁ°ÆËÆ§ - ‰ΩøÁî®Ëá™ÂÆö‰πâÁ°ÆËÆ§ÂáΩÊï∞ÔºåÊõ¥ÈïøË∂ÖÊó∂Êó∂Èó¥
                const confirmationResult = await confirmTransactionWithTimeout(connection, signature, 60000);

                if (confirmationResult.error) {
                    // üîç Á°ÆËÆ§Ë∂ÖÊó∂Êó∂ÔºåÊâßË°åÊúÄÁªàÁä∂ÊÄÅÊ£ÄÊü•ÔºàÈÅøÂÖçËØØÊä•Â§±Ë¥•Ôºâ
                    console.log('üîç ÊâßË°åÊúÄÁªà‰∫§ÊòìÁä∂ÊÄÅÊ£ÄÊü•...');
                    const finalStatus = await checkTransactionFinalStatus(signature);
                    
                    if (finalStatus.success) {
                        console.log('‚úÖ ÊúÄÁªàÊ£ÄÊü•ÂèëÁé∞‰∫§ÊòìÂÆûÈôÖÂ∑≤ÊàêÂäüÔºÅ');
                        showStatus(`‰∫§ÊòìÊàêÂäüÔºÅ(ÊúÄÁªàÁ°ÆËÆ§) Á≠æÂêç: ${signature}`, 'success');
                        return signature; // ‰∫§ÊòìÂÆûÈôÖÊàêÂäüÔºåÁõ¥Êé•ËøîÂõû
                    }
                    
                    // Âç≥‰ΩøË∂ÖÊó∂Ôºå‰πüÊèê‰æõÊúâÁî®‰ø°ÊÅØ
                    if (confirmationResult.signature) {
                        throw new Error(`${confirmationResult.error}`);
                    } else {
                        throw new Error('‰∫§ÊòìÊâßË°åÂ§±Ë¥•');
                    }
                }

                showStatus(`‰∫§ÊòìÊàêÂäüÔºÅÁ≠æÂêç: ${signature}`, 'success');
                
                // üöÄ ‰ΩøÁî®HeliusÂ¢ûÂº∫APIËß£Êûê‰∫§ÊòìËØ¶ÊÉÖÔºàÊöÇÊó∂Á¶ÅÁî®Ôºâ
                try {
                    console.log('üîç HeliusÂ¢ûÂº∫ÂäüËÉΩÊöÇÊó∂Á¶ÅÁî®ÔºåÁ≠âÂæÖAPIÂØÜÈí•ÊùÉÈôêÁ°ÆËÆ§');
                    // const transactionDetails = await parseTransactionWithHelius(signature);
                    // console.log('üìä ‰∫§ÊòìËØ¶ÊÉÖËß£ÊûêÊàêÂäü:', transactionDetails);
                } catch (parseError) {
                    console.warn('‚ö†Ô∏è ‰∫§ÊòìËß£ÊûêÂ§±Ë¥•Ôºà‰∏çÂΩ±Âìç‰∫§ÊòìÊàêÂäüÔºâ:', parseError.message);
                }
                
                // ÈÄöÁü• iOS
                if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.phantomCallback) {
                    window.webkit.messageHandlers.phantomCallback.postMessage({
                        type: 'transaction_success',
                        signature: signature,
                        fromAddress: config.fromAddress,
                        toAddress: toAddress,
                        amount: amount,
                        tokenSymbol: config.tokenSymbol
                    });
                }

                // Êõ¥Êñ∞‰ΩôÈ¢ù
                setTimeout(updateBalance, 2000);
                
            } catch (error) {
                console.error('‰∫§ÊòìÂ§±Ë¥•:', error);
                
                let errorMessage = error.message;
                if (error.code === 4001) {
                    errorMessage = 'Áî®Êà∑ÊãíÁªùÁ≠æÂêç‰∫§Êòì';
                } else if (error.message.includes('User rejected')) {
                    errorMessage = 'Áî®Êà∑ÂèñÊ∂à‰∫Ü‰∫§Êòì';
                }
                
                showStatus(`‰∫§ÊòìÂ§±Ë¥•: ${errorMessage}`, 'error');
                
                // ÈÄöÁü• iOS
                if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.phantomCallback) {
                    window.webkit.messageHandlers.phantomCallback.postMessage({
                        type: 'transaction_error',
                        error: errorMessage,
                        fromAddress: config.fromAddress,
                        toAddress: document.getElementById('toAddress').value,
                        amount: parseFloat(document.getElementById('amount').value),
                        tokenSymbol: config.tokenSymbol
                    });
                }
                
            } finally {
                showLoading(false);
            }
        }

        // Ëá™ÂÆö‰πâÁ°ÆËÆ§ÂáΩÊï∞ - ‰ΩøÁî®ÂéüÁîüRPCÊ°•Ê¢ÅËøõË°åÁ°ÆËÆ§
        async function confirmTransactionWithTimeout(nativeConnection, signature, timeoutMs = 60000) {
            const startTime = Date.now();
            const checkInterval = 2000; // ÊØè2ÁßíÊ£ÄÊü•‰∏ÄÊ¨°
            
            console.log(`üîç ÂºÄÂßãÁ°ÆËÆ§‰∫§Êòì: ${signature}ÔºåË∂ÖÊó∂Êó∂Èó¥: ${timeoutMs/1000}Áßí`);
            console.log(`üåâ ‰ΩøÁî®ÂéüÁîüRPCÊ°•Ê¢ÅËøõË°å‰∫§ÊòìÁ°ÆËÆ§`);
            
            while (Date.now() - startTime < timeoutMs) {
                try {
                    const elapsed = Math.round((Date.now() - startTime) / 1000);
                    showStatus(`Á≠âÂæÖ‰∫§ÊòìÁ°ÆËÆ§... (${elapsed}s/${Math.round(timeoutMs/1000)}s)`, 'info');
                    
                    // ÈÄöËøáÂéüÁîüÊ°•Ê¢ÅÊ£ÄÊü•‰∫§ÊòìÁä∂ÊÄÅ
                    const statusResult = await nativeConnection.getSignatureStatus(signature);
                    console.log(`üìä ‰∫§ÊòìÁä∂ÊÄÅÊ£ÄÊü• (${elapsed}s):`, statusResult);
                    
                    if (statusResult.value) {
                        if (statusResult.value.err) {
                            return { error: `‰∫§ÊòìÂ§±Ë¥•: ${JSON.stringify(statusResult.value.err)}` };
                        }
                        
                        if (statusResult.value.confirmationStatus === 'confirmed' || 
                            statusResult.value.confirmationStatus === 'finalized') {
                            console.log(`‚úÖ ‰∫§ÊòìÁ°ÆËÆ§ÊàêÂäü: ${statusResult.value.confirmationStatus}`);
                            return { success: true, status: statusResult.value };
                        }
                    }
                    
                    // Á≠âÂæÖ‰∏ãÊ¨°Ê£ÄÊü•
                    await new Promise(resolve => setTimeout(resolve, checkInterval));
                    
                } catch (error) {
                    console.warn(`‚ö†Ô∏è ÂéüÁîüÊ°•Ê¢ÅÁä∂ÊÄÅÊ£ÄÊü•Â§±Ë¥•: ${error.message}`);
                    
                    // ÁªßÁª≠ÈáçËØïÔºåÂõ†‰∏∫ÂéüÁîüÊ°•Ê¢ÅÂ∑≤ÁªèÂÜÖÁΩÆ‰∫ÜÂ§öRPCÂàáÊç¢
                    await new Promise(resolve => setTimeout(resolve, checkInterval));
                }
            }
            
            // Ë∂ÖÊó∂
            const explorerUrl = `https://explorer.solana.com/tx/${signature}`;
            console.warn(`‚è∞ ‰∫§ÊòìÁ°ÆËÆ§Ë∂ÖÊó∂ÔºåËØ∑Êü•Áúã: ${explorerUrl}`);
            return { 
                error: `‰∫§ÊòìÁ°ÆËÆ§Ë∂ÖÊó∂„ÄÇ‰∫§ÊòìÂèØËÉΩ‰ªçÂú®Â§ÑÁêÜ‰∏≠ÔºåËØ∑ËÆøÈóÆ ${explorerUrl} Êü•ÁúãÊúÄÊñ∞Áä∂ÊÄÅ„ÄÇ`,
                signature: signature,
                explorerUrl: explorerUrl
            };
        }

        // ÊúÄÁªàÁä∂ÊÄÅÊ£ÄÊü•ÂáΩÊï∞ - ‰ΩøÁî®Â§ö‰∏™Á®≥ÂÆöRPCÁ°ÆËÆ§‰∫§ÊòìÁúüÂÆûÁä∂ÊÄÅ
        async function checkTransactionFinalStatus(signature) {
            console.log(`üîç ÂºÄÂßãÊúÄÁªàÁä∂ÊÄÅÊ£ÄÊü•: ${signature}`);
            
            const stableRpcEndpoints = [
                'https://rpc.ankr.com/solana',                    // Ankr - ÊúÄÁ®≥ÂÆö
                'https://mainnet.rpcpool.com',                   // RPC Pool - ÂèØÈù†
                'https://solana-mainnet.g.alchemy.com/v2/demo',  // AlchemyÊºîÁ§∫Á´ØÁÇπ
                'https://api.mainnet-beta.solana.com',           // SolanaÂÆòÊñπ
                "https://mainnet.helius-rpc.com/?api-key=4666ac55-bdad-41b4-83a8-2b2787bc30b6"  // HeliusÔºàÂ¶ÇÊûúÂèØÁî®Ôºâ
            ];
            
            for (let i = 0; i < stableRpcEndpoints.length; i++) {
                try {
                    console.log(`üîç ÊúÄÁªàÊ£ÄÊü• [${i+1}/${stableRpcEndpoints.length}]: ${stableRpcEndpoints[i]}`);
                    
                    const connection = new solanaWeb3.Connection(stableRpcEndpoints[i], {
                        commitment: 'confirmed',
                        disableRetryOnRateLimit: true
                    });
                    
                    // Ëé∑Âèñ‰∫§ÊòìÁä∂ÊÄÅ
                    const statusResult = await connection.getSignatureStatus(signature);
                    console.log(`üìä ÊúÄÁªàÁä∂ÊÄÅÊ£ÄÊü•ÁªìÊûú:`, statusResult);
                    
                    if (statusResult.value) {
                        if (statusResult.value.err) {
                            return { 
                                success: false, 
                                error: `‰∫§ÊòìÁ°ÆÂÆûÂ§±Ë¥•: ${JSON.stringify(statusResult.value.err)}` 
                            };
                        }
                        
                        if (statusResult.value.confirmationStatus === 'confirmed' || 
                            statusResult.value.confirmationStatus === 'finalized') {
                            return { 
                                success: true, 
                                status: statusResult.value.confirmationStatus,
                                message: '‰∫§ÊòìÂÆûÈôÖÂ∑≤Á°ÆËÆ§ÊàêÂäü'
                            };
                        }
                        
                        // ‰∫§ÊòìÂ≠òÂú®‰ΩÜÊú™Á°ÆËÆ§
                        return { 
                            success: false, 
                            pending: true,
                            status: statusResult.value.confirmationStatus || 'processed',
                            message: '‰∫§ÊòìÊ≠£Âú®Â§ÑÁêÜ‰∏≠'
                        };
                    }
                    
                    // Âú®Ê≠§RPC‰∏äÊú™ÊâæÂà∞‰∫§ÊòìÔºåÂ∞ùËØï‰∏ã‰∏Ä‰∏™
                    console.log(`‚ö†Ô∏è Âú®RPC ${i+1} ‰∏äÊú™ÊâæÂà∞‰∫§ÊòìÔºåÂ∞ùËØï‰∏ã‰∏Ä‰∏™...`);
                    
                } catch (error) {
                    console.warn(`‚ö†Ô∏è ÊúÄÁªàÊ£ÄÊü•Â§±Ë¥• (RPC ${i+1}): ${error.message}`);
                    continue;
                }
            }
            
            // ÊâÄÊúâRPCÈÉΩÊ£ÄÊü•Â§±Ë¥•
            return { 
                success: false, 
                error: 'Êó†Ê≥ïÁ°ÆÂÆö‰∫§ÊòìÊúÄÁªàÁä∂ÊÄÅÔºåËØ∑ÊâãÂä®Êü•ÁúãExplorer',
                explorerUrl: `https://explorer.solana.com/tx/${signature}`
            };
        }

        // HeliusÂ¢ûÂº∫APIÔºöËé∑Âèñ‰ª£Â∏Å‰ΩôÈ¢ù
        async function getHeliusTokenBalances(publicKey) {
            const HELIUS_API = "https://api.helius.xyz/v0";
            const API_KEY = "4666ac55-bdad-41b4-83a8-2b2787bc30b6";
            
            try {
                console.log('üöÄ ‰ΩøÁî®HeliusÂ¢ûÂº∫APIËé∑Âèñ‰ª£Â∏Å‰ΩôÈ¢ù...');
                
                // ‰ΩøÁî®HeliusÁöÑToken APIËé∑Âèñ‰ª£Â∏Å‰ΩôÈ¢ù
                const response = await fetch(`${HELIUS_API}/addresses/${publicKey.toString()}/balances?api-key=${API_KEY}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Helius APIÈîôËØØ: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('üìä Helius‰ª£Â∏Å‰ΩôÈ¢ùÂìçÂ∫î:', data);
                
                // Ê†ºÂºèÂåñ‰ª£Â∏Å‰ΩôÈ¢ù‰ø°ÊÅØ
                const balances = [];
                if (data.tokens && Array.isArray(data.tokens)) {
                    const targetSymbols = ['USDT', 'USDC', 'RAY', 'SRM'];
                    
                    for (const symbol of targetSymbols) {
                        const token = data.tokens.find(t => t.tokenSymbol === symbol);
                        balances.push({
                            symbol: symbol,
                            balance: token ? token.amount : '0'
                        });
                    }
                }
                
                return balances;
                
            } catch (error) {
                console.error('‚ùå Helius‰ª£Â∏Å‰ΩôÈ¢ùAPIÂ§±Ë¥•:', error.message);
                throw error;
            }
        }

        // HeliusÂ¢ûÂº∫APIÔºöËß£Êûê‰∫§Êòì
        async function parseTransactionWithHelius(signature) {
            const HELIUS_API = "https://api.helius.xyz/v0";
            const API_KEY = "4666ac55-bdad-41b4-83a8-2b2787bc30b6";
            
            try {
                console.log('üîç ‰ΩøÁî®Helius APIËß£Êûê‰∫§Êòì:', signature);
                
                const response = await fetch(`${HELIUS_API}/transactions/?api-key=${API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        transactions: [signature]
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HeliusËß£ÊûêAPIÈîôËØØ: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('üìä Helius‰∫§ÊòìËß£ÊûêÂìçÂ∫î:', data);
                
                return data;
                
            } catch (error) {
                console.error('‚ùå Helius‰∫§ÊòìËß£ÊûêÂ§±Ë¥•:', error.message);
                throw error;
            }
        }

        // HeliusÂ¢ûÂº∫APIÔºöËé∑Âèñ‰∫§ÊòìÂéÜÂè≤
        async function getTransactionHistoryWithHelius(address, limit = 10) {
            const HELIUS_API = "https://api.helius.xyz/v0";
            const API_KEY = "4666ac55-bdad-41b4-83a8-2b2787bc30b6";
            
            try {
                console.log('üìú ‰ΩøÁî®Helius APIËé∑Âèñ‰∫§ÊòìÂéÜÂè≤:', address);
                
                const response = await fetch(`${HELIUS_API}/addresses/${address}/transactions/?api-key=${API_KEY}&limit=${limit}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HeliusÂéÜÂè≤APIÈîôËØØ: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('üìä Helius‰∫§ÊòìÂéÜÂè≤ÂìçÂ∫î:', data);
                
                return data;
                
            } catch (error) {
                console.error('‚ùå Helius‰∫§ÊòìÂéÜÂè≤Ëé∑ÂèñÂ§±Ë¥•:', error.message);
                throw error;
            }
        }

        // üìù Ê†áÂáÜÂåñ‰∫§ÊòìÂàõÂª∫ÂáΩÊï∞ - ÊåâÁÖßSolanaÊúÄ‰Ω≥ÂÆûË∑µ
        function createSolanaTransaction(fromAddress, toAddress, amount, connection) {
            console.log('üèóÔ∏è ÂàõÂª∫Ê†áÂáÜÂåñSolana‰∫§Êòì...');
            
                         // 1. È™åËØÅÂπ∂ËΩ¨Êç¢ÈáëÈ¢ùÂçï‰Ωç
             const lamports = Math.floor(parseFloat(amount) * solanaWeb3.LAMPORTS_PER_SOL);
             console.log(`üí∞ ÈáëÈ¢ùËΩ¨Êç¢: ${amount} SOL = ${lamports} lamports`);
            
            if (lamports <= 0) {
                throw new Error('ËΩ¨Ë¥¶ÈáëÈ¢ùÂøÖÈ°ªÂ§ß‰∫é0');
            }
            
            // 2. Á°Æ‰øùÂú∞ÂùÄÊòØPublicKeyÁ±ªÂûã
            let fromPubkey, toPubkey;
            
            if (fromAddress instanceof solanaWeb3.PublicKey) {
                fromPubkey = fromAddress;
            } else if (typeof fromAddress === 'string') {
                fromPubkey = new solanaWeb3.PublicKey(fromAddress);
            } else {
                throw new Error('ÂèëÈÄÅÊñπÂú∞ÂùÄÊ†ºÂºèÊó†Êïà');
            }
            
            if (toAddress instanceof solanaWeb3.PublicKey) {
                toPubkey = toAddress;
            } else if (typeof toAddress === 'string') {
                toPubkey = new solanaWeb3.PublicKey(toAddress);
            } else {
                throw new Error('Êé•Êî∂ÊñπÂú∞ÂùÄÊ†ºÂºèÊó†Êïà');
            }
            
            console.log(`üîç Âú∞ÂùÄÈ™åËØÅ:`);
            console.log(`   - ÂèëÈÄÅÊñπ: ${fromPubkey.toString()} (${fromPubkey.constructor.name})`);
            console.log(`   - Êé•Êî∂Êñπ: ${toPubkey.toString()} (${toPubkey.constructor.name})`);
            
            // 3. ÂàõÂª∫‰∫§Êòì
            const transaction = new solanaWeb3.Transaction();
            
            // 4. Ê∑ªÂä†ËΩ¨Ë¥¶Êåá‰ª§
            const transferInstruction = solanaWeb3.SystemProgram.transfer({
                fromPubkey: fromPubkey,
                toPubkey: toPubkey,
                lamports: lamports
            });
            
            transaction.add(transferInstruction);
            console.log(`‚úÖ ËΩ¨Ë¥¶Êåá‰ª§Â∑≤Ê∑ªÂä†: ${lamports} lamports`);
            
            return {
                transaction,
                fromPubkey,
                toPubkey,
                lamports
            };
        }

        // Helius WebSocketËøûÊé•ÔºöÂÆûÊó∂‰∫§ÊòìÁõëÊéß
        let heliusWebSocket = null;
        
        function connectHeliusWebSocket(address) {
            try {
                // üîß ‰øÆÂ§çWebSocket URLÊ†ºÂºè - ÂèØËÉΩÈúÄË¶Å‰∏çÂêåÁöÑÁ´ØÁÇπ
                const HELIUS_WS_URL = "wss://atlas-mainnet.helius-rpc.com/?api-key=4666ac55-bdad-41b4-83a8-2b2787bc30b6";
                
                console.log('üîó Â∞ùËØïËøûÊé•Helius WebSocket:', HELIUS_WS_URL);
                console.log('‚ö†Ô∏è Ê≥®ÊÑèÔºöWebSocketÂäüËÉΩÊöÇÊó∂Á¶ÅÁî®ÔºåÁ≠âÂæÖAPIÂØÜÈí•ÊùÉÈôêÁ°ÆËÆ§');
                
                // ÊöÇÊó∂Á¶ÅÁî®WebSocketËøûÊé•ÔºåÁõ¥Âà∞APIÂØÜÈí•ÈóÆÈ¢òËß£ÂÜ≥
                console.log('üîå WebSocketËøûÊé•Â∑≤ÊöÇÊó∂Á¶ÅÁî®');
                return;
                
                heliusWebSocket = new WebSocket(HELIUS_WS_URL);
                
                heliusWebSocket.onopen = function() {
                    console.log('‚úÖ Helius WebSocketËøûÊé•ÊàêÂäü');
                    
                    // ËÆ¢ÈòÖË¥¶Êà∑ÂèòÂåñÈÄöÁü•
                    const subscribeMessage = {
                        jsonrpc: "2.0",
                        id: 1,
                        method: "accountSubscribe",
                        params: [
                            address,
                            {
                                encoding: "jsonParsed",
                                commitment: "confirmed"
                            }
                        ]
                    };
                    
                    heliusWebSocket.send(JSON.stringify(subscribeMessage));
                    console.log('üì° Â∑≤ËÆ¢ÈòÖË¥¶Êà∑ÂèòÂåñÈÄöÁü•:', address);
                };
                
                heliusWebSocket.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        console.log('üì® Helius WebSocketÊ∂àÊÅØ:', data);
                        
                        // Â§ÑÁêÜË¥¶Êà∑ÂèòÂåñÈÄöÁü•
                        if (data.method === 'accountNotification') {
                            console.log('üîî Ë¥¶Êà∑‰ΩôÈ¢ùÂèòÂåñÈÄöÁü•:', data.params);
                            // Ëá™Âä®Êõ¥Êñ∞‰ΩôÈ¢ù
                            setTimeout(updateBalance, 1000);
                        }
                        
                    } catch (parseError) {
                        console.warn('‚ö†Ô∏è WebSocketÊ∂àÊÅØËß£ÊûêÂ§±Ë¥•:', parseError.message);
                    }
                };
                
                heliusWebSocket.onerror = function(error) {
                    console.error('‚ùå Helius WebSocketÈîôËØØ:', error);
                };
                
                heliusWebSocket.onclose = function() {
                    console.log('üîå Helius WebSocketËøûÊé•ÂÖ≥Èó≠');
                    heliusWebSocket = null;
                };
                
            } catch (error) {
                console.error('‚ùå Helius WebSocketËøûÊé•Â§±Ë¥•:', error.message);
            }
        }
        
        function disconnectHeliusWebSocket() {
            if (heliusWebSocket) {
                heliusWebSocket.close();
                heliusWebSocket = null;
                console.log('üîå Â∑≤Êñ≠ÂºÄHelius WebSocketËøûÊé•');
            }
        }

        // üåâ ÂéüÁîüRPCÊ°•Ê¢Å - ÈÄöËøáiOSÂéüÁîüÂ±ÇÂèëÈÄÅRPCËØ∑Ê±Ç
        let nativeRPCCallbacks = new Map();
        let nativeRPCCallId = 0;
        
        // Â§ÑÁêÜÂéüÁîüRPCÂìçÂ∫î
        window.handleNativeRPCResponse = function(response) {
            console.log('üì± Êî∂Âà∞ÂéüÁîüRPCÂìçÂ∫î:', response);
            
            const callback = nativeRPCCallbacks.get(response.id);
            if (callback) {
                nativeRPCCallbacks.delete(response.id);
                callback(response);
            }
        };
        
        // ÈÄöËøáÂéüÁîüÂ±ÇÂèëÈÄÅRPCËØ∑Ê±Ç
        async function sendNativeRPCRequest(method, params) {
            return new Promise((resolve, reject) => {
                const callId = ++nativeRPCCallId;
                
                // ‰øùÂ≠òÂõûË∞É
                nativeRPCCallbacks.set(callId, (response) => {
                    if (response.error) {
                        reject(new Error(response.error.message || JSON.stringify(response.error)));
                    } else {
                        resolve(response.result);
                    }
                });
                
                // ÂèëÈÄÅËØ∑Ê±ÇÂà∞ÂéüÁîüÂ±Ç
                const request = {
                    id: callId,
                    method: method,
                    params: params
                };
                
                console.log('üì± ÂèëÈÄÅÂéüÁîüRPCËØ∑Ê±Ç:', request);
                
                if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.solanaRPC) {
                    window.webkit.messageHandlers.solanaRPC.postMessage(request);
                } else {
                    reject(new Error('ÂéüÁîüRPCÊ°•Ê¢Å‰∏çÂèØÁî®'));
                }
                
                // ËÆæÁΩÆË∂ÖÊó∂
                setTimeout(() => {
                    if (nativeRPCCallbacks.has(callId)) {
                        nativeRPCCallbacks.delete(callId);
                        reject(new Error('RPCËØ∑Ê±ÇË∂ÖÊó∂'));
                    }
                }, 30000); // 30ÁßíË∂ÖÊó∂
            });
        }
        
        // ÂàõÂª∫Âü∫‰∫éÂéüÁîüÊ°•Ê¢ÅÁöÑConnectionÁ±ª
        class NativeConnection {
            constructor() {
                this.commitment = 'confirmed';
            }
            
            async getLatestBlockhash(commitment = 'confirmed') {
                console.log('üîó ÈÄöËøáÂéüÁîüÂ±ÇËé∑ÂèñÊúÄÊñ∞blockhash');
                const result = await sendNativeRPCRequest('getLatestBlockhash', [{ commitment }]);
                return {
                    blockhash: result.value.blockhash,
                    lastValidBlockHeight: result.value.lastValidBlockHeight
                };
            }
            
            async sendRawTransaction(serializedTransaction, options = {}) {
                console.log('üì§ ÈÄöËøáÂéüÁîüÂ±ÇÂèëÈÄÅ‰∫§Êòì');
                
                // Â∞Ü‰∫§ÊòìËΩ¨Êç¢‰∏∫base64
                const base64Transaction = btoa(String.fromCharCode.apply(null, serializedTransaction));
                
                const params = [
                    base64Transaction,
                    {
                        encoding: "base64",
                        preflightCommitment: options.preflightCommitment || "confirmed",
                        skipPreflight: options.skipPreflight || false,
                        maxRetries: options.maxRetries || 3
                    }
                ];
                
                const result = await sendNativeRPCRequest('sendTransaction', params);
                return result;
            }
            
            async getSignatureStatus(signature) {
                console.log('üîç ÈÄöËøáÂéüÁîüÂ±ÇÊ£ÄÊü•‰∫§ÊòìÁä∂ÊÄÅ');
                const result = await sendNativeRPCRequest('getSignatureStatuses', [[signature]]);
                return {
                    value: result.value && result.value[0] ? result.value[0] : null
                };
            }
            
            async getBalance(publicKey) {
                console.log('üí∞ ÈÄöËøáÂéüÁîüÂ±ÇËé∑Âèñ‰ΩôÈ¢ù');
                const result = await sendNativeRPCRequest('getBalance', [publicKey.toString()]);
                return result.value;
            }
            
            async getTokenAccountsByOwner(owner, filter) {
                console.log('ü™ô ÈÄöËøáÂéüÁîüÂ±ÇËé∑Âèñ‰ª£Â∏ÅË¥¶Êà∑');
                const result = await sendNativeRPCRequest('getTokenAccountsByOwner', [
                    owner.toString(), 
                    filter,
                    { encoding: "jsonParsed" }
                ]);
                return result;
            }
            
            async getTokenAccountBalance(tokenAccount) {
                console.log('üí∞ ÈÄöËøáÂéüÁîüÂ±ÇËé∑Âèñ‰ª£Â∏Å‰ΩôÈ¢ù');
                const result = await sendNativeRPCRequest('getTokenAccountBalance', [tokenAccount.toString()]);
                return result;
            }
        }

        // Helius‰∏ìÁî®ÂèëÈÄÅÊñπÊ≥ïÔºà‰ΩøÁî®Ê†áÂáÜRPC + Â¢ûÂº∫APIÂäüËÉΩÔºâ
        async function sendTransactionViaHelius(transaction, rpcUrl) {
            console.log('üåü ‰ΩøÁî®Helius RPCÂèëÈÄÅ‰∫§Êòì:', rpcUrl);
            
            // ÊñπÊ≥ï1: ‰ΩøÁî®Ê†áÂáÜWeb3.jsËøûÊé•ÊñπÂºèÔºàÊé®ËçêÔºâ
            try {
                const connection = new solanaWeb3.Connection(rpcUrl, 'confirmed');
                
                const signature = await connection.sendRawTransaction(
                    transaction.serialize(),
                    {
                        skipPreflight: false,
                        preflightCommitment: 'confirmed',
                        maxRetries: 3
                    }
                );
                
                console.log('üìä Helius RPCÂìçÂ∫îÊàêÂäüÔºå‰∫§ÊòìÁ≠æÂêç:', signature);
                return signature;
                
            } catch (rpcError) {
                console.warn('‚ö†Ô∏è Helius RPCÊ†áÂáÜÊñπÊ≥ïÂ§±Ë¥•ÔºåÂ∞ùËØïfetchÊñπÊ≥ï:', rpcError.message);
                
                // ÊñπÊ≥ï2: Â§áÁî®fetchÊñπÊ≥ï
                const serializedTx = transaction.serialize();
                const base64Tx = serializedTx.toString('base64');
                
                const requestBody = {
                    jsonrpc: "2.0",
                    id: 1,
                    method: "sendTransaction",
                    params: [
                        base64Tx,
                        {
                            encoding: "base64",
                            preflightCommitment: "confirmed"
                        }
                    ]
                };
                
                const response = await fetch(rpcUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    throw new Error(`Helius HTTPÈîôËØØ: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('üìä Helius fetchÂìçÂ∫î:', data);
                
                if (data.error) {
                    throw new Error(`Helius RPCÈîôËØØ: ${data.error.message || JSON.stringify(data.error)}`);
                }
                
                if (!data.result) {
                    throw new Error('HeliusÂìçÂ∫î‰∏≠Ê≤°Êúâ‰∫§ÊòìÁ≠æÂêçÁªìÊûú');
                }
                
                return data.result;
            }
        }

        // Â§áÁî®ÂèëÈÄÅÊñπÊ≥ïÔºö‰ΩøÁî®ÂéüÁîü fetch API
        async function sendTransactionViaFetch(transaction, rpcUrl) {
            console.log('üîÑ ‰ΩøÁî®Â§áÁî®ÊñπÊ≥ïÂèëÈÄÅ‰∫§Êòì:', rpcUrl);
            
            // Â∫èÂàóÂåñ‰∫§ÊòìÂπ∂ËΩ¨Êç¢‰∏∫ Base64
            const serializedTx = transaction.serialize();
            const base64Tx = btoa(String.fromCharCode.apply(null, serializedTx));
            
            const requestBody = {
                jsonrpc: "2.0",
                id: 1,
                method: "sendTransaction",
                params: [
                    base64Tx,
                    {
                        skipPreflight: false,
                        preflightCommitment: 'confirmed'
                    }
                ]
            };
            
            console.log('üì° Â§áÁî®ÊñπÊ≥ïËØ∑Ê±ÇÂèÇÊï∞:', {
                url: rpcUrl,
                method: 'POST',
                bodyLength: JSON.stringify(requestBody).length
            });
            
            const response = await fetch(rpcUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestBody)
            });
            
            if (!response.ok) {
                throw new Error(`HTTPÈîôËØØ: ${response.status} ${response.statusText}`);
            }
            
            const data = await response.json();
            
            if (data.error) {
                throw new Error(`RPCÈîôËØØ: ${data.error.message || JSON.stringify(data.error)}`);
            }
            
            if (!data.result) {
                throw new Error('RPCÂìçÂ∫î‰∏≠Ê≤°ÊúâÁªìÊûú');
            }
            
            return data.result;
        }

        // ÈáçËØï‰∫§ÊòìÂáΩÊï∞ - ‰ΩøÁî®Êõ¥È´ò‰ºòÂÖàÁ∫ßË¥πÁî®
        window.retryTransactionWithHigherFee = function(priorityFee, fromAddress, toAddress, amount, tokenSymbol) {
            console.log(`üîÑ Êî∂Âà∞ÈáçËØïËØ∑Ê±Ç: ‰ºòÂÖàÁ∫ßË¥πÁî® ${priorityFee} lamports`);
            
            // Êõ¥Êñ∞ÈÖçÁΩÆ‰∏≠ÁöÑ‰ºòÂÖàÁ∫ßË¥πÁî®
            config.priorityFee = priorityFee;
            
            // ËÆ°ÁÆó SOL Á≠âÂÄºÊòæÁ§∫
            const solEquivalent = (priorityFee / 1e9).toFixed(8);
            
            // ÊòæÁ§∫ÈáçËØïÁä∂ÊÄÅ
            showStatus(`Ê≠£Âú®‰ΩøÁî®Êõ¥È´ò‰ºòÂÖàÁ∫ßË¥πÁî®ÈáçËØï... (${priorityFee} lamports ‚âà ${solEquivalent} SOL)`, 'warning');
            
            // ÈáçÊñ∞Â°´ÂÖÖË°®Âçï
            document.getElementById('toAddress').value = toAddress;
            document.getElementById('amount').value = amount;
            
            // ÊòæÁ§∫Áî®Êà∑ÂèãÂ•ΩÁöÑÊèêÁ§∫
            console.log(`üí∞ ÈáçËØï‰∫§ÊòìËØ¶ÊÉÖ:`);
            console.log(`   - ÂèëÈÄÅÊñπ: ${fromAddress}`);
            console.log(`   - Êé•Êî∂Êñπ: ${toAddress}`);
            console.log(`   - ÈáëÈ¢ù: ${amount} ${tokenSymbol}`);
            console.log(`   - ‰ºòÂÖàÁ∫ßË¥πÁî®: ${priorityFee} lamports (${solEquivalent} SOL)`);
            
            // Ê®°ÊãüÁÇπÂáªÂèëÈÄÅÊåâÈíÆÈáçËØï
            setTimeout(() => {
                executeTransaction();
            }, 1000);
        };

        // ÁΩëÁªúÁä∂ÊÄÅÊ£ÄÊü•ÂáΩÊï∞
        function checkNetworkCongestion() {
            // ÁÆÄÂçïÁöÑÁΩëÁªúÊã•Â†µÊ£ÄÊµã
            const now = Date.now();
            const lastRequestTime = window.lastRpcRequestTime || 0;
            const timeSinceLastRequest = now - lastRequestTime;
            
            window.lastRpcRequestTime = now;
            
            // Â¶ÇÊûúËØ∑Ê±ÇÈó¥ÈöîËøáÁü≠ÔºåÂèØËÉΩË°®Á§∫ÁΩëÁªúÊã•Â†µ
            if (timeSinceLastRequest < 5000) {
                console.warn('‚ö†Ô∏è ÁΩëÁªúÂèØËÉΩÊã•Â†µÔºåÂª∫ËÆÆÂ¢ûÂä†‰ºòÂÖàÁ∫ßË¥πÁî®');
                return true;
            }
            
            return false;
        }

        // ÊòæÁ§∫Ë∞ÉËØï‰ø°ÊÅØ
        function debugWalletDetection() {
            const debugInfo = document.getElementById('debugInfo');
            const isVisible = debugInfo.style.display !== 'none';
            
            if (isVisible) {
                debugInfo.style.display = 'none';
                document.getElementById('debugBtn').textContent = 'ÊòæÁ§∫Ë∞ÉËØï‰ø°ÊÅØ';
                return;
            }
            
            let info = `Ë∞ÉËØï‰ø°ÊÅØ (${new Date().toLocaleTimeString()}):\n\n`;
            
            info += `Áî®Êà∑‰ª£ÁêÜ: ${navigator.userAgent}\n\n`;
            
            info += `window.solana Â≠òÂú®: ${window.solana ? '‚úÖ ÊòØ' : '‚ùå Âê¶'}\n`;
            if (window.solana) {
                info += `  - isPhantom: ${window.solana.isPhantom}\n`;
                info += `  - isConnected: ${window.solana.isConnected}\n`;
                info += `  - publicKey: ${window.solana.publicKey ? window.solana.publicKey.toString() : 'null'}\n`;
            }
            
            info += `\nÂÖ∂‰ªñÈí±ÂåÖÊ£ÄÊµã:\n`;
            info += `window.ethereum: ${window.ethereum ? '‚úÖ Â≠òÂú®' : '‚ùå ‰∏çÂ≠òÂú®'}\n`;
            info += `window.phantom: ${window.phantom ? '‚úÖ Â≠òÂú®' : '‚ùå ‰∏çÂ≠òÂú®'}\n`;
            
            info += `\nÈ°µÈù¢ÁéØÂ¢É:\n`;
            info += `ÂçèËÆÆ: ${location.protocol}\n`;
            info += `ÂüüÂêç: ${location.hostname}\n`;
            info += `Á´ØÂè£: ${location.port || 'ÈªòËÆ§'}\n`;
            info += `ÂÆåÊï¥URL: ${location.href}\n`;
            
            info += `\nSolana Web3.js:\n`;
            info += `solanaWeb3 ÂØπË±°: ${typeof solanaWeb3 !== 'undefined' ? '‚úÖ Â∑≤Âä†ËΩΩ' : '‚ùå Êú™Âä†ËΩΩ'}\n`;
            if (typeof solanaWeb3 !== 'undefined') {
                info += `Connection Á±ª: ${solanaWeb3.Connection ? '‚úÖ ÂèØÁî®' : '‚ùå ‰∏çÂèØÁî®'}\n`;
                info += `PublicKey Á±ª: ${solanaWeb3.PublicKey ? '‚úÖ ÂèØÁî®' : '‚ùå ‰∏çÂèØÁî®'}\n`;
            }
            
            info += `\niOS WebView Ê°•Êé•:\n`;
            info += `webkit ÂØπË±°: ${window.webkit ? '‚úÖ Â≠òÂú®' : '‚ùå ‰∏çÂ≠òÂú®'}\n`;
            if (window.webkit && window.webkit.messageHandlers) {
                info += `messageHandlers: ‚úÖ Â≠òÂú®\n`;
                info += `phantomCallback: ${window.webkit.messageHandlers.phantomCallback ? '‚úÖ Â∑≤Ê≥®ÂÜå' : '‚ùå Êú™Ê≥®ÂÜå'}\n`;
            }
            
            debugInfo.textContent = info;
            debugInfo.style.display = 'block';
            document.getElementById('debugBtn').textContent = 'ÈöêËóèË∞ÉËØï‰ø°ÊÅØ';
        }

        // ‰ªéiOSÊé•Êî∂ÈÖçÁΩÆÂπ∂Êõ¥Êñ∞È°µÈù¢
        window.setTransactionConfig = function(jsonString) {
            try {
                const data = JSON.parse(jsonString);
                console.log('üì± Êî∂Âà∞iOSÈÖçÁΩÆÂèÇÊï∞:', data);
                
                // ÂêàÂπ∂ÈÖçÁΩÆ
                config = { ...config, ...data };
                
                // Êõ¥Êñ∞È°µÈù¢Ê†áÈ¢ò
                document.getElementById('pageTitle').textContent = 
                    `${config.tokenName || config.tokenSymbol || 'Solana'} ËΩ¨Ë¥¶`;
                
                // Êõ¥Êñ∞UIË°®Âçï
                document.getElementById('tokenName').textContent = config.tokenName || config.tokenSymbol || 'Solana';
                document.getElementById('network').textContent = config.network || 'Solana';
                document.getElementById('fromAddress').value = config.fromAddress || '';
                
                // Êõ¥Êñ∞ÊúÄÂ§ßÂèØÊèêÂ∏ÅÊï∞ÈáèÊòæÁ§∫
                document.getElementById('maxAmountInfo').textContent = 
                    `ÊúÄÂ§ßÂèØÊèêÂ∏ÅÊï∞ÈáèÔºö${config.maxAmount || 0} ${config.tokenSymbol || 'SOL'}`;
                
                // Êõ¥Êñ∞ÈáëÈ¢ùËæìÂÖ•Ê°ÜÁöÑÊúÄÂ§ßÂÄº
                const amountInput = document.getElementById('amount');
                if (config.maxAmount > 0) {
                    amountInput.max = config.maxAmount;
                    amountInput.placeholder = `ËØ∑ËæìÂÖ•ÈáëÈ¢ù (ÊúÄÂ§ß: ${config.maxAmount})`;
                } else {
                    amountInput.placeholder = `ËØ∑ËæìÂÖ•ÈáëÈ¢ù`;
                }
                
                showStatus('ÈÖçÁΩÆÂä†ËΩΩÂÆåÊàêÔºåËØ∑ËøûÊé•Èí±ÂåÖ', 'success');
                
                console.log('‚úÖ [Config] ‰∫§ÊòìÈÖçÁΩÆÊõ¥Êñ∞ÂÆåÊàê:', config);
                
            } catch (error) {
                console.error('‚ùå [Config] ÈÖçÁΩÆËß£ÊûêÂ§±Ë¥•:', error);
                showStatus('ÈÖçÁΩÆÂä†ËΩΩÂ§±Ë¥•: ' + error.message, 'error');
            }
        };

        // ‰∫ã‰ª∂ÁõëÂê¨Âô®
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üì± È°µÈù¢Âä†ËΩΩÂÆåÊàê');
            
            // ÁªëÂÆö‰∫ã‰ª∂
            document.getElementById('connectBtn').addEventListener('click', connectPhantom);
            document.getElementById('submitBtn').addEventListener('click', executeTransaction);
            document.getElementById('debugBtn').addEventListener('click', debugWalletDetection);
            
            // Ê£ÄÊµãÈí±ÂåÖ
            showStatus('Ê≠£Âú®Ê£ÄÊµãÈí±ÂåÖÁéØÂ¢É...', 'info');
            
            const detected = await detectPhantom();
            if (detected) {
                showStatus('Èí±ÂåÖÁéØÂ¢ÉÊ£ÄÊµãÊàêÂäüÔºåËØ∑ÁÇπÂáªËøûÊé•', 'success');
            } else {
                showStatus('Êú™Ê£ÄÊµãÂà∞Èí±ÂåÖÔºåËØ∑Á°Æ‰øùÂ∑≤ÂÆâË£Ö Phantom', 'error');
            }
        });

        // ÂÖºÂÆπÊÄßÂà´Âêç
        window.setConfig = window.setTransactionConfig;
  </script>
</body>
</html>
