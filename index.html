<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Solana ËΩ¨Ë¥¶</title>
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #333;
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .info-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }
        
        .info-box h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .info-item:last-child {
            margin-bottom: 0;
        }
        
        .info-label {
            color: #666;
            font-weight: 500;
        }
        
        .info-value {
            color: #333;
            font-weight: 600;
        }
        
        .button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }
        
        .button-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .button-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .button-secondary {
            background: #f8f9fa;
            color: #333;
            border: 2px solid #e1e5e9;
        }
        
        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .status {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
            text-align: center;
        }
        
        .status-info {
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #bbdefb;
        }
        
        .status-success {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }
        
        .status-error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .debug-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e1e5e9;
        }
        
        .debug-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            font-family: monospace;
            font-size: 12px;
            color: #666;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="pageTitle">Solana ËΩ¨Ë¥¶</h1>
        </div>
        
        <div id="status" class="status status-info">
            Ê≠£Âú®ÂàùÂßãÂåñ...
        </div>
        
        <div class="info-box">
            <h3>‰∫§Êòì‰ø°ÊÅØ</h3>
            <div class="info-item">
                <span class="info-label">‰ª£Â∏Å:</span>
                <span class="info-value" id="tokenName">Âä†ËΩΩ‰∏≠...</span>
            </div>
            <div class="info-item">
                <span class="info-label">ÁΩëÁªú:</span>
                <span class="info-value" id="network">Âä†ËΩΩ‰∏≠...</span>
            </div>
            <div class="info-item">
                <span class="info-label">ÊúÄÂ§ßÈáëÈ¢ù:</span>
                <span class="info-value" id="maxAmountInfo">Âä†ËΩΩ‰∏≠...</span>
            </div>
        </div>
        
        <div class="form-group">
            <label for="fromAddress">ÂèëÈÄÅÂú∞ÂùÄ</label>
            <input type="text" id="fromAddress" readonly placeholder="ËøûÊé•Èí±ÂåÖÂêéÊòæÁ§∫">
        </div>
        
        <div class="form-group">
            <label for="toAddress">Êé•Êî∂Âú∞ÂùÄ</label>
            <input type="text" id="toAddress" placeholder="ËØ∑ËæìÂÖ•Êé•Êî∂ÊñπÂú∞ÂùÄ">
        </div>
        
        <div class="form-group">
            <label for="amount">ËΩ¨Ë¥¶ÈáëÈ¢ù</label>
            <input type="number" id="amount" step="0.000001" placeholder="ËØ∑ËæìÂÖ•ËΩ¨Ë¥¶ÈáëÈ¢ù">
        </div>
        
        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <div>Â§ÑÁêÜ‰∏≠...</div>
        </div>
        
        <button id="connectBtn" class="button button-primary">ËøûÊé• Phantom Èí±ÂåÖ</button>
        <button id="submitBtn" class="button button-primary" disabled>Á°ÆËÆ§ËΩ¨Ë¥¶</button>
        
        <div class="debug-section">
            <button id="debugBtn" class="button button-secondary">ÊòæÁ§∫Ë∞ÉËØï‰ø°ÊÅØ</button>
            <div id="debugInfo" class="debug-info" style="display: none;"></div>
        </div>
    </div>

    <script>
        // ÂÖ®Â±ÄÂèòÈáè
        let provider = null;
        let connection = null;
        let config = {
            tokenSymbol: 'SOL',
            tokenName: 'Solana',
            contractAddress: '',
            network: 'solana',
            fromAddress: '',
            maxAmount: 0,
            decimals: 9
        };

        // ÊòæÁ§∫Áä∂ÊÄÅ‰ø°ÊÅØ
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status status-${type}`;
            console.log(`[Status] ${message}`);
        }

        // ÊòæÁ§∫/ÈöêËóèÂä†ËΩΩÁä∂ÊÄÅ
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
            document.getElementById('submitBtn').disabled = show;
        }

        // Ê£ÄÊµã iOS WebView ÁéØÂ¢ÉÂπ∂ÂàõÂª∫ Phantom Ê°•Êé•
        function createPhantomBridge() {
            if (!window.solana && window.webkit && window.webkit.messageHandlers) {
                console.log('üîó Ê£ÄÊµãÂà∞ iOS WebView ÁéØÂ¢ÉÔºåÂàõÂª∫ Phantom Ê°•Êé•');
                
                // ÂàõÂª∫Ê®°ÊãüÁöÑ Phantom Èí±ÂåÖÂØπË±°
                window.solana = {
                    isPhantom: true,
                    name: 'Phantom',
                    version: '1.0.0',
                    isConnected: false,
                    publicKey: null,
                    
                    // ËøûÊé•ÊñπÊ≥ï - ÈÄöËøá iOS Ê°•Êé•
                    connect: function(options = {}) {
                        return new Promise((resolve, reject) => {
                            console.log('üîó ÈÄöËøá iOS Ê°•Êé•ËØ∑Ê±ÇËøûÊé• Phantom');
                            
                            // ËÆæÁΩÆË∂ÖÊó∂
                            const timeout = setTimeout(() => {
                                reject(new Error('ËøûÊé•Ë∂ÖÊó∂'));
                            }, 30000);
                            
                            // Â≠òÂÇ® Promise ÂõûË∞É
                            window.phantomConnectResolve = resolve;
                            window.phantomConnectReject = reject;
                            window.phantomConnectTimeout = timeout;
                            
                            // ÂèëÈÄÅËøûÊé•ËØ∑Ê±ÇÂà∞ iOS
                            if (window.webkit.messageHandlers.phantomCallback) {
                                window.webkit.messageHandlers.phantomCallback.postMessage({
                                    type: 'connect_request',
                                    options: options
                                });
                            } else {
                                reject(new Error('iOS Ê°•Êé•‰∏çÂèØÁî®'));
                            }
                        });
                    },
                    
                    // Êñ≠ÂºÄËøûÊé•
                    disconnect: function() {
                        this.isConnected = false;
                        this.publicKey = null;
                        console.log('üîå Phantom Èí±ÂåÖÂ∑≤Êñ≠ÂºÄ');
                        
                        // ÈÄöÁü• iOS
                        if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.phantomCallback) {
                            window.webkit.messageHandlers.phantomCallback.postMessage({
                                type: 'disconnect'
                            });
                        }
                    },
                    
                    // Á≠æÂêç‰∫§Êòì
                    signTransaction: function(transaction) {
                        return new Promise((resolve, reject) => {
                            console.log('‚úçÔ∏è ÈÄöËøá iOS Ê°•Êé•ËØ∑Ê±ÇÁ≠æÂêç‰∫§Êòì');
                            
                            // ËÆæÁΩÆË∂ÖÊó∂
                            const timeout = setTimeout(() => {
                                reject(new Error('Á≠æÂêçË∂ÖÊó∂'));
                            }, 60000);
                            
                            // Â≠òÂÇ® Promise ÂõûË∞É
                            window.phantomSignResolve = resolve;
                            window.phantomSignReject = reject;
                            window.phantomSignTimeout = timeout;
                            
                            // Â∫èÂàóÂåñ‰∫§Êòì
                            const serializedTx = transaction.serialize({
                                requireAllSignatures: false,
                                verifySignatures: false
                            });
                            
                            // ÂèëÈÄÅÁ≠æÂêçËØ∑Ê±ÇÂà∞ iOS
                            if (window.webkit.messageHandlers.phantomCallback) {
                                window.webkit.messageHandlers.phantomCallback.postMessage({
                                    type: 'sign_transaction',
                                    transaction: Array.from(serializedTx),
                                    fromAddress: config.fromAddress,
                                    toAddress: document.getElementById('toAddress').value,
                                    amount: parseFloat(document.getElementById('amount').value),
                                    tokenSymbol: config.tokenSymbol,
                                    contractAddress: config.contractAddress
                                });
                            } else {
                                reject(new Error('iOS Ê°•Êé•‰∏çÂèØÁî®'));
                            }
                        });
                    }
                };
                
                console.log('‚úÖ Phantom Ê°•Êé•ÂØπË±°Â∑≤ÂàõÂª∫');
                return true;
            }
            return false;
        }

        // iOS ÂõûË∞ÉÂ§ÑÁêÜÂáΩÊï∞
        window.handlePhantomResponse = function(response) {
            console.log('üì± Êî∂Âà∞ iOS Phantom ÂìçÂ∫î:', response);
            
            if (response.type === 'connect_success') {
                // ËøûÊé•ÊàêÂäü
                if (window.phantomConnectResolve) {
                    clearTimeout(window.phantomConnectTimeout);
                    
                    const publicKey = {
                        toString: () => response.publicKey,
                        toBase58: () => response.publicKey
                    };
                    
                    window.solana.isConnected = true;
                    window.solana.publicKey = publicKey;
                    
                    window.phantomConnectResolve({ publicKey });
                    
                    // Ê∏ÖÁêÜÂõûË∞É
                    delete window.phantomConnectResolve;
                    delete window.phantomConnectReject;
                    delete window.phantomConnectTimeout;
                }
            } else if (response.type === 'connect_error') {
                // ËøûÊé•Â§±Ë¥•
                if (window.phantomConnectReject) {
                    clearTimeout(window.phantomConnectTimeout);
                    window.phantomConnectReject(new Error(response.message || 'ËøûÊé•Â§±Ë¥•'));
                    
                    // Ê∏ÖÁêÜÂõûË∞É
                    delete window.phantomConnectResolve;
                    delete window.phantomConnectReject;
                    delete window.phantomConnectTimeout;
                }
            } else if (response.type === 'sign_success') {
                // Á≠æÂêçÊàêÂäü
                if (window.phantomSignResolve) {
                    clearTimeout(window.phantomSignTimeout);
                    
                    // ÂàõÂª∫Á≠æÂêçÂêéÁöÑ‰∫§ÊòìÂØπË±°
                    const signedTxData = new Uint8Array(response.signedTransaction);
                    const signedTransaction = solanaWeb3.Transaction.from(signedTxData);
                    
                    window.phantomSignResolve(signedTransaction);
                    
                    // Ê∏ÖÁêÜÂõûË∞É
                    delete window.phantomSignResolve;
                    delete window.phantomSignReject;
                    delete window.phantomSignTimeout;
                }
            } else if (response.type === 'sign_error') {
                // Á≠æÂêçÂ§±Ë¥•
                if (window.phantomSignReject) {
                    clearTimeout(window.phantomSignTimeout);
                    window.phantomSignReject(new Error(response.message || 'Á≠æÂêçÂ§±Ë¥•'));
                    
                    // Ê∏ÖÁêÜÂõûË∞É
                    delete window.phantomSignResolve;
                    delete window.phantomSignReject;
                    delete window.phantomSignTimeout;
                }
            } else if (response.type === 'transaction_success') {
                // ‰∫§ÊòìÊàêÂäü
                showStatus(`‰∫§ÊòìÊàêÂäüÔºÅÁ≠æÂêç: ${response.signature}`, 'success');
                
                // ÈÄöÁü• iOS
                if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.phantomCallback) {
                    window.webkit.messageHandlers.phantomCallback.postMessage({
                        type: 'transaction_completed',
                        signature: response.signature,
                        success: true
                    });
                }
            } else if (response.type === 'transaction_error') {
                // ‰∫§ÊòìÂ§±Ë¥•
                showStatus(`‰∫§ÊòìÂ§±Ë¥•: ${response.message}`, 'error');
                
                // ÈÄöÁü• iOS
                if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.phantomCallback) {
                    window.webkit.messageHandlers.phantomCallback.postMessage({
                        type: 'transaction_completed',
                        error: response.message,
                        success: false
                    });
                }
            }
        };

        // Ê£ÄÊµã Phantom Èí±ÂåÖ
        function detectPhantom() {
            return new Promise((resolve) => {
                console.log('üîç ÂºÄÂßãÊ£ÄÊµã Phantom Èí±ÂåÖ...');
                
                // È¶ñÂÖàÂ∞ùËØïÂàõÂª∫Ê°•Êé•
                const bridgeCreated = createPhantomBridge();
                
                if (bridgeCreated) {
                    console.log('‚úÖ iOS WebView ÁéØÂ¢É‰∏ãÂàõÂª∫‰∫Ü Phantom Ê°•Êé•');
                    resolve(true);
                    return;
                }
                
                // ÂéüÊúâÁöÑÊ£ÄÊµãÈÄªËæë
                if (window.solana && window.solana.isPhantom) {
                    console.log('‚úÖ Ê£ÄÊµãÂà∞ Phantom Èí±ÂåÖ');
                    resolve(true);
                    return;
                }

                // Ê£ÄÊµãÂÖ∂‰ªñÂèØËÉΩÁöÑ solana ÂØπË±°
                if (window.solana && typeof window.solana.connect === 'function') {
                    console.log('‚úÖ Ê£ÄÊµãÂà∞ Solana Èí±ÂåÖÂØπË±°');
                    resolve(true);
                    return;
                }

                // Ê£ÄÊµã window.phantom.solana
                if (window.phantom && window.phantom.solana) {
                    console.log('‚úÖ ÈÄöËøá window.phantom.solana Ê£ÄÊµãÂà∞Èí±ÂåÖ');
                    window.solana = window.phantom.solana;
                    resolve(true);
                    return;
                }

                // ËΩÆËØ¢Ê£ÄÊµã
                let attempts = 0;
                const maxAttempts = 50;
                
                console.log('üîÑ ÂºÄÂßãËΩÆËØ¢Ê£ÄÊµãÔºåÊúÄÂ§öÁ≠âÂæÖ5Áßí...');
                
                const checkInterval = setInterval(() => {
                    attempts++;
                    
                    if (window.solana && window.solana.isPhantom) {
                        console.log('‚úÖ ËΩÆËØ¢Ê£ÄÊµãÂà∞ Phantom Èí±ÂåÖ');
                        clearInterval(checkInterval);
                        resolve(true);
                        return;
                    }
                    
                    if (window.phantom && window.phantom.solana) {
                        console.log('‚úÖ ËΩÆËØ¢Ê£ÄÊµãÂà∞ window.phantom.solana');
                        window.solana = window.phantom.solana;
                        clearInterval(checkInterval);
                        resolve(true);
                        return;
                    }
                    
                    if (attempts >= maxAttempts) {
                        console.log('‚ùå ËΩÆËØ¢Ê£ÄÊµãË∂ÖÊó∂ (5Áßí)');
                        clearInterval(checkInterval);
                        resolve(false);
                    }
                }, 100);
            });
        }

        // ËøûÊé• Phantom Èí±ÂåÖ
        async function connectPhantom() {
            try {
                showLoading(true);
                showStatus('Ê≠£Âú®Ê£ÄÊµã Phantom Èí±ÂåÖ...', 'info');

                // Á≠âÂæÖÈí±ÂåÖÊ£ÄÊµãÂÆåÊàê
                const isPhantomAvailable = await detectPhantom();
                
                if (!isPhantomAvailable) {
                    throw new Error('Phantom Èí±ÂåÖÊú™Ê£ÄÊµãÂà∞„ÄÇËØ∑Á°Æ‰øùÂ∑≤ÂÆâË£Ö Phantom Èí±ÂåÖÂ∫îÁî®Âπ∂Â∑≤ÂàõÂª∫Èí±ÂåÖ„ÄÇ');
                }

                showStatus('Ê≠£Âú®ËøûÊé• Phantom Èí±ÂåÖ...', 'info');

                // Ëé∑Âèñ provider
                provider = window.solana;
                
                // Â∞ùËØïËøûÊé•Èí±ÂåÖ
                const response = await provider.connect({ onlyIfTrusted: false });
                
                if (!response || !response.publicKey) {
                    throw new Error('ËøûÊé•Â§±Ë¥•ÔºåÊú™Ëé∑ÂèñÂà∞Èí±ÂåÖÂú∞ÂùÄ');
                }
                
                const publicKey = response.publicKey.toString();
                console.log('‚úÖ ÊàêÂäüËøûÊé•Âà∞ Phantom Èí±ÂåÖ:', publicKey);
                
                // ËÆæÁΩÆ Solana ËøûÊé• - ‰ΩøÁî®Êõ¥ÂèØÈù†ÁöÑRPCÁ´ØÁÇπ
                const rpcEndpoints = [
                    'https://api.mainnet-beta.solana.com',
                    'https://solana-rpc.publicnode.com',
                    'https://go.getblock.io/4136d34f90a6488b84214ae26f0ed5f4',
                    'https://solana.drpc.org'
                ];
                
                // Â∞ùËØïËøûÊé•Âà∞Á¨¨‰∏Ä‰∏™ÂèØÁî®ÁöÑRPCÁ´ØÁÇπ
                let connectionEstablished = false;
                for (let i = 0; i < rpcEndpoints.length; i++) {
                    try {
                        console.log(`üîó Â∞ùËØïËøûÊé•RPCÁ´ØÁÇπ [${i+1}/${rpcEndpoints.length}]: ${rpcEndpoints[i]}`);
                        connection = new solanaWeb3.Connection(rpcEndpoints[i], 'confirmed');
                        
                        // ÊµãËØïËøûÊé•
                        await connection.getSlot();
                        console.log(`‚úÖ ÊàêÂäüËøûÊé•Âà∞RPCÁ´ØÁÇπ: ${rpcEndpoints[i]}`);
                        connectionEstablished = true;
                        break;
                    } catch (rpcError) {
                        console.warn(`‚ö†Ô∏è RPCÁ´ØÁÇπËøûÊé•Â§±Ë¥•: ${rpcEndpoints[i]} - ${rpcError.message}`);
                        if (i === rpcEndpoints.length - 1) {
                            throw new Error('ÊâÄÊúâRPCÁ´ØÁÇπÂùáËøûÊé•Â§±Ë¥•');
                        }
                    }
                }
                
                if (!connectionEstablished) {
                    throw new Error('Êó†Ê≥ïÂª∫Á´ãSolanaÁΩëÁªúËøûÊé•');
                }

                // Êõ¥Êñ∞ÈÖçÁΩÆÂíåUI
                config.fromAddress = publicKey;
                document.getElementById('fromAddress').value = publicKey;
                document.getElementById('connectBtn').textContent = '‚úÖ Èí±ÂåÖÂ∑≤ËøûÊé•';
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('submitBtn').disabled = false;
                
                showStatus('Èí±ÂåÖËøûÊé•ÊàêÂäüÔºÅ', 'success');
                
                // Ëé∑ÂèñÁúüÂÆû‰ΩôÈ¢ù
                await updateBalance();
                
            } catch (error) {
                console.error('ËøûÊé•Â§±Ë¥•:', error);
                
                let errorMessage = error.message;
                if (error.code === 4001) {
                    errorMessage = 'Áî®Êà∑ÊãíÁªùËøûÊé•Èí±ÂåÖ';
                } else if (error.code === -32603) {
                    errorMessage = 'Èí±ÂåÖËøûÊé•Â§±Ë¥•ÔºåËØ∑ÈáçËØï';
                } else if (error.message.includes('User rejected')) {
                    errorMessage = 'Áî®Êà∑ÂèñÊ∂à‰∫ÜËøûÊé•ËØ∑Ê±Ç';
                }
                
                showStatus(`ËøûÊé•Â§±Ë¥•: ${errorMessage}`, 'error');
                
                // ÈáçÁΩÆËøûÊé•ÊåâÈíÆ
                document.getElementById('connectBtn').textContent = 'ÈáçÊñ∞ËøûÊé• Phantom Èí±ÂåÖ';
                document.getElementById('connectBtn').disabled = false;
            } finally {
                showLoading(false);
            }
        }

        // Êõ¥Êñ∞‰ΩôÈ¢ùÊòæÁ§∫
        async function updateBalance() {
            try {
                if (!connection || !provider.publicKey) return;

                const publicKey = provider.publicKey;
                let balance = 0;

                if (!config.contractAddress || config.tokenSymbol === 'SOL') {
                    // SOL ‰ΩôÈ¢ù
                    const lamports = await connection.getBalance(publicKey);
                    balance = lamports / solanaWeb3.LAMPORTS_PER_SOL;
                } else {
                    // SPL ‰ª£Â∏Å‰ΩôÈ¢ù
                    const tokenAccounts = await connection.getTokenAccountsByOwner(publicKey, {
                        mint: new solanaWeb3.PublicKey(config.contractAddress)
                    });

                    if (tokenAccounts.value.length > 0) {
                        const accountInfo = await connection.getTokenAccountBalance(
                            tokenAccounts.value[0].pubkey
                        );
                        balance = parseFloat(accountInfo.value.uiAmountString || '0');
                    }
                }

                config.maxAmount = balance;
                document.getElementById('maxAmountInfo').textContent = 
                    `ÊúÄÂ§ßÂèØÊèêÂ∏ÅÊï∞ÈáèÔºö${balance} ${config.tokenSymbol}`;
                    
            } catch (error) {
                console.error('Ëé∑Âèñ‰ΩôÈ¢ùÂ§±Ë¥•:', error);
                showStatus('Ëé∑Âèñ‰ΩôÈ¢ùÂ§±Ë¥•', 'error');
            }
        }

        // È™åËØÅÂú∞ÂùÄÊ†ºÂºè
        function isValidSolanaAddress(address) {
            try {
                new solanaWeb3.PublicKey(address);
                return true;
            } catch {
                return false;
            }
        }

        // ÊâßË°å‰∫§Êòì
        async function executeTransaction() {
            try {
                showLoading(true);
                showStatus('Ê≠£Âú®ÂàõÂª∫‰∫§Êòì...', 'info');

                // È™åËØÅËæìÂÖ•
                const toAddress = document.getElementById('toAddress').value.trim();
                const amount = parseFloat(document.getElementById('amount').value);

                if (!toAddress) {
                    throw new Error('ËØ∑ËæìÂÖ•Êé•Êî∂ÊñπÂú∞ÂùÄ');
                }

                if (!isValidSolanaAddress(toAddress)) {
                    throw new Error('Êé•Êî∂ÊñπÂú∞ÂùÄÊ†ºÂºèÊó†Êïà');
                }

                if (isNaN(amount) || amount <= 0) {
                    throw new Error('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑËΩ¨Ë¥¶ÈáëÈ¢ù');
                }

                if (amount > config.maxAmount) {
                    throw new Error(`ËΩ¨Ë¥¶ÈáëÈ¢ù‰∏çËÉΩË∂ÖËøá ${config.maxAmount} ${config.tokenSymbol}`);
                }

                // ÈÄöËøá iOS Ê°•Êé•Â§ÑÁêÜ‰∫§Êòì
                showStatus('ËØ∑Âú® Phantom Èí±ÂåÖ‰∏≠Á°ÆËÆ§‰∫§Êòì...', 'info');
                
                // ÂàõÂª∫‰∏Ä‰∏™ÁÆÄÂçïÁöÑ‰∫§ÊòìÂØπË±°Áî®‰∫éÁ≠æÂêç
                const fromPubkey = provider.publicKey;
                const toPubkey = new solanaWeb3.PublicKey(toAddress);
                
                const transaction = new solanaWeb3.Transaction();
                
                if (!config.contractAddress || config.tokenSymbol === 'SOL') {
                    // SOL ËΩ¨Ë¥¶
                    const lamports = Math.floor(amount * solanaWeb3.LAMPORTS_PER_SOL);
                    transaction.add(
                        solanaWeb3.SystemProgram.transfer({
                            fromPubkey: fromPubkey,
                            toPubkey: toPubkey,
                            lamports: lamports
                        })
                    );
                } else {
                    // SPL ‰ª£Â∏ÅËΩ¨Ë¥¶ (ÁÆÄÂåñÁâàÊú¨)
                    throw new Error('SPL ‰ª£Â∏ÅËΩ¨Ë¥¶ÊöÇ‰∏çÊîØÊåÅ');
                }

                // ËÆæÁΩÆ‰∫§ÊòìÂ±ûÊÄß - ‰ΩøÁî®ÊïÖÈöúÂàáÊç¢Êú∫Âà∂Ëé∑Âèñblockhash
                let blockhash;
                const rpcEndpoints = [
                    'https://api.mainnet-beta.solana.com',
                    'https://solana-rpc.publicnode.com',
                    'https://go.getblock.io/4136d34f90a6488b84214ae26f0ed5f4',
                    'https://solana.drpc.org'
                ];
                
                for (let i = 0; i < rpcEndpoints.length; i++) {
                    try {
                        console.log(`üîó Â∞ùËØïËé∑Âèñblockhash [${i+1}/${rpcEndpoints.length}]: ${rpcEndpoints[i]}`);
                        const tempConnection = new solanaWeb3.Connection(rpcEndpoints[i], 'confirmed');
                        const result = await tempConnection.getLatestBlockhash('confirmed');
                        blockhash = result.blockhash;
                        console.log(`‚úÖ ÊàêÂäüËé∑Âèñblockhash: ${rpcEndpoints[i]}`);
                        
                        // Êõ¥Êñ∞‰∏ªËøûÊé•‰∏∫ÊàêÂäüÁöÑÁ´ØÁÇπ
                        connection = tempConnection;
                        break;
                    } catch (rpcError) {
                        console.warn(`‚ö†Ô∏è Ëé∑ÂèñblockhashÂ§±Ë¥•: ${rpcEndpoints[i]} - ${rpcError.message}`);
                        if (i === rpcEndpoints.length - 1) {
                            throw new Error('ÊâÄÊúâRPCÁ´ØÁÇπÂùáÊó†Ê≥ïËé∑Âèñblockhash: ' + rpcError.message);
                        }
                    }
                }
                
                transaction.recentBlockhash = blockhash;
                transaction.feePayer = fromPubkey;

                // Á≠æÂêç‰∫§Êòì
                const signedTransaction = await provider.signTransaction(transaction);
                
                showStatus('Ê≠£Âú®ÂèëÈÄÅ‰∫§ÊòìÂà∞ÁΩëÁªú...', 'info');

                // ÂèëÈÄÅ‰∫§Êòì - ‰ΩøÁî®ÊïÖÈöúÂàáÊç¢Êú∫Âà∂
                let signature;
                for (let i = 0; i < rpcEndpoints.length; i++) {
                    try {
                        console.log(`üöÄ Â∞ùËØïÂèëÈÄÅ‰∫§Êòì [${i+1}/${rpcEndpoints.length}]: ${rpcEndpoints[i]}`);
                        const tempConnection = new solanaWeb3.Connection(rpcEndpoints[i], 'confirmed');
                        signature = await tempConnection.sendRawTransaction(
                            signedTransaction.serialize(),
                            {
                                skipPreflight: false,
                                preflightCommitment: 'confirmed'
                            }
                        );
                        console.log(`‚úÖ ‰∫§ÊòìÂèëÈÄÅÊàêÂäü: ${rpcEndpoints[i]} - Á≠æÂêç: ${signature}`);
                        
                        // Êõ¥Êñ∞‰∏ªËøûÊé•‰∏∫ÊàêÂäüÁöÑÁ´ØÁÇπ
                        connection = tempConnection;
                        break;
                    } catch (sendError) {
                        console.warn(`‚ö†Ô∏è ÂèëÈÄÅ‰∫§ÊòìÂ§±Ë¥•: ${rpcEndpoints[i]} - ${sendError.message}`);
                        if (i === rpcEndpoints.length - 1) {
                            throw new Error('ÊâÄÊúâRPCÁ´ØÁÇπÂùáÊó†Ê≥ïÂèëÈÄÅ‰∫§Êòì: ' + sendError.message);
                        }
                    }
                }

                showStatus('Ê≠£Âú®Á°ÆËÆ§‰∫§Êòì...', 'info');

                // Á≠âÂæÖÁ°ÆËÆ§
                const confirmation = await connection.confirmTransaction(signature, 'confirmed');

                if (confirmation.value.err) {
                    throw new Error('‰∫§ÊòìÊâßË°åÂ§±Ë¥•');
                }

                showStatus(`‰∫§ÊòìÊàêÂäüÔºÅÁ≠æÂêç: ${signature}`, 'success');
                
                // ÈÄöÁü• iOS
                if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.phantomCallback) {
                    window.webkit.messageHandlers.phantomCallback.postMessage({
                        type: 'transaction_success',
                        signature: signature,
                        fromAddress: config.fromAddress,
                        toAddress: toAddress,
                        amount: amount,
                        tokenSymbol: config.tokenSymbol
                    });
                }

                // Êõ¥Êñ∞‰ΩôÈ¢ù
                setTimeout(updateBalance, 2000);
                
            } catch (error) {
                console.error('‰∫§ÊòìÂ§±Ë¥•:', error);
                
                let errorMessage = error.message;
                if (error.code === 4001) {
                    errorMessage = 'Áî®Êà∑ÊãíÁªùÁ≠æÂêç‰∫§Êòì';
                } else if (error.message.includes('User rejected')) {
                    errorMessage = 'Áî®Êà∑ÂèñÊ∂à‰∫Ü‰∫§Êòì';
                }
                
                showStatus(`‰∫§ÊòìÂ§±Ë¥•: ${errorMessage}`, 'error');
                
                // ÈÄöÁü• iOS
                if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.phantomCallback) {
                    window.webkit.messageHandlers.phantomCallback.postMessage({
                        type: 'transaction_error',
                        error: errorMessage,
                        fromAddress: config.fromAddress,
                        toAddress: document.getElementById('toAddress').value,
                        amount: parseFloat(document.getElementById('amount').value),
                        tokenSymbol: config.tokenSymbol
                    });
                }
                
            } finally {
                showLoading(false);
            }
        }

        // ÊòæÁ§∫Ë∞ÉËØï‰ø°ÊÅØ
        function debugWalletDetection() {
            const debugInfo = document.getElementById('debugInfo');
            const isVisible = debugInfo.style.display !== 'none';
            
            if (isVisible) {
                debugInfo.style.display = 'none';
                document.getElementById('debugBtn').textContent = 'ÊòæÁ§∫Ë∞ÉËØï‰ø°ÊÅØ';
                return;
            }
            
            let info = `Ë∞ÉËØï‰ø°ÊÅØ (${new Date().toLocaleTimeString()}):\n\n`;
            
            info += `Áî®Êà∑‰ª£ÁêÜ: ${navigator.userAgent}\n\n`;
            
            info += `window.solana Â≠òÂú®: ${window.solana ? '‚úÖ ÊòØ' : '‚ùå Âê¶'}\n`;
            if (window.solana) {
                info += `  - isPhantom: ${window.solana.isPhantom}\n`;
                info += `  - isConnected: ${window.solana.isConnected}\n`;
                info += `  - publicKey: ${window.solana.publicKey ? window.solana.publicKey.toString() : 'null'}\n`;
            }
            
            info += `\nÂÖ∂‰ªñÈí±ÂåÖÊ£ÄÊµã:\n`;
            info += `window.ethereum: ${window.ethereum ? '‚úÖ Â≠òÂú®' : '‚ùå ‰∏çÂ≠òÂú®'}\n`;
            info += `window.phantom: ${window.phantom ? '‚úÖ Â≠òÂú®' : '‚ùå ‰∏çÂ≠òÂú®'}\n`;
            
            info += `\nÈ°µÈù¢ÁéØÂ¢É:\n`;
            info += `ÂçèËÆÆ: ${location.protocol}\n`;
            info += `ÂüüÂêç: ${location.hostname}\n`;
            info += `Á´ØÂè£: ${location.port || 'ÈªòËÆ§'}\n`;
            info += `ÂÆåÊï¥URL: ${location.href}\n`;
            
            info += `\nSolana Web3.js:\n`;
            info += `solanaWeb3 ÂØπË±°: ${typeof solanaWeb3 !== 'undefined' ? '‚úÖ Â∑≤Âä†ËΩΩ' : '‚ùå Êú™Âä†ËΩΩ'}\n`;
            if (typeof solanaWeb3 !== 'undefined') {
                info += `Connection Á±ª: ${solanaWeb3.Connection ? '‚úÖ ÂèØÁî®' : '‚ùå ‰∏çÂèØÁî®'}\n`;
                info += `PublicKey Á±ª: ${solanaWeb3.PublicKey ? '‚úÖ ÂèØÁî®' : '‚ùå ‰∏çÂèØÁî®'}\n`;
            }
            
            info += `\niOS WebView Ê°•Êé•:\n`;
            info += `webkit ÂØπË±°: ${window.webkit ? '‚úÖ Â≠òÂú®' : '‚ùå ‰∏çÂ≠òÂú®'}\n`;
            if (window.webkit && window.webkit.messageHandlers) {
                info += `messageHandlers: ‚úÖ Â≠òÂú®\n`;
                info += `phantomCallback: ${window.webkit.messageHandlers.phantomCallback ? '‚úÖ Â∑≤Ê≥®ÂÜå' : '‚ùå Êú™Ê≥®ÂÜå'}\n`;
            }
            
            debugInfo.textContent = info;
            debugInfo.style.display = 'block';
            document.getElementById('debugBtn').textContent = 'ÈöêËóèË∞ÉËØï‰ø°ÊÅØ';
        }

        // ‰ªéiOSÊé•Êî∂ÈÖçÁΩÆÂπ∂Êõ¥Êñ∞È°µÈù¢
        window.setTransactionConfig = function(jsonString) {
            try {
                const data = JSON.parse(jsonString);
                console.log('üì± Êî∂Âà∞iOSÈÖçÁΩÆÂèÇÊï∞:', data);
                
                // ÂêàÂπ∂ÈÖçÁΩÆ
                config = { ...config, ...data };
                
                // Êõ¥Êñ∞È°µÈù¢Ê†áÈ¢ò
                document.getElementById('pageTitle').textContent = 
                    `${config.tokenName || config.tokenSymbol || 'Solana'} ËΩ¨Ë¥¶`;
                
                // Êõ¥Êñ∞UIË°®Âçï
                document.getElementById('tokenName').textContent = config.tokenName || config.tokenSymbol || 'Solana';
                document.getElementById('network').textContent = config.network || 'Solana';
                document.getElementById('fromAddress').value = config.fromAddress || '';
                
                // Êõ¥Êñ∞ÊúÄÂ§ßÂèØÊèêÂ∏ÅÊï∞ÈáèÊòæÁ§∫
                document.getElementById('maxAmountInfo').textContent = 
                    `ÊúÄÂ§ßÂèØÊèêÂ∏ÅÊï∞ÈáèÔºö${config.maxAmount || 0} ${config.tokenSymbol || 'SOL'}`;
                
                // Êõ¥Êñ∞ÈáëÈ¢ùËæìÂÖ•Ê°ÜÁöÑÊúÄÂ§ßÂÄº
                const amountInput = document.getElementById('amount');
                if (config.maxAmount > 0) {
                    amountInput.max = config.maxAmount;
                    amountInput.placeholder = `ËØ∑ËæìÂÖ•ÈáëÈ¢ù (ÊúÄÂ§ß: ${config.maxAmount})`;
                } else {
                    amountInput.placeholder = `ËØ∑ËæìÂÖ•ÈáëÈ¢ù`;
                }
                
                showStatus('ÈÖçÁΩÆÂä†ËΩΩÂÆåÊàêÔºåËØ∑ËøûÊé•Èí±ÂåÖ', 'success');
                
                console.log('‚úÖ [Config] ‰∫§ÊòìÈÖçÁΩÆÊõ¥Êñ∞ÂÆåÊàê:', config);
                
            } catch (error) {
                console.error('‚ùå [Config] ÈÖçÁΩÆËß£ÊûêÂ§±Ë¥•:', error);
                showStatus('ÈÖçÁΩÆÂä†ËΩΩÂ§±Ë¥•: ' + error.message, 'error');
            }
        };

        // ‰∫ã‰ª∂ÁõëÂê¨Âô®
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üì± È°µÈù¢Âä†ËΩΩÂÆåÊàê');
            
            // ÁªëÂÆö‰∫ã‰ª∂
            document.getElementById('connectBtn').addEventListener('click', connectPhantom);
            document.getElementById('submitBtn').addEventListener('click', executeTransaction);
            document.getElementById('debugBtn').addEventListener('click', debugWalletDetection);
            
            // Ê£ÄÊµãÈí±ÂåÖ
            showStatus('Ê≠£Âú®Ê£ÄÊµãÈí±ÂåÖÁéØÂ¢É...', 'info');
            
            const detected = await detectPhantom();
            if (detected) {
                showStatus('Èí±ÂåÖÁéØÂ¢ÉÊ£ÄÊµãÊàêÂäüÔºåËØ∑ÁÇπÂáªËøûÊé•', 'success');
            } else {
                showStatus('Êú™Ê£ÄÊµãÂà∞Èí±ÂåÖÔºåËØ∑Á°Æ‰øùÂ∑≤ÂÆâË£Ö Phantom', 'error');
            }
        });

        // ÂÖºÂÆπÊÄßÂà´Âêç
        window.setConfig = window.setTransactionConfig;
    </script>
</body>
</html>
