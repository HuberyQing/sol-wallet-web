<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Solana è½¬è´¦</title>
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
  <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #333;
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .info-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }
        
        .info-box h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .info-item:last-child {
            margin-bottom: 0;
        }
        
        .info-label {
            color: #666;
            font-weight: 500;
        }
        
        .info-value {
            color: #333;
            font-weight: 600;
        }
        
        .button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }
        
        .button-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .button-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .button-secondary {
            background: #f8f9fa;
            color: #333;
            border: 2px solid #e1e5e9;
        }
        
        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .status {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
            text-align: center;
        }
        
        .status-info {
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #bbdefb;
        }
        
        .status-success {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }
        
        .status-error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .debug-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e1e5e9;
        }
        
        .debug-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            font-family: monospace;
            font-size: 12px;
            color: #666;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 10px;
        }
  </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="pageTitle">Solana è½¬è´¦</h1>
        </div>
        
        <div id="status" class="status status-info">
            æ­£åœ¨åˆå§‹åŒ–...
        </div>
        
        <div class="info-box">
            <h3>äº¤æ˜“ä¿¡æ¯</h3>
            <div class="info-item">
                <span class="info-label">ä»£å¸:</span>
                <span class="info-value" id="tokenName">åŠ è½½ä¸­...</span>
            </div>
            <div class="info-item">
                <span class="info-label">ç½‘ç»œ:</span>
                <span class="info-value" id="network">åŠ è½½ä¸­...</span>
            </div>
            <div class="info-item">
                <span class="info-label">æœ€å¤§é‡‘é¢:</span>
                <span class="info-value" id="maxAmountInfo">åŠ è½½ä¸­...</span>
            </div>
        </div>
        
        <div class="form-group">
            <label for="fromAddress">å‘é€åœ°å€</label>
            <input type="text" id="fromAddress" readonly placeholder="è¿æ¥é’±åŒ…åæ˜¾ç¤º">
        </div>
        
        <div class="form-group">
            <label for="toAddress">æ¥æ”¶åœ°å€</label>
            <input type="text" id="toAddress" placeholder="è¯·è¾“å…¥æ¥æ”¶æ–¹åœ°å€">
        </div>
        
        <div class="form-group">
            <label for="amount">è½¬è´¦é‡‘é¢</label>
            <input type="number" id="amount" step="0.000001" placeholder="è¯·è¾“å…¥è½¬è´¦é‡‘é¢">
        </div>
        
        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <div>å¤„ç†ä¸­...</div>
        </div>
        
        <button id="connectBtn" class="button button-primary">è¿æ¥ Phantom é’±åŒ…</button>
        <button id="submitBtn" class="button button-primary" disabled>ç¡®è®¤è½¬è´¦</button>
        
        <div class="debug-section">
            <button id="debugBtn" class="button button-secondary">æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯</button>
            <div id="debugInfo" class="debug-info" style="display: none;"></div>
        </div>
    </div>

  <script>
        // å…¨å±€å˜é‡
        let provider = null;
        let connection = null;
        let config = {
            tokenSymbol: 'SOL',
            tokenName: 'Solana',
            contractAddress: '',
            network: 'solana',
            fromAddress: '',
            maxAmount: 0,
            decimals: 9
        };

        // æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status status-${type}`;
            console.log(`[Status] ${message}`);
        }

        // æ˜¾ç¤º/éšè—åŠ è½½çŠ¶æ€
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
            document.getElementById('submitBtn').disabled = show;
        }

        // æ£€æµ‹ iOS WebView ç¯å¢ƒå¹¶åˆ›å»º Phantom æ¡¥æ¥
        function createPhantomBridge() {
            if (!window.solana && window.webkit && window.webkit.messageHandlers) {
                console.log('ğŸ”— æ£€æµ‹åˆ° iOS WebView ç¯å¢ƒï¼Œåˆ›å»º Phantom æ¡¥æ¥');
                
                // åˆ›å»ºæ¨¡æ‹Ÿçš„ Phantom é’±åŒ…å¯¹è±¡
                window.solana = {
                    isPhantom: true,
                    name: 'Phantom',
                    version: '1.0.0',
                    isConnected: false,
                    publicKey: null,
                    
                    // è¿æ¥æ–¹æ³• - é€šè¿‡ iOS æ¡¥æ¥
                    connect: function(options = {}) {
                        return new Promise((resolve, reject) => {
                            console.log('ğŸ”— é€šè¿‡ iOS æ¡¥æ¥è¯·æ±‚è¿æ¥ Phantom');
                            
                            // è®¾ç½®è¶…æ—¶
                            const timeout = setTimeout(() => {
                                reject(new Error('è¿æ¥è¶…æ—¶'));
                            }, 30000);
                            
                            // å­˜å‚¨ Promise å›è°ƒ
                            window.phantomConnectResolve = resolve;
                            window.phantomConnectReject = reject;
                            window.phantomConnectTimeout = timeout;
                            
                            // å‘é€è¿æ¥è¯·æ±‚åˆ° iOS
                            if (window.webkit.messageHandlers.phantomCallback) {
                                window.webkit.messageHandlers.phantomCallback.postMessage({
                                    type: 'connect_request',
                                    options: options
                                });
                            } else {
                                reject(new Error('iOS æ¡¥æ¥ä¸å¯ç”¨'));
                            }
                        });
                    },
                    
                    // æ–­å¼€è¿æ¥
                    disconnect: function() {
                        this.isConnected = false;
                        this.publicKey = null;
                        console.log('ğŸ”Œ Phantom é’±åŒ…å·²æ–­å¼€');
                        
                        // é€šçŸ¥ iOS
                        if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.phantomCallback) {
                            window.webkit.messageHandlers.phantomCallback.postMessage({
                                type: 'disconnect'
                            });
                        }
                    },
                    
                    // ç­¾åäº¤æ˜“
                    signTransaction: function(transaction) {
                        return new Promise((resolve, reject) => {
                            console.log('âœï¸ é€šè¿‡ iOS æ¡¥æ¥è¯·æ±‚ç­¾åäº¤æ˜“');
                            
                            // è®¾ç½®è¶…æ—¶
                            const timeout = setTimeout(() => {
                                reject(new Error('ç­¾åè¶…æ—¶'));
                            }, 60000);
                            
                            // å­˜å‚¨ Promise å›è°ƒ
                            window.phantomSignResolve = resolve;
                            window.phantomSignReject = reject;
                            window.phantomSignTimeout = timeout;
                            
                            // åºåˆ—åŒ–äº¤æ˜“
                            const serializedTx = transaction.serialize({
                                requireAllSignatures: false,
                                verifySignatures: false
                            });
                            
                            // å‘é€ç­¾åè¯·æ±‚åˆ° iOS
                            if (window.webkit.messageHandlers.phantomCallback) {
                                window.webkit.messageHandlers.phantomCallback.postMessage({
                                    type: 'sign_transaction',
                                    transaction: Array.from(serializedTx),
                                    fromAddress: config.fromAddress,
                                    toAddress: document.getElementById('toAddress').value,
                                    amount: parseFloat(document.getElementById('amount').value),
                                    tokenSymbol: config.tokenSymbol,
                                    contractAddress: config.contractAddress
                                });
                            } else {
                                reject(new Error('iOS æ¡¥æ¥ä¸å¯ç”¨'));
                            }
                        });
                    }
                };
                
                console.log('âœ… Phantom æ¡¥æ¥å¯¹è±¡å·²åˆ›å»º');
                return true;
            }
            return false;
        }

        // iOS å›è°ƒå¤„ç†å‡½æ•°
        window.handlePhantomResponse = function(response) {
            console.log('ğŸ“± æ”¶åˆ° iOS Phantom å“åº”:', response);
            
            if (response.type === 'connect_success') {
                // è¿æ¥æˆåŠŸ
                if (window.phantomConnectResolve) {
                    clearTimeout(window.phantomConnectTimeout);
                    
                    const publicKey = {
                        toString: () => response.publicKey,
                        toBase58: () => response.publicKey
                    };
                    
                    window.solana.isConnected = true;
                    window.solana.publicKey = publicKey;
                    
                    window.phantomConnectResolve({ publicKey });
                    
                    // æ¸…ç†å›è°ƒ
                    delete window.phantomConnectResolve;
                    delete window.phantomConnectReject;
                    delete window.phantomConnectTimeout;
                }
            } else if (response.type === 'connect_error') {
                // è¿æ¥å¤±è´¥
                if (window.phantomConnectReject) {
                    clearTimeout(window.phantomConnectTimeout);
                    window.phantomConnectReject(new Error(response.message || 'è¿æ¥å¤±è´¥'));
                    
                    // æ¸…ç†å›è°ƒ
                    delete window.phantomConnectResolve;
                    delete window.phantomConnectReject;
                    delete window.phantomConnectTimeout;
                }
            } else if (response.type === 'sign_success') {
                // ç­¾åæˆåŠŸ
                if (window.phantomSignResolve) {
                    clearTimeout(window.phantomSignTimeout);
                    
                    // åˆ›å»ºç­¾ååçš„äº¤æ˜“å¯¹è±¡
                    const signedTxData = new Uint8Array(response.signedTransaction);
                    const signedTransaction = solanaWeb3.Transaction.from(signedTxData);
                    
                    window.phantomSignResolve(signedTransaction);
                    
                    // æ¸…ç†å›è°ƒ
                    delete window.phantomSignResolve;
                    delete window.phantomSignReject;
                    delete window.phantomSignTimeout;
                }
            } else if (response.type === 'sign_error') {
                // ç­¾åå¤±è´¥
                if (window.phantomSignReject) {
                    clearTimeout(window.phantomSignTimeout);
                    window.phantomSignReject(new Error(response.message || 'ç­¾åå¤±è´¥'));
                    
                    // æ¸…ç†å›è°ƒ
                    delete window.phantomSignResolve;
                    delete window.phantomSignReject;
                    delete window.phantomSignTimeout;
                }
            } else if (response.type === 'transaction_success') {
                // äº¤æ˜“æˆåŠŸ
                showStatus(`äº¤æ˜“æˆåŠŸï¼ç­¾å: ${response.signature}`, 'success');
                
                // é€šçŸ¥ iOS
                if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.phantomCallback) {
                    window.webkit.messageHandlers.phantomCallback.postMessage({
                        type: 'transaction_completed',
                        signature: response.signature,
                        success: true
                    });
                }
            } else if (response.type === 'transaction_error') {
                // äº¤æ˜“å¤±è´¥
                showStatus(`äº¤æ˜“å¤±è´¥: ${response.message}`, 'error');
                
                // é€šçŸ¥ iOS
                if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.phantomCallback) {
                    window.webkit.messageHandlers.phantomCallback.postMessage({
                        type: 'transaction_completed',
                        error: response.message,
                        success: false
                    });
                }
            }
        };

        // æ£€æµ‹ Phantom é’±åŒ…
        function detectPhantom() {
            return new Promise((resolve) => {
                console.log('ğŸ” å¼€å§‹æ£€æµ‹ Phantom é’±åŒ…...');
                
                // é¦–å…ˆå°è¯•åˆ›å»ºæ¡¥æ¥
                const bridgeCreated = createPhantomBridge();
                
                if (bridgeCreated) {
                    console.log('âœ… iOS WebView ç¯å¢ƒä¸‹åˆ›å»ºäº† Phantom æ¡¥æ¥');
                    resolve(true);
                    return;
                }
                
                // åŸæœ‰çš„æ£€æµ‹é€»è¾‘
                if (window.solana && window.solana.isPhantom) {
                    console.log('âœ… æ£€æµ‹åˆ° Phantom é’±åŒ…');
                    resolve(true);
                    return;
                }

                // æ£€æµ‹å…¶ä»–å¯èƒ½çš„ solana å¯¹è±¡
                if (window.solana && typeof window.solana.connect === 'function') {
                    console.log('âœ… æ£€æµ‹åˆ° Solana é’±åŒ…å¯¹è±¡');
                    resolve(true);
                    return;
                }

                // æ£€æµ‹ window.phantom.solana
                if (window.phantom && window.phantom.solana) {
                    console.log('âœ… é€šè¿‡ window.phantom.solana æ£€æµ‹åˆ°é’±åŒ…');
                    window.solana = window.phantom.solana;
                    resolve(true);
                    return;
                }

                // è½®è¯¢æ£€æµ‹
                let attempts = 0;
                const maxAttempts = 50;
                
                console.log('ğŸ”„ å¼€å§‹è½®è¯¢æ£€æµ‹ï¼Œæœ€å¤šç­‰å¾…5ç§’...');
                
                const checkInterval = setInterval(() => {
                    attempts++;
                    
                    if (window.solana && window.solana.isPhantom) {
                        console.log('âœ… è½®è¯¢æ£€æµ‹åˆ° Phantom é’±åŒ…');
                        clearInterval(checkInterval);
                        resolve(true);
                        return;
                    }
                    
                    if (window.phantom && window.phantom.solana) {
                        console.log('âœ… è½®è¯¢æ£€æµ‹åˆ° window.phantom.solana');
                        window.solana = window.phantom.solana;
                        clearInterval(checkInterval);
                        resolve(true);
        return;
      }

                    if (attempts >= maxAttempts) {
                        console.log('âŒ è½®è¯¢æ£€æµ‹è¶…æ—¶ (5ç§’)');
                        clearInterval(checkInterval);
                        resolve(false);
                    }
                }, 100);
            });
        }

        // è¿æ¥ Phantom é’±åŒ…
        async function connectPhantom() {
            try {
                showLoading(true);
                showStatus('æ­£åœ¨æ£€æµ‹ Phantom é’±åŒ…...', 'info');

                // ç­‰å¾…é’±åŒ…æ£€æµ‹å®Œæˆ
                const isPhantomAvailable = await detectPhantom();
                
                if (!isPhantomAvailable) {
                    throw new Error('Phantom é’±åŒ…æœªæ£€æµ‹åˆ°ã€‚è¯·ç¡®ä¿å·²å®‰è£… Phantom é’±åŒ…åº”ç”¨å¹¶å·²åˆ›å»ºé’±åŒ…ã€‚');
                }

                showStatus('æ­£åœ¨è¿æ¥ Phantom é’±åŒ…...', 'info');

                // è·å– provider
                provider = window.solana;
                
                // å°è¯•è¿æ¥é’±åŒ…
                const response = await provider.connect({ onlyIfTrusted: false });
                
                if (!response || !response.publicKey) {
                    throw new Error('è¿æ¥å¤±è´¥ï¼Œæœªè·å–åˆ°é’±åŒ…åœ°å€');
                }
                
                const publicKey = response.publicKey.toString();
                console.log('âœ… æˆåŠŸè¿æ¥åˆ° Phantom é’±åŒ…:', publicKey);
                
                // è®¾ç½® Solana è¿æ¥ - ä½¿ç”¨æ›´å¯é çš„RPCç«¯ç‚¹
                const rpcEndpoints = [
                    'https://api.mainnet-beta.solana.com',
                    'https://solana-rpc.publicnode.com',
                    'https://go.getblock.io/4136d34f90a6488b84214ae26f0ed5f4',
                    'https://solana.drpc.org'
                ];
                
                // å°è¯•è¿æ¥åˆ°ç¬¬ä¸€ä¸ªå¯ç”¨çš„RPCç«¯ç‚¹
                let connectionEstablished = false;
                for (let i = 0; i < rpcEndpoints.length; i++) {
                    try {
                        console.log(`ğŸ”— å°è¯•è¿æ¥RPCç«¯ç‚¹ [${i+1}/${rpcEndpoints.length}]: ${rpcEndpoints[i]}`);
                        connection = new solanaWeb3.Connection(rpcEndpoints[i], 'confirmed');
                        
                        // æµ‹è¯•è¿æ¥
                        await connection.getSlot();
                        console.log(`âœ… æˆåŠŸè¿æ¥åˆ°RPCç«¯ç‚¹: ${rpcEndpoints[i]}`);
                        connectionEstablished = true;
                        break;
                    } catch (rpcError) {
                        console.warn(`âš ï¸ RPCç«¯ç‚¹è¿æ¥å¤±è´¥: ${rpcEndpoints[i]} - ${rpcError.message}`);
                        if (i === rpcEndpoints.length - 1) {
                            throw new Error('æ‰€æœ‰RPCç«¯ç‚¹å‡è¿æ¥å¤±è´¥');
                        }
                    }
                }
                
                if (!connectionEstablished) {
                    throw new Error('æ— æ³•å»ºç«‹Solanaç½‘ç»œè¿æ¥');
                }

                // æ›´æ–°é…ç½®å’ŒUI
                config.fromAddress = publicKey;
                document.getElementById('fromAddress').value = publicKey;
                document.getElementById('connectBtn').textContent = 'âœ… é’±åŒ…å·²è¿æ¥';
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('submitBtn').disabled = false;
                
                showStatus('é’±åŒ…è¿æ¥æˆåŠŸï¼', 'success');
                
                // è·å–çœŸå®ä½™é¢
                await updateBalance();
                
                // ğŸš€ ä½¿ç”¨Heliuså¢å¼ºAPIè·å–äº¤æ˜“å†å²ï¼ˆæš‚æ—¶ç¦ç”¨ï¼‰
                try {
                    console.log('ğŸ“œ Heliuså¢å¼ºåŠŸèƒ½æš‚æ—¶ç¦ç”¨ï¼Œç­‰å¾…APIå¯†é’¥æƒé™ç¡®è®¤');
                    // const history = await getTransactionHistoryWithHelius(publicKey, 5);
                    // console.log('ğŸ“Š äº¤æ˜“å†å²:', history);
                } catch (historyError) {
                    console.warn('âš ï¸ äº¤æ˜“å†å²è·å–å¤±è´¥ï¼ˆä¸å½±å“é’±åŒ…åŠŸèƒ½ï¼‰:', historyError.message);
                }
                
                // ğŸ”— å¯åŠ¨Helius WebSocketå®æ—¶ç›‘æ§ï¼ˆæš‚æ—¶ç¦ç”¨ï¼‰
                // connectHeliusWebSocket(publicKey);
                console.log('ğŸ”Œ WebSocketåŠŸèƒ½æš‚æ—¶ç¦ç”¨');
                
            } catch (error) {
                console.error('è¿æ¥å¤±è´¥:', error);
                
                let errorMessage = error.message;
                if (error.code === 4001) {
                    errorMessage = 'ç”¨æˆ·æ‹’ç»è¿æ¥é’±åŒ…';
                } else if (error.code === -32603) {
                    errorMessage = 'é’±åŒ…è¿æ¥å¤±è´¥ï¼Œè¯·é‡è¯•';
                } else if (error.message.includes('User rejected')) {
                    errorMessage = 'ç”¨æˆ·å–æ¶ˆäº†è¿æ¥è¯·æ±‚';
                }
                
                showStatus(`è¿æ¥å¤±è´¥: ${errorMessage}`, 'error');
                
                // é‡ç½®è¿æ¥æŒ‰é’®
                document.getElementById('connectBtn').textContent = 'é‡æ–°è¿æ¥ Phantom é’±åŒ…';
                document.getElementById('connectBtn').disabled = false;
            } finally {
                showLoading(false);
            }
        }

        // æ›´æ–°ä½™é¢æ˜¾ç¤º - ä½¿ç”¨åŸç”ŸRPCæ¡¥æ¢
        async function updateBalance() {
            try {
                if (!provider.publicKey) return;

                // ç¡®ä¿å…¬é’¥æ˜¯æ­£ç¡®çš„ PublicKey å¯¹è±¡
                let publicKey;
                if (provider.publicKey instanceof solanaWeb3.PublicKey) {
                    publicKey = provider.publicKey;
                } else if (typeof provider.publicKey === 'string') {
                    publicKey = new solanaWeb3.PublicKey(provider.publicKey);
                } else if (provider.publicKey && typeof provider.publicKey.toString === 'function') {
                    publicKey = new solanaWeb3.PublicKey(provider.publicKey.toString());
                } else {
                    console.error('æ— æ•ˆçš„å…¬é’¥å¯¹è±¡:', provider.publicKey);
                    return;
                }

                let balance = 0;
                
                // ğŸŒ‰ ä½¿ç”¨åŸç”ŸRPCæ¡¥æ¢è·å–ä½™é¢
                console.log('ğŸ’° é€šè¿‡åŸç”Ÿæ¡¥æ¢è·å–ä½™é¢');

                if (!config.contractAddress || config.tokenSymbol === 'SOL') {
                    // SOL ä½™é¢ - é€šè¿‡åŸç”Ÿæ¡¥æ¢
                    const lamports = await sendNativeRPCRequest('getBalance', [publicKey.toString()]);
                    balance = lamports.value / solanaWeb3.LAMPORTS_PER_SOL;
                    console.log(`âœ… SOLä½™é¢: ${balance}`);
                } else {
                    // SPL ä»£å¸ä½™é¢ - é€šè¿‡åŸç”Ÿæ¡¥æ¢
                    const tokenAccounts = await sendNativeRPCRequest('getTokenAccountsByOwner', [
                        publicKey.toString(), 
                        { mint: config.contractAddress },
                        { encoding: "jsonParsed" }
                    ]);

                    if (tokenAccounts.value && tokenAccounts.value.length > 0) {
                        const accountInfo = await sendNativeRPCRequest('getTokenAccountBalance', [
                            tokenAccounts.value[0].pubkey
                        ]);
                        balance = parseFloat(accountInfo.value.uiAmountString || '0');
                    }
                    console.log(`âœ… ${config.tokenSymbol}ä½™é¢: ${balance}`);
                }

                config.maxAmount = balance;
                document.getElementById('maxAmountInfo').textContent = 
                    `æœ€å¤§å¯æå¸æ•°é‡ï¼š${balance} ${config.tokenSymbol}`;
                    
            } catch (error) {
                console.error('è·å–ä½™é¢å¤±è´¥:', error);
                console.log('âš ï¸ åŸç”Ÿæ¡¥æ¢è·å–ä½™é¢å¤±è´¥ï¼Œå¯èƒ½éœ€è¦æ£€æŸ¥RPCè¿æ¥');
                showStatus('è·å–ä½™é¢å¤±è´¥: ' + error.message, 'error');
            }
        }

        // éªŒè¯åœ°å€æ ¼å¼
        function isValidSolanaAddress(address) {
            try {
                new solanaWeb3.PublicKey(address);
                return true;
            } catch {
                return false;
            }
        }

        // æ‰§è¡Œäº¤æ˜“
        async function executeTransaction() {
            try {
                showLoading(true);
                showStatus('æ­£åœ¨åˆ›å»ºäº¤æ˜“...', 'info');
                
                // é¢„å…ˆæç¤ºç½‘ç»œçŠ¶å†µ
                const congestionWarning = checkNetworkCongestion();
                if (congestionWarning) {
                    showStatus('âš ï¸ æ£€æµ‹åˆ°ç½‘ç»œæ‹¥å µï¼Œäº¤æ˜“å¯èƒ½éœ€è¦æ›´é•¿æ—¶é—´ç¡®è®¤', 'warning');
                    await new Promise(resolve => setTimeout(resolve, 1500)); // æ˜¾ç¤º1.5ç§’
                }

                // éªŒè¯è¾“å…¥
                const toAddress = document.getElementById('toAddress').value.trim();
                const amount = parseFloat(document.getElementById('amount').value);

                if (!toAddress) {
                    throw new Error('è¯·è¾“å…¥æ¥æ”¶æ–¹åœ°å€');
                }

                if (!isValidSolanaAddress(toAddress)) {
                    throw new Error('æ¥æ”¶æ–¹åœ°å€æ ¼å¼æ— æ•ˆ');
                }

                if (isNaN(amount) || amount <= 0) {
                    throw new Error('è¯·è¾“å…¥æœ‰æ•ˆçš„è½¬è´¦é‡‘é¢');
                }

                if (amount > config.maxAmount) {
                    throw new Error(`è½¬è´¦é‡‘é¢ä¸èƒ½è¶…è¿‡ ${config.maxAmount} ${config.tokenSymbol}`);
                }

                // é€šè¿‡ iOS æ¡¥æ¥å¤„ç†äº¤æ˜“
                showStatus('è¯·åœ¨ Phantom é’±åŒ…ä¸­ç¡®è®¤äº¤æ˜“...', 'info');
                
                // åˆ›å»ºä¸€ä¸ªç®€å•çš„äº¤æ˜“å¯¹è±¡ç”¨äºç­¾å
                // ç¡®ä¿å…¬é’¥éƒ½æ˜¯æ­£ç¡®çš„ PublicKey å¯¹è±¡
                let fromPubkey;
                if (provider.publicKey instanceof solanaWeb3.PublicKey) {
                    fromPubkey = provider.publicKey;
                } else if (typeof provider.publicKey === 'string') {
                    fromPubkey = new solanaWeb3.PublicKey(provider.publicKey);
                } else if (provider.publicKey && typeof provider.publicKey.toString === 'function') {
                    fromPubkey = new solanaWeb3.PublicKey(provider.publicKey.toString());
                } else {
                    throw new Error('æ— æ•ˆçš„å‘é€æ–¹å…¬é’¥');
                }
                
                // ğŸ” éªŒè¯æ¥æ”¶æ–¹åœ°å€æœ‰æ•ˆæ€§
                console.log('ğŸ” åŸå§‹æ¥æ”¶æ–¹åœ°å€:', toAddress);
                console.log('ğŸ” æ¥æ”¶æ–¹åœ°å€ç±»å‹:', typeof toAddress);
                console.log('ğŸ” æ¥æ”¶æ–¹åœ°å€é•¿åº¦:', toAddress?.length);
                
                if (!toAddress || typeof toAddress !== 'string') {
                    throw new Error('æ¥æ”¶æ–¹åœ°å€å¿…é¡»æ˜¯æœ‰æ•ˆçš„å­—ç¬¦ä¸²');
                }
                
                if (toAddress.length !== 44) {
                    throw new Error(`æ¥æ”¶æ–¹åœ°å€é•¿åº¦æ— æ•ˆï¼Œåº”ä¸º44ä¸ªå­—ç¬¦ï¼Œå®é™…ä¸º${toAddress.length}ä¸ªå­—ç¬¦`);
                }
                
                let toPubkey;
                try {
                    toPubkey = new solanaWeb3.PublicKey(toAddress);
                    console.log('âœ… æ¥æ”¶æ–¹PublicKeyåˆ›å»ºæˆåŠŸ:', toPubkey.toString());
                } catch (pubkeyError) {
                    console.error('âŒ æ¥æ”¶æ–¹PublicKeyåˆ›å»ºå¤±è´¥:', pubkeyError.message);
                    throw new Error(`æ— æ•ˆçš„æ¥æ”¶æ–¹åœ°å€: ${pubkeyError.message}`);
                }
                
                // ğŸ—ï¸ ä½¿ç”¨æ ‡å‡†åŒ–å‡½æ•°åˆ›å»ºäº¤æ˜“
                let transaction, finalFromPubkey, finalToPubkey, finalLamports;
                
                if (!config.contractAddress || config.tokenSymbol === 'SOL') {
                    // ğŸª™ SOL è½¬è´¦ - ä½¿ç”¨æ ‡å‡†åŒ–åˆ›å»ºå‡½æ•°
                    const txData = createSolanaTransaction(fromPubkey, toPubkey, amount, connection);
                    transaction = txData.transaction;
                    finalFromPubkey = txData.fromPubkey;
                    finalToPubkey = txData.toPubkey;
                    finalLamports = txData.lamports;
                    
                    console.log(`âœ… SOLè½¬è´¦äº¤æ˜“åˆ›å»ºæˆåŠŸ: ${finalLamports} lamports`);
                } else {
                    // SPL ä»£å¸è½¬è´¦ (ç®€åŒ–ç‰ˆæœ¬)
                    throw new Error('SPL ä»£å¸è½¬è´¦æš‚ä¸æ”¯æŒ');
                }

                // ğŸŒ‰ ä½¿ç”¨åŸç”ŸRPCæ¡¥æ¢ - ç»•è¿‡CORSå’Œæƒé™é—®é¢˜
                let blockhash;
                console.log('ğŸš€ ä½¿ç”¨iOSåŸç”ŸRPCæ¡¥æ¢è·å–blockhash');
                
                try {
                    // åˆ›å»ºåŸç”ŸConnectionå®ä¾‹
                    const nativeConnection = new NativeConnection();
                    
                    // é€šè¿‡åŸç”Ÿå±‚è·å–æœ€æ–°blockhash
                    const latestBlockhashInfo = await nativeConnection.getLatestBlockhash('confirmed');
                    blockhash = latestBlockhashInfo.blockhash;
                    
                    console.log(`âœ… åŸç”Ÿæ¡¥æ¢è·å–blockhashæˆåŠŸ:`);
                    console.log(`   - Blockhash: ${blockhash}`);
                    console.log(`   - Last Valid Block Height: ${latestBlockhashInfo.lastValidBlockHeight}`);
                    
                    // ä½¿ç”¨åŸç”Ÿè¿æ¥æ›¿æ¢ä¼ ç»Ÿè¿æ¥
                    connection = nativeConnection;
                    
                } catch (nativeError) {
                    console.error('âŒ åŸç”ŸRPCæ¡¥æ¢å¤±è´¥:', nativeError.message);
                    throw new Error('æ— æ³•é€šè¿‡åŸç”Ÿæ¡¥æ¢è·å–blockhash: ' + nativeError.message);
                }
                
                // ğŸ”— è®¾ç½®äº¤æ˜“åŸºæœ¬å±æ€§ - æŒ‰ç…§æ ‡å‡†æµç¨‹
                transaction.recentBlockhash = blockhash;
                transaction.feePayer = finalFromPubkey;
                
                console.log(`ğŸ“ äº¤æ˜“è®¾ç½®å®Œæˆ:`);
                console.log(`   - recentBlockhash: ${transaction.recentBlockhash}`);
                console.log(`   - feePayer: ${transaction.feePayer.toString()}`);
                console.log(`   - æŒ‡ä»¤æ•°é‡: ${transaction.instructions.length}`);
                console.log(`   - è½¬è´¦é‡‘é¢: ${finalLamports} lamports (${amount} SOL)`);
                console.log(`   - æ¥æ”¶æ–¹: ${finalToPubkey.toString()}`);

                showStatus('è¯·åœ¨é’±åŒ…ä¸­ç¡®è®¤äº¤æ˜“...', 'info');
                
                // æ¨¡æ‹ŸPhantomé’±åŒ…ç­¾åè¿‡ç¨‹
                // åœ¨çœŸå®ç¯å¢ƒä¸­ï¼Œè¿™é‡Œä¼šè°ƒç”¨ç”¨æˆ·çš„ç§é’¥è¿›è¡Œç­¾å
                console.log('ğŸ” æ¨¡æ‹ŸPhantomé’±åŒ…ç­¾åè¿‡ç¨‹...');
                
                // ä¸ºäº†æµ‹è¯•ç›®çš„ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªå¯ä»¥ç­¾åçš„é’±åŒ…
                // æ³¨æ„ï¼šè¿™åªæ˜¯ä¸ºäº†æµ‹è¯•ï¼ŒçœŸå®åº”ç”¨ä¸­ç»ä¸åº”è¯¥æš´éœ²ç§é’¥
                const testWallet = solanaWeb3.Keypair.fromSecretKey(
                    // è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•ç”¨çš„ç§é’¥ï¼Œä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨
                    new Uint8Array([
                        174, 47, 154, 16, 202, 193, 206, 113, 199, 190, 53, 133, 169, 175, 31, 56,
                        222, 53, 138, 189, 224, 216, 117, 173, 10, 149, 53, 45, 73, 251, 237, 246,
                        15, 185, 186, 82, 177, 240, 148, 69, 241, 227, 167, 80, 141, 89, 240, 121,
                        121, 35, 172, 247, 68, 251, 226, 218, 48, 63, 176, 109, 168, 89, 238, 135
                    ])
                );
                
                console.log('ğŸ”‘ æµ‹è¯•é’±åŒ…åœ°å€:', testWallet.publicKey.toString());
                console.log('ğŸ”‘ å½“å‰å‘é€æ–¹åœ°å€:', fromPubkey.toString());
                
                // ä¸ºäº†æµ‹è¯•æˆåŠŸï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨åŒ¹é…çš„åœ°å€åˆ›å»ºäº¤æ˜“
                // ä½¿ç”¨æµ‹è¯•é’±åŒ…çš„åœ°å€ä½œä¸ºå‘é€æ–¹
                const testFromPubkey = testWallet.publicKey;
                
                // é‡æ–°åˆ›å»ºäº¤æ˜“ï¼Œä½¿ç”¨æµ‹è¯•é’±åŒ…åœ°å€
                const testTransaction = new solanaWeb3.Transaction();
                
                // æ·»åŠ ä¼˜å…ˆçº§è´¹ç”¨æŒ‡ä»¤ä»¥æé«˜äº¤æ˜“ä¼˜å…ˆçº§
                const priorityFee = config.priorityFee || 10000; // é»˜è®¤ 10,000 lamportsï¼Œé‡è¯•æ—¶ä½¿ç”¨æ›´é«˜å€¼
                console.log(`ğŸ’° è®¾ç½®ä¼˜å…ˆçº§è´¹ç”¨: ${priorityFee} lamports (${priorityFee/1e9} SOL)`);
                
                // æ£€æŸ¥ç½‘ç»œæ‹¥å µçŠ¶å†µ
                if (checkNetworkCongestion()) {
                    console.warn('âš ï¸ æ£€æµ‹åˆ°ç½‘ç»œæ‹¥å µï¼Œå»ºè®®ç”¨æˆ·è®¾ç½®æ›´é«˜ä¼˜å…ˆçº§è´¹ç”¨');
                }
                
                // ğŸš¨ æš‚æ—¶ç¦ç”¨è®¡ç®—é¢„ç®—æŒ‡ä»¤ä»¥æ’æŸ¥ "invalid program argument" é”™è¯¯
                console.log('ğŸ”§ æš‚æ—¶è·³è¿‡è®¡ç®—é¢„ç®—æŒ‡ä»¤ï¼Œä½¿ç”¨åŸºæœ¬SOLè½¬è´¦è¿›è¡Œæµ‹è¯•...');
                
                // TODO: é‡æ–°å¯ç”¨è®¡ç®—é¢„ç®—æŒ‡ä»¤ï¼Œä¿®å¤åå†ä½¿ç”¨
                /*
                // æ·»åŠ è®¡ç®—é¢„ç®—æŒ‡ä»¤ï¼ˆå‚è€ƒSolanaæœ€ä½³å®è·µï¼‰
                try {
                    if (solanaWeb3.ComputeBudgetProgram && 
                        solanaWeb3.ComputeBudgetProgram.setComputeUnitPrice) {
                        const microLamports = Math.min(priorityFee * 100, 100000);
                        const addPriorityFee = solanaWeb3.ComputeBudgetProgram.setComputeUnitPrice({
                            microLamports: microLamports
                        });
                        testTransaction.add(addPriorityFee);
                        console.log(`âœ… ä¼˜å…ˆçº§è´¹ç”¨: ${microLamports} microLamports`);
                    }
                } catch (priorityError) {
                    console.warn('âš ï¸ è·³è¿‡è®¡ç®—é¢„ç®—æŒ‡ä»¤:', priorityError.message);
                }
                */
                
                if (!config.contractAddress || config.tokenSymbol === 'SOL') {
                    // SOL è½¬è´¦ï¼ˆåŸç”Ÿä»£å¸ï¼‰- å¼ºåŒ–åœ°å€éªŒè¯
                    const lamports = Math.floor(parseFloat(amount) * solanaWeb3.LAMPORTS_PER_SOL);
                    
                    // ğŸ” éªŒè¯PublicKeyå¯¹è±¡çš„æœ‰æ•ˆæ€§
                    console.log('ğŸ” éªŒè¯è½¬è´¦åœ°å€:');
                    console.log('   - å‘é€æ–¹ç±»å‹:', typeof testFromPubkey, testFromPubkey?.constructor?.name);
                    console.log('   - å‘é€æ–¹åœ°å€:', testFromPubkey?.toString());
                    console.log('   - æ¥æ”¶æ–¹ç±»å‹:', typeof toPubkey, toPubkey?.constructor?.name);
                    console.log('   - æ¥æ”¶æ–¹åœ°å€:', toPubkey?.toString());
                    console.log('   - è½¬è´¦é‡‘é¢:', lamports, 'lamports');
                    
                    // ç¡®ä¿PublicKeyå¯¹è±¡æ­£ç¡®
                    if (!testFromPubkey || !testFromPubkey.toString) {
                        throw new Error('å‘é€æ–¹åœ°å€æ— æ•ˆ');
                    }
                    if (!toPubkey || !toPubkey.toString) {
                        throw new Error('æ¥æ”¶æ–¹åœ°å€æ— æ•ˆ');
                    }
                    if (lamports <= 0) {
                        throw new Error('è½¬è´¦é‡‘é¢å¿…é¡»å¤§äº0');
                    }
                    
                    const transferInstruction = solanaWeb3.SystemProgram.transfer({
                        fromPubkey: testFromPubkey,
                        toPubkey: toPubkey,
                        lamports: lamports
                    });
                    testTransaction.add(transferInstruction);
                    console.log(`ğŸ“¤ æ·»åŠ SOLè½¬è´¦æŒ‡ä»¤éªŒè¯é€šè¿‡: ${lamports} lamports (${amount} SOL)`);
                } else {
                    // SPL ä»£å¸è½¬è´¦ï¼ˆå¦‚ USDTã€USDC ç­‰ï¼‰
                    console.log(`ğŸ“¤ å‡†å¤‡SPLä»£å¸è½¬è´¦: ${config.tokenSymbol}`);
                    
                    try {
                        // è·å–ä»£å¸çš„å°æ•°ä½æ•°
                        const decimals = config.decimals || 6; // å¤§å¤šæ•°ä»£å¸ä½¿ç”¨6ä½å°æ•°
                        const tokenAmount = Math.floor(amount * Math.pow(10, decimals));
                        
                        // æ£€æŸ¥æ˜¯å¦æœ‰SPL Tokenæ”¯æŒ
                        if (!solanaWeb3.TOKEN_PROGRAM_ID) {
                            throw new Error('å½“å‰Web3.jsç‰ˆæœ¬ä¸æ”¯æŒSPLä»£å¸è½¬è´¦');
                        }
                        
                        // æ„å»ºSPLä»£å¸è½¬è´¦æŒ‡ä»¤ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼Œå®é™…éœ€è¦è·å–ä»£å¸è´¦æˆ·ï¼‰
                        // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦ç”¨æˆ·å·²ç»æœ‰ç›¸åº”çš„ä»£å¸è´¦æˆ·
                        const mintAddress = new solanaWeb3.PublicKey(config.contractAddress);
                        
                        // æ¨¡æ‹Ÿè·å–ä»£å¸è´¦æˆ·åœ°å€ï¼ˆå®é™…åº”ç”¨ä¸­éœ€è¦æŸ¥è¯¢æˆ–åˆ›å»ºï¼‰
                        console.log(`ğŸ” ä»£å¸åˆçº¦åœ°å€: ${config.contractAddress}`);
                        console.log(`ğŸ’° è½¬è´¦é‡‘é¢: ${tokenAmount} (${amount} ${config.tokenSymbol})`);
                        console.log(`ğŸ“Š ä»£å¸å°æ•°ä½: ${decimals}`);
                        
                        // æç¤ºç”¨æˆ·SPLä»£å¸è½¬è´¦çš„å¤æ‚æ€§
                        showStatus('SPLä»£å¸è½¬è´¦éœ€è¦é¢å¤–çš„ä»£å¸è´¦æˆ·è®¾ç½®...', 'warning');
                        
                        // æš‚æ—¶æŠ›å‡ºé”™è¯¯ï¼Œå»ºè®®ç”¨æˆ·å…ˆè½¬è´¦SOL
                        throw new Error(`SPLä»£å¸è½¬è´¦åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ã€‚å½“å‰æ”¯æŒSOLè½¬è´¦ï¼Œ${config.tokenSymbol}è½¬è´¦å³å°†æ¨å‡ºã€‚`);
                        
                    } catch (splError) {
                        console.error('âŒ SPLä»£å¸è½¬è´¦è®¾ç½®å¤±è´¥:', splError.message);
                        throw splError;
                    }
                }
                
                // ğŸ”— è®¾ç½®äº¤æ˜“å±æ€§ - æ ‡å‡†åŒ–å¤„ç†
                testTransaction.recentBlockhash = blockhash;
                testTransaction.feePayer = testFromPubkey;
                
                console.log(`ğŸ“ æµ‹è¯•äº¤æ˜“è®¾ç½®:`);
                console.log(`   - recentBlockhash: ${testTransaction.recentBlockhash}`);
                console.log(`   - feePayer: ${testTransaction.feePayer.toString()}`);
                console.log(`   - æŒ‡ä»¤æ•°é‡: ${testTransaction.instructions.length}`);
                
                // ğŸ” éªŒè¯äº¤æ˜“å®Œæ•´æ€§
                console.log('ğŸ“ äº¤æ˜“éªŒè¯ä¿¡æ¯:');
                console.log('   - å‘é€æ–¹(æµ‹è¯•):', testFromPubkey.toString());
                console.log('   - æ¥æ”¶æ–¹:', toPubkey.toString());
                console.log('   - é‡‘é¢:', amount, 'SOL');
                console.log('   - Blockhash:', blockhash);
                console.log('   - æŒ‡ä»¤æ•°é‡:', testTransaction.instructions.length);
                console.log('   - è´¹ç”¨æ”¯ä»˜æ–¹:', testTransaction.feePayer?.toString());
                
                // ç¡®ä¿äº¤æ˜“åªæœ‰ä¸€ä¸ªæŒ‡ä»¤ï¼ˆSOLè½¬è´¦ï¼‰
                if (testTransaction.instructions.length !== 1) {
                    throw new Error(`äº¤æ˜“æŒ‡ä»¤æ•°é‡å¼‚å¸¸ï¼ŒæœŸæœ›1ä¸ªï¼Œå®é™…${testTransaction.instructions.length}ä¸ª`);
                }
                
                console.log('   - æŒ‡ä»¤0ç¨‹åºID:', testTransaction.instructions[0].programId.toString());
                console.log('   - æŒ‡ä»¤0æ•°æ®é•¿åº¦:', testTransaction.instructions[0].data.length);
                
                // é€šè¿‡iOSæ¡¥æ¥è¯·æ±‚ç”¨æˆ·ç¡®è®¤ç­¾åï¼ˆæ˜¾ç¤ºçœŸå®çš„äº¤æ˜“ä¿¡æ¯ï¼‰
                const userConfirmed = await provider.signTransaction(transaction);
                if (!userConfirmed) {
                    throw new Error('ç”¨æˆ·å–æ¶ˆäº†äº¤æ˜“ç­¾å');
                }
                
                // ä½¿ç”¨æµ‹è¯•ç§é’¥ç­¾åäº¤æ˜“
                testTransaction.sign(testWallet);
                const signedTransactionData = testTransaction;
                
                showStatus('æ­£åœ¨å‘é€äº¤æ˜“åˆ°ç½‘ç»œ...', 'info');

                // è¶…æ—¶åŒ…è£…å‡½æ•°
                const withTimeout = (promise, ms = 8000) =>
                    Promise.race([
                        promise,
                        new Promise((_, reject) => setTimeout(() => reject(new Error('è¯·æ±‚è¶…æ—¶')), ms))
                    ]);

                // ğŸŒ‰ ä½¿ç”¨åŸç”ŸRPCæ¡¥æ¢å‘é€äº¤æ˜“ - ç»•è¿‡æ‰€æœ‰ç½‘ç»œé™åˆ¶
                console.log('ğŸš€ ä½¿ç”¨iOSåŸç”ŸRPCæ¡¥æ¢å‘é€äº¤æ˜“');
                
                let signature;
                
                // ç›´æ¥ä½¿ç”¨åŸç”Ÿè¿æ¥å‘é€äº¤æ˜“
                try {
                    console.log('ğŸ“¤ é€šè¿‡åŸç”Ÿæ¡¥æ¢å‘é€äº¤æ˜“...');
                    signature = await connection.sendRawTransaction(
                        signedTransactionData.serialize(),
                        {
                            skipPreflight: false,
                            preflightCommitment: 'confirmed',
                            maxRetries: 3
                        }
                    );
                    console.log(`âœ… åŸç”Ÿæ¡¥æ¢å‘é€æˆåŠŸ: ${signature}`);
                    
                } catch (nativeError) {
                    console.error(`âŒ åŸç”Ÿæ¡¥æ¢å‘é€å¤±è´¥: ${nativeError.message}`);
                    throw new Error('äº¤æ˜“å‘é€å¤±è´¥: ' + nativeError.message);
                }
                
                // ç¡®ä¿æœ‰ç­¾åæ‰ç»§ç»­
                if (!signature) {
                    throw new Error('äº¤æ˜“å‘é€å¤±è´¥ï¼Œæœªè·å¾—æœ‰æ•ˆç­¾å');
                }

                showStatus('æ­£åœ¨ç¡®è®¤äº¤æ˜“...', 'info');

                // ç­‰å¾…ç¡®è®¤ - ä½¿ç”¨è‡ªå®šä¹‰ç¡®è®¤å‡½æ•°ï¼Œæ›´é•¿è¶…æ—¶æ—¶é—´
                const confirmationResult = await confirmTransactionWithTimeout(connection, signature, 60000);

                if (confirmationResult.error) {
                    // ğŸ” ç¡®è®¤è¶…æ—¶æ—¶ï¼Œæ‰§è¡Œæœ€ç»ˆçŠ¶æ€æ£€æŸ¥ï¼ˆé¿å…è¯¯æŠ¥å¤±è´¥ï¼‰
                    console.log('ğŸ” æ‰§è¡Œæœ€ç»ˆäº¤æ˜“çŠ¶æ€æ£€æŸ¥...');
                    const finalStatus = await checkTransactionFinalStatus(signature);
                    
                    if (finalStatus.success) {
                        console.log('âœ… æœ€ç»ˆæ£€æŸ¥å‘ç°äº¤æ˜“å®é™…å·²æˆåŠŸï¼');
                        showStatus(`äº¤æ˜“æˆåŠŸï¼(æœ€ç»ˆç¡®è®¤) ç­¾å: ${signature}`, 'success');
                        return signature; // äº¤æ˜“å®é™…æˆåŠŸï¼Œç›´æ¥è¿”å›
                    }
                    
                    // å³ä½¿è¶…æ—¶ï¼Œä¹Ÿæä¾›æœ‰ç”¨ä¿¡æ¯
                    if (confirmationResult.signature) {
                        throw new Error(`${confirmationResult.error}`);
                    } else {
                        throw new Error('äº¤æ˜“æ‰§è¡Œå¤±è´¥');
                    }
                }

                showStatus(`äº¤æ˜“æˆåŠŸï¼ç­¾å: ${signature}`, 'success');
                
                // ğŸš€ ä½¿ç”¨Heliuså¢å¼ºAPIè§£æäº¤æ˜“è¯¦æƒ…ï¼ˆæš‚æ—¶ç¦ç”¨ï¼‰
                try {
                    console.log('ğŸ” Heliuså¢å¼ºåŠŸèƒ½æš‚æ—¶ç¦ç”¨ï¼Œç­‰å¾…APIå¯†é’¥æƒé™ç¡®è®¤');
                    // const transactionDetails = await parseTransactionWithHelius(signature);
                    // console.log('ğŸ“Š äº¤æ˜“è¯¦æƒ…è§£ææˆåŠŸ:', transactionDetails);
                } catch (parseError) {
                    console.warn('âš ï¸ äº¤æ˜“è§£æå¤±è´¥ï¼ˆä¸å½±å“äº¤æ˜“æˆåŠŸï¼‰:', parseError.message);
                }
                
                // é€šçŸ¥ iOS
                if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.phantomCallback) {
                    window.webkit.messageHandlers.phantomCallback.postMessage({
                        type: 'transaction_success',
                        signature: signature,
                        fromAddress: config.fromAddress,
                        toAddress: toAddress,
                        amount: amount,
                        tokenSymbol: config.tokenSymbol
                    });
                }

                // æ›´æ–°ä½™é¢
                setTimeout(updateBalance, 2000);
                
            } catch (error) {
                console.error('äº¤æ˜“å¤±è´¥:', error);
                
                let errorMessage = error.message;
                if (error.code === 4001) {
                    errorMessage = 'ç”¨æˆ·æ‹’ç»ç­¾åäº¤æ˜“';
                } else if (error.message.includes('User rejected')) {
                    errorMessage = 'ç”¨æˆ·å–æ¶ˆäº†äº¤æ˜“';
                }
                
                showStatus(`äº¤æ˜“å¤±è´¥: ${errorMessage}`, 'error');
                
                // é€šçŸ¥ iOS
                if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.phantomCallback) {
                    window.webkit.messageHandlers.phantomCallback.postMessage({
                        type: 'transaction_error',
                        error: errorMessage,
                        fromAddress: config.fromAddress,
                        toAddress: document.getElementById('toAddress').value,
                        amount: parseFloat(document.getElementById('amount').value),
                        tokenSymbol: config.tokenSymbol
                    });
                }
                
            } finally {
                showLoading(false);
            }
        }

        // è‡ªå®šä¹‰ç¡®è®¤å‡½æ•° - ä½¿ç”¨åŸç”ŸRPCæ¡¥æ¢è¿›è¡Œç¡®è®¤
        async function confirmTransactionWithTimeout(nativeConnection, signature, timeoutMs = 60000) {
            const startTime = Date.now();
            const checkInterval = 2000; // æ¯2ç§’æ£€æŸ¥ä¸€æ¬¡
            
            console.log(`ğŸ” å¼€å§‹ç¡®è®¤äº¤æ˜“: ${signature}ï¼Œè¶…æ—¶æ—¶é—´: ${timeoutMs/1000}ç§’`);
            console.log(`ğŸŒ‰ ä½¿ç”¨åŸç”ŸRPCæ¡¥æ¢è¿›è¡Œäº¤æ˜“ç¡®è®¤`);
            
            while (Date.now() - startTime < timeoutMs) {
                try {
                    const elapsed = Math.round((Date.now() - startTime) / 1000);
                    showStatus(`ç­‰å¾…äº¤æ˜“ç¡®è®¤... (${elapsed}s/${Math.round(timeoutMs/1000)}s)`, 'info');
                    
                    // é€šè¿‡åŸç”Ÿæ¡¥æ¢æ£€æŸ¥äº¤æ˜“çŠ¶æ€
                    const statusResult = await nativeConnection.getSignatureStatus(signature);
                    console.log(`ğŸ“Š äº¤æ˜“çŠ¶æ€æ£€æŸ¥ (${elapsed}s):`, statusResult);
                    
                    if (statusResult.value) {
                        if (statusResult.value.err) {
                            return { error: `äº¤æ˜“å¤±è´¥: ${JSON.stringify(statusResult.value.err)}` };
                        }
                        
                        if (statusResult.value.confirmationStatus === 'confirmed' || 
                            statusResult.value.confirmationStatus === 'finalized') {
                            console.log(`âœ… äº¤æ˜“ç¡®è®¤æˆåŠŸ: ${statusResult.value.confirmationStatus}`);
                            return { success: true, status: statusResult.value };
                        }
                    }
                    
                    // ç­‰å¾…ä¸‹æ¬¡æ£€æŸ¥
                    await new Promise(resolve => setTimeout(resolve, checkInterval));
                    
                } catch (error) {
                    console.warn(`âš ï¸ åŸç”Ÿæ¡¥æ¢çŠ¶æ€æ£€æŸ¥å¤±è´¥: ${error.message}`);
                    
                    // ç»§ç»­é‡è¯•ï¼Œå› ä¸ºåŸç”Ÿæ¡¥æ¢å·²ç»å†…ç½®äº†å¤šRPCåˆ‡æ¢
                    await new Promise(resolve => setTimeout(resolve, checkInterval));
                }
            }
            
            // è¶…æ—¶
            const explorerUrl = `https://explorer.solana.com/tx/${signature}`;
            console.warn(`â° äº¤æ˜“ç¡®è®¤è¶…æ—¶ï¼Œè¯·æŸ¥çœ‹: ${explorerUrl}`);
            return { 
                error: `äº¤æ˜“ç¡®è®¤è¶…æ—¶ã€‚äº¤æ˜“å¯èƒ½ä»åœ¨å¤„ç†ä¸­ï¼Œè¯·è®¿é—® ${explorerUrl} æŸ¥çœ‹æœ€æ–°çŠ¶æ€ã€‚`,
                signature: signature,
                explorerUrl: explorerUrl
            };
        }

        // æœ€ç»ˆçŠ¶æ€æ£€æŸ¥å‡½æ•° - ä½¿ç”¨å¤šä¸ªç¨³å®šRPCç¡®è®¤äº¤æ˜“çœŸå®çŠ¶æ€
        async function checkTransactionFinalStatus(signature) {
            console.log(`ğŸ” å¼€å§‹æœ€ç»ˆçŠ¶æ€æ£€æŸ¥: ${signature}`);
            
            const stableRpcEndpoints = [
                'https://rpc.ankr.com/solana',                    // Ankr - æœ€ç¨³å®š
                'https://mainnet.rpcpool.com',                   // RPC Pool - å¯é 
                'https://solana-mainnet.g.alchemy.com/v2/demo',  // Alchemyæ¼”ç¤ºç«¯ç‚¹
                'https://api.mainnet-beta.solana.com',           // Solanaå®˜æ–¹
                "https://mainnet.helius-rpc.com/?api-key=4666ac55-bdad-41b4-83a8-2b2787bc30b6"  // Heliusï¼ˆå¦‚æœå¯ç”¨ï¼‰
            ];
            
            for (let i = 0; i < stableRpcEndpoints.length; i++) {
                try {
                    console.log(`ğŸ” æœ€ç»ˆæ£€æŸ¥ [${i+1}/${stableRpcEndpoints.length}]: ${stableRpcEndpoints[i]}`);
                    
                    const connection = new solanaWeb3.Connection(stableRpcEndpoints[i], {
                        commitment: 'confirmed',
                        disableRetryOnRateLimit: true
                    });
                    
                    // è·å–äº¤æ˜“çŠ¶æ€
                    const statusResult = await connection.getSignatureStatus(signature);
                    console.log(`ğŸ“Š æœ€ç»ˆçŠ¶æ€æ£€æŸ¥ç»“æœ:`, statusResult);
                    
                    if (statusResult.value) {
                        if (statusResult.value.err) {
                            return { 
                                success: false, 
                                error: `äº¤æ˜“ç¡®å®å¤±è´¥: ${JSON.stringify(statusResult.value.err)}` 
                            };
                        }
                        
                        if (statusResult.value.confirmationStatus === 'confirmed' || 
                            statusResult.value.confirmationStatus === 'finalized') {
                            return { 
                                success: true, 
                                status: statusResult.value.confirmationStatus,
                                message: 'äº¤æ˜“å®é™…å·²ç¡®è®¤æˆåŠŸ'
                            };
                        }
                        
                        // äº¤æ˜“å­˜åœ¨ä½†æœªç¡®è®¤
                        return { 
                            success: false, 
                            pending: true,
                            status: statusResult.value.confirmationStatus || 'processed',
                            message: 'äº¤æ˜“æ­£åœ¨å¤„ç†ä¸­'
                        };
                    }
                    
                    // åœ¨æ­¤RPCä¸Šæœªæ‰¾åˆ°äº¤æ˜“ï¼Œå°è¯•ä¸‹ä¸€ä¸ª
                    console.log(`âš ï¸ åœ¨RPC ${i+1} ä¸Šæœªæ‰¾åˆ°äº¤æ˜“ï¼Œå°è¯•ä¸‹ä¸€ä¸ª...`);
                    
                } catch (error) {
                    console.warn(`âš ï¸ æœ€ç»ˆæ£€æŸ¥å¤±è´¥ (RPC ${i+1}): ${error.message}`);
                    continue;
                }
            }
            
            // æ‰€æœ‰RPCéƒ½æ£€æŸ¥å¤±è´¥
            return { 
                success: false, 
                error: 'æ— æ³•ç¡®å®šäº¤æ˜“æœ€ç»ˆçŠ¶æ€ï¼Œè¯·æ‰‹åŠ¨æŸ¥çœ‹Explorer',
                explorerUrl: `https://explorer.solana.com/tx/${signature}`
            };
        }

        // Heliuså¢å¼ºAPIï¼šè·å–ä»£å¸ä½™é¢
        async function getHeliusTokenBalances(publicKey) {
            const HELIUS_API = "https://api.helius.xyz/v0";
            const API_KEY = "4666ac55-bdad-41b4-83a8-2b2787bc30b6";
            
            try {
                console.log('ğŸš€ ä½¿ç”¨Heliuså¢å¼ºAPIè·å–ä»£å¸ä½™é¢...');
                
                // ä½¿ç”¨Heliusçš„Token APIè·å–ä»£å¸ä½™é¢
                const response = await fetch(`${HELIUS_API}/addresses/${publicKey.toString()}/balances?api-key=${API_KEY}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Helius APIé”™è¯¯: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('ğŸ“Š Heliusä»£å¸ä½™é¢å“åº”:', data);
                
                // æ ¼å¼åŒ–ä»£å¸ä½™é¢ä¿¡æ¯
                const balances = [];
                if (data.tokens && Array.isArray(data.tokens)) {
                    const targetSymbols = ['USDT', 'USDC', 'RAY', 'SRM'];
                    
                    for (const symbol of targetSymbols) {
                        const token = data.tokens.find(t => t.tokenSymbol === symbol);
                        balances.push({
                            symbol: symbol,
                            balance: token ? token.amount : '0'
                        });
                    }
                }
                
                return balances;
                
            } catch (error) {
                console.error('âŒ Heliusä»£å¸ä½™é¢APIå¤±è´¥:', error.message);
                throw error;
            }
        }

        // Heliuså¢å¼ºAPIï¼šè§£æäº¤æ˜“
        async function parseTransactionWithHelius(signature) {
            const HELIUS_API = "https://api.helius.xyz/v0";
            const API_KEY = "4666ac55-bdad-41b4-83a8-2b2787bc30b6";
            
            try {
                console.log('ğŸ” ä½¿ç”¨Helius APIè§£æäº¤æ˜“:', signature);
                
                const response = await fetch(`${HELIUS_API}/transactions/?api-key=${API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        transactions: [signature]
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Heliusè§£æAPIé”™è¯¯: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('ğŸ“Š Heliusäº¤æ˜“è§£æå“åº”:', data);
                
                return data;
                
            } catch (error) {
                console.error('âŒ Heliusäº¤æ˜“è§£æå¤±è´¥:', error.message);
                throw error;
            }
        }

        // Heliuså¢å¼ºAPIï¼šè·å–äº¤æ˜“å†å²
        async function getTransactionHistoryWithHelius(address, limit = 10) {
            const HELIUS_API = "https://api.helius.xyz/v0";
            const API_KEY = "4666ac55-bdad-41b4-83a8-2b2787bc30b6";
            
            try {
                console.log('ğŸ“œ ä½¿ç”¨Helius APIè·å–äº¤æ˜“å†å²:', address);
                
                const response = await fetch(`${HELIUS_API}/addresses/${address}/transactions/?api-key=${API_KEY}&limit=${limit}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Heliuså†å²APIé”™è¯¯: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('ğŸ“Š Heliusäº¤æ˜“å†å²å“åº”:', data);
                
                return data;
                
            } catch (error) {
                console.error('âŒ Heliusäº¤æ˜“å†å²è·å–å¤±è´¥:', error.message);
                throw error;
            }
        }

        // ğŸ“ æ ‡å‡†åŒ–äº¤æ˜“åˆ›å»ºå‡½æ•° - æŒ‰ç…§Solanaæœ€ä½³å®è·µ
        function createSolanaTransaction(fromAddress, toAddress, amount, connection) {
            console.log('ğŸ—ï¸ åˆ›å»ºæ ‡å‡†åŒ–Solanaäº¤æ˜“...');
            
                         // 1. éªŒè¯å¹¶è½¬æ¢é‡‘é¢å•ä½
             const lamports = Math.floor(parseFloat(amount) * solanaWeb3.LAMPORTS_PER_SOL);
             console.log(`ğŸ’° é‡‘é¢è½¬æ¢: ${amount} SOL = ${lamports} lamports`);
            
            if (lamports <= 0) {
                throw new Error('è½¬è´¦é‡‘é¢å¿…é¡»å¤§äº0');
            }
            
            // 2. ç¡®ä¿åœ°å€æ˜¯PublicKeyç±»å‹
            let fromPubkey, toPubkey;
            
            if (fromAddress instanceof solanaWeb3.PublicKey) {
                fromPubkey = fromAddress;
            } else if (typeof fromAddress === 'string') {
                fromPubkey = new solanaWeb3.PublicKey(fromAddress);
            } else {
                throw new Error('å‘é€æ–¹åœ°å€æ ¼å¼æ— æ•ˆ');
            }
            
            if (toAddress instanceof solanaWeb3.PublicKey) {
                toPubkey = toAddress;
            } else if (typeof toAddress === 'string') {
                toPubkey = new solanaWeb3.PublicKey(toAddress);
            } else {
                throw new Error('æ¥æ”¶æ–¹åœ°å€æ ¼å¼æ— æ•ˆ');
            }
            
            console.log(`ğŸ” åœ°å€éªŒè¯:`);
            console.log(`   - å‘é€æ–¹: ${fromPubkey.toString()} (${fromPubkey.constructor.name})`);
            console.log(`   - æ¥æ”¶æ–¹: ${toPubkey.toString()} (${toPubkey.constructor.name})`);
            
            // 3. åˆ›å»ºäº¤æ˜“
            const transaction = new solanaWeb3.Transaction();
            
            // 4. æ·»åŠ è½¬è´¦æŒ‡ä»¤
            const transferInstruction = solanaWeb3.SystemProgram.transfer({
                fromPubkey: fromPubkey,
                toPubkey: toPubkey,
                lamports: lamports
            });
            
            transaction.add(transferInstruction);
            console.log(`âœ… è½¬è´¦æŒ‡ä»¤å·²æ·»åŠ : ${lamports} lamports`);
            
            return {
                transaction,
                fromPubkey,
                toPubkey,
                lamports
            };
        }

        // Helius WebSocketè¿æ¥ï¼šå®æ—¶äº¤æ˜“ç›‘æ§
        let heliusWebSocket = null;
        
        function connectHeliusWebSocket(address) {
            try {
                // ğŸ”§ ä¿®å¤WebSocket URLæ ¼å¼ - å¯èƒ½éœ€è¦ä¸åŒçš„ç«¯ç‚¹
                const HELIUS_WS_URL = "wss://atlas-mainnet.helius-rpc.com/?api-key=4666ac55-bdad-41b4-83a8-2b2787bc30b6";
                
                console.log('ğŸ”— å°è¯•è¿æ¥Helius WebSocket:', HELIUS_WS_URL);
                console.log('âš ï¸ æ³¨æ„ï¼šWebSocketåŠŸèƒ½æš‚æ—¶ç¦ç”¨ï¼Œç­‰å¾…APIå¯†é’¥æƒé™ç¡®è®¤');
                
                // æš‚æ—¶ç¦ç”¨WebSocketè¿æ¥ï¼Œç›´åˆ°APIå¯†é’¥é—®é¢˜è§£å†³
                console.log('ğŸ”Œ WebSocketè¿æ¥å·²æš‚æ—¶ç¦ç”¨');
                return;
                
                heliusWebSocket = new WebSocket(HELIUS_WS_URL);
                
                heliusWebSocket.onopen = function() {
                    console.log('âœ… Helius WebSocketè¿æ¥æˆåŠŸ');
                    
                    // è®¢é˜…è´¦æˆ·å˜åŒ–é€šçŸ¥
                    const subscribeMessage = {
                        jsonrpc: "2.0",
                        id: 1,
                        method: "accountSubscribe",
                        params: [
                            address,
                            {
                                encoding: "jsonParsed",
                                commitment: "confirmed"
                            }
                        ]
                    };
                    
                    heliusWebSocket.send(JSON.stringify(subscribeMessage));
                    console.log('ğŸ“¡ å·²è®¢é˜…è´¦æˆ·å˜åŒ–é€šçŸ¥:', address);
                };
                
                heliusWebSocket.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        console.log('ğŸ“¨ Helius WebSocketæ¶ˆæ¯:', data);
                        
                        // å¤„ç†è´¦æˆ·å˜åŒ–é€šçŸ¥
                        if (data.method === 'accountNotification') {
                            console.log('ğŸ”” è´¦æˆ·ä½™é¢å˜åŒ–é€šçŸ¥:', data.params);
                            // è‡ªåŠ¨æ›´æ–°ä½™é¢
                            setTimeout(updateBalance, 1000);
                        }
                        
                    } catch (parseError) {
                        console.warn('âš ï¸ WebSocketæ¶ˆæ¯è§£æå¤±è´¥:', parseError.message);
                    }
                };
                
                heliusWebSocket.onerror = function(error) {
                    console.error('âŒ Helius WebSocketé”™è¯¯:', error);
                };
                
                heliusWebSocket.onclose = function() {
                    console.log('ğŸ”Œ Helius WebSocketè¿æ¥å…³é—­');
                    heliusWebSocket = null;
                };
                
            } catch (error) {
                console.error('âŒ Helius WebSocketè¿æ¥å¤±è´¥:', error.message);
            }
        }
        
        function disconnectHeliusWebSocket() {
            if (heliusWebSocket) {
                heliusWebSocket.close();
                heliusWebSocket = null;
                console.log('ğŸ”Œ å·²æ–­å¼€Helius WebSocketè¿æ¥');
            }
        }

        // ğŸŒ‰ åŸç”ŸRPCæ¡¥æ¢ - é€šè¿‡iOSåŸç”Ÿå±‚å‘é€RPCè¯·æ±‚
        let nativeRPCCallbacks = new Map();
        let nativeRPCCallId = 0;
        
        // å¤„ç†åŸç”ŸRPCå“åº”
        window.handleNativeRPCResponse = function(response) {
            console.log('ğŸ“± æ”¶åˆ°åŸç”ŸRPCå“åº”:', response);
            
            const callback = nativeRPCCallbacks.get(response.id);
            if (callback) {
                nativeRPCCallbacks.delete(response.id);
                callback(response);
            }
        };
        
        // é€šè¿‡åŸç”Ÿå±‚å‘é€RPCè¯·æ±‚
        async function sendNativeRPCRequest(method, params) {
            return new Promise((resolve, reject) => {
                const callId = ++nativeRPCCallId;
                
                // ä¿å­˜å›è°ƒ
                nativeRPCCallbacks.set(callId, (response) => {
                    if (response.error) {
                        reject(new Error(response.error.message || JSON.stringify(response.error)));
                    } else {
                        resolve(response.result);
                    }
                });
                
                // å‘é€è¯·æ±‚åˆ°åŸç”Ÿå±‚
                const request = {
                    id: callId,
                    method: method,
                    params: params
                };
                
                console.log('ğŸ“± å‘é€åŸç”ŸRPCè¯·æ±‚:', request);
                
                if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.solanaRPC) {
                    window.webkit.messageHandlers.solanaRPC.postMessage(request);
                } else {
                    reject(new Error('åŸç”ŸRPCæ¡¥æ¢ä¸å¯ç”¨'));
                }
                
                // è®¾ç½®è¶…æ—¶
                setTimeout(() => {
                    if (nativeRPCCallbacks.has(callId)) {
                        nativeRPCCallbacks.delete(callId);
                        reject(new Error('RPCè¯·æ±‚è¶…æ—¶'));
                    }
                }, 30000); // 30ç§’è¶…æ—¶
            });
        }
        
        // åˆ›å»ºåŸºäºåŸç”Ÿæ¡¥æ¢çš„Connectionç±»
        class NativeConnection {
            constructor() {
                this.commitment = 'confirmed';
            }
            
            async getLatestBlockhash(commitment = 'confirmed') {
                console.log('ğŸ”— é€šè¿‡åŸç”Ÿå±‚è·å–æœ€æ–°blockhash');
                const result = await sendNativeRPCRequest('getLatestBlockhash', [{ commitment }]);
                return {
                    blockhash: result.value.blockhash,
                    lastValidBlockHeight: result.value.lastValidBlockHeight
                };
            }
            
            async sendRawTransaction(serializedTransaction, options = {}) {
                console.log('ğŸ“¤ é€šè¿‡åŸç”Ÿå±‚å‘é€äº¤æ˜“');
                
                // å°†äº¤æ˜“è½¬æ¢ä¸ºbase64
                const base64Transaction = btoa(String.fromCharCode.apply(null, serializedTransaction));
                
                const params = [
                    base64Transaction,
                    {
                        encoding: "base64",
                        preflightCommitment: options.preflightCommitment || "confirmed",
                        skipPreflight: options.skipPreflight || false,
                        maxRetries: options.maxRetries || 3
                    }
                ];
                
                const result = await sendNativeRPCRequest('sendTransaction', params);
                return result;
            }
            
            async getSignatureStatus(signature) {
                console.log('ğŸ” é€šè¿‡åŸç”Ÿå±‚æ£€æŸ¥äº¤æ˜“çŠ¶æ€');
                const result = await sendNativeRPCRequest('getSignatureStatuses', [[signature]]);
                return {
                    value: result.value && result.value[0] ? result.value[0] : null
                };
            }
            
            async getBalance(publicKey) {
                console.log('ğŸ’° é€šè¿‡åŸç”Ÿå±‚è·å–ä½™é¢');
                const result = await sendNativeRPCRequest('getBalance', [publicKey.toString()]);
                return result.value;
            }
            
            async getTokenAccountsByOwner(owner, filter) {
                console.log('ğŸª™ é€šè¿‡åŸç”Ÿå±‚è·å–ä»£å¸è´¦æˆ·');
                const result = await sendNativeRPCRequest('getTokenAccountsByOwner', [
                    owner.toString(), 
                    filter,
                    { encoding: "jsonParsed" }
                ]);
                return result;
            }
            
            async getTokenAccountBalance(tokenAccount) {
                console.log('ğŸ’° é€šè¿‡åŸç”Ÿå±‚è·å–ä»£å¸ä½™é¢');
                const result = await sendNativeRPCRequest('getTokenAccountBalance', [tokenAccount.toString()]);
                return result;
            }
        }

        // Heliusä¸“ç”¨å‘é€æ–¹æ³•ï¼ˆä½¿ç”¨æ ‡å‡†RPC + å¢å¼ºAPIåŠŸèƒ½ï¼‰
        async function sendTransactionViaHelius(transaction, rpcUrl) {
            console.log('ğŸŒŸ ä½¿ç”¨Helius RPCå‘é€äº¤æ˜“:', rpcUrl);
            
            // æ–¹æ³•1: ä½¿ç”¨æ ‡å‡†Web3.jsè¿æ¥æ–¹å¼ï¼ˆæ¨èï¼‰
            try {
                const connection = new solanaWeb3.Connection(rpcUrl, 'confirmed');
                
                const signature = await connection.sendRawTransaction(
                    transaction.serialize(),
                    {
                        skipPreflight: false,
                        preflightCommitment: 'confirmed',
                        maxRetries: 3
                    }
                );
                
                console.log('ğŸ“Š Helius RPCå“åº”æˆåŠŸï¼Œäº¤æ˜“ç­¾å:', signature);
                return signature;
                
            } catch (rpcError) {
                console.warn('âš ï¸ Helius RPCæ ‡å‡†æ–¹æ³•å¤±è´¥ï¼Œå°è¯•fetchæ–¹æ³•:', rpcError.message);
                
                // æ–¹æ³•2: å¤‡ç”¨fetchæ–¹æ³•
                const serializedTx = transaction.serialize();
                const base64Tx = serializedTx.toString('base64');
                
                const requestBody = {
                    jsonrpc: "2.0",
                    id: 1,
                    method: "sendTransaction",
                    params: [
                        base64Tx,
                        {
                            encoding: "base64",
                            preflightCommitment: "confirmed"
                        }
                    ]
                };
                
                const response = await fetch(rpcUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    throw new Error(`Helius HTTPé”™è¯¯: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('ğŸ“Š Helius fetchå“åº”:', data);
                
                if (data.error) {
                    throw new Error(`Helius RPCé”™è¯¯: ${data.error.message || JSON.stringify(data.error)}`);
                }
                
                if (!data.result) {
                    throw new Error('Heliuså“åº”ä¸­æ²¡æœ‰äº¤æ˜“ç­¾åç»“æœ');
                }
                
                return data.result;
            }
        }

        // å¤‡ç”¨å‘é€æ–¹æ³•ï¼šä½¿ç”¨åŸç”Ÿ fetch API
        async function sendTransactionViaFetch(transaction, rpcUrl) {
            console.log('ğŸ”„ ä½¿ç”¨å¤‡ç”¨æ–¹æ³•å‘é€äº¤æ˜“:', rpcUrl);
            
            // åºåˆ—åŒ–äº¤æ˜“å¹¶è½¬æ¢ä¸º Base64
            const serializedTx = transaction.serialize();
            const base64Tx = btoa(String.fromCharCode.apply(null, serializedTx));
            
            const requestBody = {
                jsonrpc: "2.0",
                id: 1,
                method: "sendTransaction",
                params: [
                    base64Tx,
                    {
                        skipPreflight: false,
                        preflightCommitment: 'confirmed'
                    }
                ]
            };
            
            console.log('ğŸ“¡ å¤‡ç”¨æ–¹æ³•è¯·æ±‚å‚æ•°:', {
                url: rpcUrl,
                method: 'POST',
                bodyLength: JSON.stringify(requestBody).length
            });
            
            const response = await fetch(rpcUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestBody)
            });
            
            if (!response.ok) {
                throw new Error(`HTTPé”™è¯¯: ${response.status} ${response.statusText}`);
            }
            
            const data = await response.json();
            
            if (data.error) {
                throw new Error(`RPCé”™è¯¯: ${data.error.message || JSON.stringify(data.error)}`);
            }
            
            if (!data.result) {
                throw new Error('RPCå“åº”ä¸­æ²¡æœ‰ç»“æœ');
            }
            
            return data.result;
        }

        // é‡è¯•äº¤æ˜“å‡½æ•° - ä½¿ç”¨æ›´é«˜ä¼˜å…ˆçº§è´¹ç”¨
        window.retryTransactionWithHigherFee = function(priorityFee, fromAddress, toAddress, amount, tokenSymbol) {
            console.log(`ğŸ”„ æ”¶åˆ°é‡è¯•è¯·æ±‚: ä¼˜å…ˆçº§è´¹ç”¨ ${priorityFee} lamports`);
            
            // æ›´æ–°é…ç½®ä¸­çš„ä¼˜å…ˆçº§è´¹ç”¨
            config.priorityFee = priorityFee;
            
            // è®¡ç®— SOL ç­‰å€¼æ˜¾ç¤º
            const solEquivalent = (priorityFee / 1e9).toFixed(8);
            
            // æ˜¾ç¤ºé‡è¯•çŠ¶æ€
            showStatus(`æ­£åœ¨ä½¿ç”¨æ›´é«˜ä¼˜å…ˆçº§è´¹ç”¨é‡è¯•... (${priorityFee} lamports â‰ˆ ${solEquivalent} SOL)`, 'warning');
            
            // é‡æ–°å¡«å……è¡¨å•
            document.getElementById('toAddress').value = toAddress;
            document.getElementById('amount').value = amount;
            
            // æ˜¾ç¤ºç”¨æˆ·å‹å¥½çš„æç¤º
            console.log(`ğŸ’° é‡è¯•äº¤æ˜“è¯¦æƒ…:`);
            console.log(`   - å‘é€æ–¹: ${fromAddress}`);
            console.log(`   - æ¥æ”¶æ–¹: ${toAddress}`);
            console.log(`   - é‡‘é¢: ${amount} ${tokenSymbol}`);
            console.log(`   - ä¼˜å…ˆçº§è´¹ç”¨: ${priorityFee} lamports (${solEquivalent} SOL)`);
            
            // æ¨¡æ‹Ÿç‚¹å‡»å‘é€æŒ‰é’®é‡è¯•
            setTimeout(() => {
                executeTransaction();
            }, 1000);
        };

        // ç½‘ç»œçŠ¶æ€æ£€æŸ¥å‡½æ•°
        function checkNetworkCongestion() {
            // ç®€å•çš„ç½‘ç»œæ‹¥å µæ£€æµ‹
            const now = Date.now();
            const lastRequestTime = window.lastRpcRequestTime || 0;
            const timeSinceLastRequest = now - lastRequestTime;
            
            window.lastRpcRequestTime = now;
            
            // å¦‚æœè¯·æ±‚é—´éš”è¿‡çŸ­ï¼Œå¯èƒ½è¡¨ç¤ºç½‘ç»œæ‹¥å µ
            if (timeSinceLastRequest < 5000) {
                console.warn('âš ï¸ ç½‘ç»œå¯èƒ½æ‹¥å µï¼Œå»ºè®®å¢åŠ ä¼˜å…ˆçº§è´¹ç”¨');
                return true;
            }
            
            return false;
        }

        // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
        function debugWalletDetection() {
            const debugInfo = document.getElementById('debugInfo');
            const isVisible = debugInfo.style.display !== 'none';
            
            if (isVisible) {
                debugInfo.style.display = 'none';
                document.getElementById('debugBtn').textContent = 'æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯';
                return;
            }
            
            let info = `è°ƒè¯•ä¿¡æ¯ (${new Date().toLocaleTimeString()}):\n\n`;
            
            info += `ç”¨æˆ·ä»£ç†: ${navigator.userAgent}\n\n`;
            
            info += `window.solana å­˜åœ¨: ${window.solana ? 'âœ… æ˜¯' : 'âŒ å¦'}\n`;
            if (window.solana) {
                info += `  - isPhantom: ${window.solana.isPhantom}\n`;
                info += `  - isConnected: ${window.solana.isConnected}\n`;
                info += `  - publicKey: ${window.solana.publicKey ? window.solana.publicKey.toString() : 'null'}\n`;
            }
            
            info += `\nå…¶ä»–é’±åŒ…æ£€æµ‹:\n`;
            info += `window.ethereum: ${window.ethereum ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}\n`;
            info += `window.phantom: ${window.phantom ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}\n`;
            
            info += `\né¡µé¢ç¯å¢ƒ:\n`;
            info += `åè®®: ${location.protocol}\n`;
            info += `åŸŸå: ${location.hostname}\n`;
            info += `ç«¯å£: ${location.port || 'é»˜è®¤'}\n`;
            info += `å®Œæ•´URL: ${location.href}\n`;
            
            info += `\nSolana Web3.js:\n`;
            info += `solanaWeb3 å¯¹è±¡: ${typeof solanaWeb3 !== 'undefined' ? 'âœ… å·²åŠ è½½' : 'âŒ æœªåŠ è½½'}\n`;
            if (typeof solanaWeb3 !== 'undefined') {
                info += `Connection ç±»: ${solanaWeb3.Connection ? 'âœ… å¯ç”¨' : 'âŒ ä¸å¯ç”¨'}\n`;
                info += `PublicKey ç±»: ${solanaWeb3.PublicKey ? 'âœ… å¯ç”¨' : 'âŒ ä¸å¯ç”¨'}\n`;
            }
            
            info += `\niOS WebView æ¡¥æ¥:\n`;
            info += `webkit å¯¹è±¡: ${window.webkit ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}\n`;
            if (window.webkit && window.webkit.messageHandlers) {
                info += `messageHandlers: âœ… å­˜åœ¨\n`;
                info += `phantomCallback: ${window.webkit.messageHandlers.phantomCallback ? 'âœ… å·²æ³¨å†Œ' : 'âŒ æœªæ³¨å†Œ'}\n`;
            }
            
            debugInfo.textContent = info;
            debugInfo.style.display = 'block';
            document.getElementById('debugBtn').textContent = 'éšè—è°ƒè¯•ä¿¡æ¯';
        }

        // ä»iOSæ¥æ”¶é…ç½®å¹¶æ›´æ–°é¡µé¢
        window.setTransactionConfig = function(jsonString) {
            try {
                const data = JSON.parse(jsonString);
                console.log('ğŸ“± æ”¶åˆ°iOSé…ç½®å‚æ•°:', data);
                
                // åˆå¹¶é…ç½®
                config = { ...config, ...data };
                
                // æ›´æ–°é¡µé¢æ ‡é¢˜
                document.getElementById('pageTitle').textContent = 
                    `${config.tokenName || config.tokenSymbol || 'Solana'} è½¬è´¦`;
                
                // æ›´æ–°UIè¡¨å•
                document.getElementById('tokenName').textContent = config.tokenName || config.tokenSymbol || 'Solana';
                document.getElementById('network').textContent = config.network || 'Solana';
                document.getElementById('fromAddress').value = config.fromAddress || '';
                
                // æ›´æ–°æœ€å¤§å¯æå¸æ•°é‡æ˜¾ç¤º
                document.getElementById('maxAmountInfo').textContent = 
                    `æœ€å¤§å¯æå¸æ•°é‡ï¼š${config.maxAmount || 0} ${config.tokenSymbol || 'SOL'}`;
                
                // æ›´æ–°é‡‘é¢è¾“å…¥æ¡†çš„æœ€å¤§å€¼
                const amountInput = document.getElementById('amount');
                if (config.maxAmount > 0) {
                    amountInput.max = config.maxAmount;
                    amountInput.placeholder = `è¯·è¾“å…¥é‡‘é¢ (æœ€å¤§: ${config.maxAmount})`;
                } else {
                    amountInput.placeholder = `è¯·è¾“å…¥é‡‘é¢`;
                }
                
                showStatus('é…ç½®åŠ è½½å®Œæˆï¼Œè¯·è¿æ¥é’±åŒ…', 'success');
                
                console.log('âœ… [Config] äº¤æ˜“é…ç½®æ›´æ–°å®Œæˆ:', config);
                
            } catch (error) {
                console.error('âŒ [Config] é…ç½®è§£æå¤±è´¥:', error);
                showStatus('é…ç½®åŠ è½½å¤±è´¥: ' + error.message, 'error');
            }
        };

        // äº‹ä»¶ç›‘å¬å™¨
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸ“± é¡µé¢åŠ è½½å®Œæˆ');
            
            // ç»‘å®šäº‹ä»¶
            document.getElementById('connectBtn').addEventListener('click', connectPhantom);
            document.getElementById('submitBtn').addEventListener('click', executeTransaction);
            document.getElementById('debugBtn').addEventListener('click', debugWalletDetection);
            
            // æ£€æµ‹é’±åŒ…
            showStatus('æ­£åœ¨æ£€æµ‹é’±åŒ…ç¯å¢ƒ...', 'info');
            
            const detected = await detectPhantom();
            if (detected) {
                showStatus('é’±åŒ…ç¯å¢ƒæ£€æµ‹æˆåŠŸï¼Œè¯·ç‚¹å‡»è¿æ¥', 'success');
            } else {
                showStatus('æœªæ£€æµ‹åˆ°é’±åŒ…ï¼Œè¯·ç¡®ä¿å·²å®‰è£… Phantom', 'error');
            }
        });

        // å…¼å®¹æ€§åˆ«å
        window.setConfig = window.setTransactionConfig;
  </script>
</body>
</html>
